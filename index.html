<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SirusPTB</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
main { flex: 1; }
footer { background: #222; color: white; text-align: center; padding: 10px; }

body { margin: 0; font-family: Arial, sans-serif; background: #121212; color: #e0e0e0; text-align: center; }
header { padding: 10px; font-size: 1.4em; font-weight: bold; }

.canvas-container { width: 98%; margin: 10px auto; height: 300px; }
canvas { width: 100% !important; height: 100% !important; background: #1e1e1e; border-radius: 8px; }

.button-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 10px 0 30px; }
button { padding: 10px 18px; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; color: white; background-color: #333; }

#loadButton, #saveButton { background-color: #444; }
#connectButton.connecting { background-color: orange; }
#connectButton.connected { background-color: green; }
#connectButton.disconnected { background-color: red; }
#pauseResumeButton.resume { background-color: #CC6600; }

.toggle-container { display: inline-flex; align-items: center; gap: 8px; }
.toggle-switch { position: relative; width: 60px; height: 30px; background-color: #555; border-radius: 15px; cursor: pointer; transition: background-color 0.3s; }
.toggle-switch.disabled { opacity: 0.4; cursor: not-allowed; }

#tempToggle, #tempToggle.active { background-color: #8B3A3A; }
#pressureToggle, #pressureToggle.active { background-color: #4682B4; }
#pressureToggle .toggle-slider { background-color: white; color: black; }
#alwaysOnToggle { background-color: #666; }
#alwaysOnToggle.active { background-color: #4CAF50; }
#rawDataToggle { background-color: #666; }
#rawDataToggle.active { background-color: #8A2BE2; }

.toggle-slider { position: absolute; top: 3px; left: 3px; width: 24px; height: 24px; background-color: white; border-radius: 50%; transition: transform 0.3s; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #333; }
.toggle-switch.active .toggle-slider { transform: translateX(30px); }

.modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
.modal-content { background: #1e1e1e; padding: 20px; border-radius: 10px; width: 98%; max-width: 400px; text-align: center; }
.modal select { width: 80%; padding: 8px; margin: 10px 0; border-radius: 6px; background: #333; color: #fff; border: none; }
.modal button { margin: 5px; }

#brightnessSlider { -webkit-appearance: none; appearance: none; height: 8px; background: linear-gradient(to right, #333, #666, #999, #ccc); border-radius: 4px; outline: none; }
#brightnessSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
#brightnessSlider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

#brightnessContainer.disabled, #setControlContainer.disabled { opacity: 0.4; pointer-events: none; }

#setControlContainer { width: 80%; margin: 20px auto; }
#setControlInput { background: #333; color: #e0e0e0; border: 2px solid #555; border-radius: 6px; padding: 8px 12px; font-size: 1em; width: 120px; text-align: center; margin-right: 10px; }
#setControlInput:focus { outline: none; border-color: #4CAF50; }
#setControlInput:disabled { background: #222; color: #666; border-color: #333; cursor: not-allowed; }
#setControlButton { background-color: #4CAF50; padding: 8px 16px; margin-left: 10px; }
#setControlButton:hover:not(:disabled) { background-color: #45a049; }
#setControlButton:disabled { background-color: #333; cursor: not-allowed; opacity: 0.6; }

#rawDataDisplay { background: #1e1e1e; color: #00ff00; padding: 10px; margin: 10px auto; width: 98%; border-radius: 8px; font-family: monospace; text-align: left; height: 120px; overflow-y: auto; transition: all 0.3s ease; display: flex; flex-direction: column; }
#rawDataDisplay.hidden { display: none; }

.data-entry { margin: 2px 0; padding: 2px 5px; border-radius: 3px; font-size: 0.9em; line-height: 1.3; }
.data-entry.sent { color: #ffaa00; }
.data-entry.received { color: #00ff00; }
.data-entry.error { color: #ff0000; }
.data-timestamp { color: #888; font-size: 0.8em; margin-right: 8px; }

#clearDataButton { position: absolute; top: 5px; right: 5px; background: transparent; border: none; color: #888; font-size: 0.8em; cursor: pointer; padding: 2px 5px; }

#rawDataDisplay::-webkit-scrollbar { width: 8px; }
#rawDataDisplay::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 4px; }
#rawDataDisplay::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
#rawDataDisplay::-webkit-scrollbar-thumb:hover { background: #555; }

footer a { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #2a2a2a; border-radius: 50%; text-decoration: none; transition: all 0.3s ease; }
footer a:hover { background: #3a3a3a; transform: scale(1.1); }
footer .bean-icon { width: 18px; height: 18px; fill: #8B4513; transition: fill 0.3s ease; }
footer a:hover .bean-icon { fill: #A0522D; }

#rawDataContainer { display: flex; align-items: center; margin: 12px 0; padding: 6px 10px; background: #1e1e1e; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
#rawDataContainer span { margin-right: 10px; font-weight: 500; color: #eee; }

#helpIcon { position: fixed; top: 15px; right: 15px; width: 36px; height: 36px; background: #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; cursor: pointer; z-index: 1000; transition: background 0.3s ease; }
#helpIcon:hover { background: #666; }

#helpPopup { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
#helpPopup .popup-content { background: #1e1e1e; color: #fff; padding: 20px; border-radius: 10px; max-width: 400px; text-align: center; }
#helpPopup button { margin-top: 15px; padding: 8px 16px; border: none; border-radius: 6px; background: #4CAF50; color: white; cursor: pointer; }
#helpPopup button:hover { background: #45a049; }
</style>
</head>
<body>

<div id="helpIcon">?</div>

<div id="helpPopup">
  <div class="popup-content">
    <h3>Device Button Usage</h3>
    <p>Device button uses - </p>
    <ul style='text-align:left; line-height:1.6;'>
      <li>Three quick presses of the <b>P</b> button = Turn device off</li>
      <li>Two quick presses of the <b>P</b> button = Brightness setting</li>
      <li>Long press <b>P</b> button = Zero pressure</li>
      <li>Two quick presses of the <b>T</b> button = Toggle keep screen on</li>
      <li>Long press <b>T</b> button = Calibrate pressure</li>
    </ul>
    <button id="closeHelp">Close</button>
  </div>
</div>

<main>
<header>SirusPTB</header>

<div id="graphPage">
  <div class="button-row">
    <button id="connectButton" class="disconnected">Connect</button>
  </div>
  
  <div class="button-row">
    <div class="toggle-container">
      <span>°C/°F:</span>
      <div id="tempToggle" class="toggle-switch">
        <div class="toggle-slider">C</div>
      </div>
    </div>
    <div class="toggle-container">
      <span>Bar/PSI:</span>
      <div id="pressureToggle" class="toggle-switch">
        <div class="toggle-slider">Bar</div>
      </div>
      <svg id="batteryIcon" viewBox="0 0 40 20" width="60" height="30" style="margin-left:12px;">
        <rect x="1" y="4" width="32" height="12" stroke="#ccc" fill="none" stroke-width="2" rx="2" ry="2"/>
        <rect id="batteryLevel" x="3" y="6" width="0" height="8" fill="#4CAF50"/>
        <g transform="translate(18,11) scale(2.2) translate(-18,-11)">
          <path id="boltIcon" d="M18 6 L14 12 H18 L16 16 L22 10 H18 Z" fill="#ffffff" style="display:none"/>
        </g>
        <rect x="34" y="8" width="4" height="4" fill="#ccc"/>
      </svg>
    </div>
  </div>

  <div id="splitView" style="display:flex; flex-direction:column; width:100%; align-items:center;">
    <div style="width: 98%; margin: 0 auto;">
      <div id="tempCurrentValue" style="background: #121212; color: #ff7f7f; padding: 8px; margin: 5px 0; border-radius: 6px; font-weight: bold; font-size: 1.1em; text-align: center;">Temperature: -- °C</div>
      <div class="canvas-container"><canvas id="tempChart"></canvas></div>
    </div>
    <div style="width: 98%; margin: 0 auto;">
      <div id="pressureCurrentValue" style="background: #121212; color: #7fbfff; padding: 8px; margin: 5px 0; border-radius: 6px; font-weight: bold; font-size: 1.1em; text-align: center;">Pressure: -- bar</div>
      <div class="canvas-container"><canvas id="pressureChart"></canvas></div>
    </div>
  </div>

  <div id="combinedView" style="display:none; width:100%; align-items:center;">
    <div style="width: 98%; margin: 0 auto;">
      <div id="combinedCurrentValue" style="background: #121212; color: #e0e0e0; padding: 8px; margin: 5px 0; border-radius: 6px; font-weight: bold; font-size: 1.1em; text-align: center;">
        <span style="color: #ff7f7f;">Temperature: -- °C</span> | <span style="color: #7fbfff;">Pressure: -- bar</span>
      </div>
      <div class="canvas-container"><canvas id="combinedChart"></canvas></div>
    </div>
  </div>

  <div id="gaugeView" style="display:none; width:100%; align-items:center;">
    <div style="width: 98%; margin: 0 auto; display: flex; flex-direction: column; gap: 20px;">
      <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
        <div style="display: flex; flex-direction: column; align-items: center;">
          <div style="position: relative; width: 280px; height: 280px;">
            <canvas id="tempGauge" width="280" height="280" style="border-radius: 50%; background: #121212;"></canvas>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
          <div style="position: relative; width: 280px; height: 280px;">
            <canvas id="pressureGauge" width="280" height="280" style="border-radius: 50%; background: #121212;"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="chartControlButtons" class="button-row">
    <button id="pauseResumeButton">Pause</button>
    <button id="toggleViewButton">Toggle View</button>
    <button id="toggleGaugeButton">Toggle Gauges</button>
    <button id="resetButton">Reset</button>
  </div>

  <div id="saveLoadDeleteButtons" class="button-row">
    <button id="saveButton">Save</button>
    <button id="loadButton">Load</button>
    <button id="deleteButton">Delete</button>
  </div>

  <div style="width: 80%; margin: 10px auto;">
    <div style="padding: 15px; background: #121212; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
      <div class="toggle-container">
        <span style="color: #e0e0e0; font-weight: bold;">Keep device screen on:</span>
        <div id="alwaysOnToggle" class="toggle-switch" style="background-color: #666;">
          <div class="toggle-slider">OFF</div>
        </div>
      </div>
    </div>
  </div>

  <div style="width: 98%; margin: 20px auto;">
    <div id="brightnessContainer" style="padding: 15px; background: #1e1e1e; border-radius: 8px;">
      <div style="display: flex; align-items: center; gap: 15px;">
        <span style="color: #e0e0e0; font-weight: bold; min-width: 100px; font-size: 0.9em;">Device brightness:</span>
        <input type="range" id="brightnessSlider" min="10" max="250" value="125" 
               style="flex: 1; height: 6px; background: #333; border-radius: 3px; outline: none; -webkit-appearance: none;">
        <span id="brightnessValue" style="color: #e0e0e0; font-weight: bold; min-width: 40px; text-align: right; font-size: 0.9em;">125</span>
      </div>
    </div>
  </div>

  <div style="width: 98%; margin: 20px auto;">
    <details style="background:#1e1e1e; border-radius:8px; padding:10px;">
      <summary style="color:#e0e0e0; font-weight:bold; cursor:pointer;">Advanced</summary>
      <div style="width: 98%; margin: 20px auto;">
        <div id="setControlContainer" style="padding: 15px; background: #1e1e1e; border-radius: 8px;">
          <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <span style="color: #e0e0e0; font-weight: bold; font-size: 0.9em;">Pressure calibration:</span>
            <input type="text" id="setControlInput" placeholder="0.00" maxlength="4" pattern="[0-9]*\.?[0-9]*">
            <button id="setControlButton">Set</button>
          </div>
          <div style="display: flex; align-items: center; justify-content: center; margin-top: 10px;">
            <span style="color: #e0e0e0; font-weight: bold; margin-right: 10px;">Zero offset:</span>
            <button id="zeroPressureButton" title="Zero pressure to compensate for atmospheric pressure">Zero pressure</button>
          </div>

          <div id="rawDataContainer">
            <span>Raw Data:</span>
            <div id="rawDataToggle" class="toggle-switch">
              <div class="toggle-slider">OFF</div>
            </div>
          </div>
        </div>

        <div id="rawDataDisplay" class="raw-data-container hidden" style="overflow-y:auto;">
          <button id="clearDataButton" title="Clear data">×</button>
          <div class="data-entry">No data yet...</div>
        </div>
      </div>
    </details>
  </div>
</div>

<div id="popupModal" class="modal">
  <div class="modal-content">
    <h3>Select Saved Graph</h3>
    <select id="modalSelect"></select>
    <div>
      <button id="confirmButton">Confirm</button>
      <button id="cancelButton">Cancel</button>
    </div>
  </div>
</div>

<script>
// BLE Variables
const serviceUuid = "0000ffe1-0000-1000-8000-00805f9b34fb";
const characteristicUuid = "0000ffe3-0000-1000-8000-00805f9b34fb";
const writeCharacteristicUuid = "0000ffe2-0000-1000-8000-00805f9b34fb";
let device, characteristic, writeCharacteristic;
let tempChart, pressureChart, combinedChart;
let paused = false, currentTemp = 0, currentPressure = 0, splitView = true, gaugeView = false;
let secondsCounter = 0, chartData = { labels: [], temp: [], pressure: [] }, modalAction = "", maxPointsValue = 50;
let currentTempUnit = "C", currentPressureUnit = "Bar";
let tempToggleActive = false, pressureToggleActive = false, alwaysOnToggleActive = false, rawDataToggleActive = false;
let isConnected = false, brightnessDataReceived = false, alwaysOnDataReceived = false, setControlDataReceived = false;
let receivedDataCount = 0, dataEntries = [], ignoreTempUntil = 0, ignorePressureUntil = 0;

// Modal Functions
const modal = document.getElementById("popupModal");
const modalSelect = document.getElementById("modalSelect");

function showModal(action) {
  modalAction = action;
  modalSelect.innerHTML = "";
  const saved = Object.keys(localStorage).filter(k => k.startsWith("graph_"));
  if (saved.length === 0) { alert("No saved graphs"); return; }
  saved.forEach(k => {
    const opt = document.createElement("option");
    opt.value = k; opt.text = k.replace("graph_", "");
    modalSelect.add(opt);
  });
  modal.style.display = "flex";
}

document.getElementById("confirmButton").onclick = () => {
  const key = modalSelect.value;
  if (!key) { modal.style.display = "none"; return; }
  if (modalAction === "load") {
    const data = JSON.parse(localStorage.getItem(key));
    if (data) {
      chartData = data; secondsCounter = data.labels.length;
      [tempChart, pressureChart, combinedChart].forEach((chart, i) => {
        chart.data.labels = chartData.labels;
        chart.data.datasets[0].data = i === 2 ? chartData.temp : (i === 0 ? chartData.temp : chartData.pressure);
        if (i === 2) chart.data.datasets[1].data = chartData.pressure;
        chart.update();
      });
      updateGauges();
    }
  } else if (modalAction === "delete") {
    localStorage.removeItem(key);
  }
  modal.style.display = "none";
};

document.getElementById("cancelButton").onclick = () => { modal.style.display = "none"; };

// Chart Setup
function fixCanvasDPI(canvas) {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  canvas.getContext('2d').setTransform(dpr, 0, 0, dpr, 0, 0);
}

function initCharts() {
  const configs = [
    { id: "tempChart", label: "Temp", color: "#ff7f7f", yTitle: "Temperature (°C)", min: 0, max: 120 },
    { id: "pressureChart", label: "Pressure", color: "#7fbfff", yTitle: "Pressure (bar)" },
  ];

  [tempChart, pressureChart] = configs.map(config => {
    const ctx = document.getElementById(config.id).getContext("2d");
    fixCanvasDPI(ctx.canvas);
    return new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label: config.label, borderColor: config.color, data: [], fill: false }] },
      options: {
        responsive: true, maintainAspectRatio: true, animation: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: true, title: { display: true, text: 'Time(sec)' }, ticks: { color: '#e0e0e0' } },
          y: { display: true, title: { display: true, text: config.yTitle }, ticks: { color: config.color, ...(config.min !== undefined && { stepSize: 5, callback: v => Math.round(v) }), ...(config.min !== undefined && { min: config.min, max: config.max }) } }
        }
      }
    });
  });

  const ctxCombined = document.getElementById("combinedChart").getContext("2d");
  fixCanvasDPI(ctxCombined.canvas);
  combinedChart = new Chart(ctxCombined, {
    type: "line",
    data: {
      labels: [], datasets: [
        { label: "Temp", borderColor: "#ff7f7f", data: [], fill: false, yAxisID: "y1" },
        { label: "Pressure", borderColor: "#7fbfff", data: [], fill: false, yAxisID: "y2" }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: true, animation: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { display: true, title: { display: true, text: 'Time(sec)' }, ticks: { color: '#e0e0e0' } },
        y1: { display: true, title: { display: false }, ticks: { color: "#ff7f7f", stepSize: 5, callback: v => Math.round(v) }, min: 0, max: 120 },
        y2: { display: true, title: { display: false }, ticks: { color: "#7fbfff" } }
      }
    }
  });
}

initCharts();

// Gauge Drawing
function drawGauge(canvas, value, min, max, unit, color) {
  const ctx = canvas.getContext('2d');
  const centerX = canvas.width / 2, centerY = canvas.height / 2, radius = 100;

  ctx.fillStyle = '#121212';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Outer ring
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius + 15, 0, 2 * Math.PI);
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 4;
  ctx.stroke();

  const startAngle = 0.75 * Math.PI, endAngle = 2.25 * Math.PI;

  // Background arc
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, startAngle, endAngle);
  ctx.strokeStyle = '#2a2a2a';
  ctx.lineWidth = 20;
  ctx.stroke();

  // Value arc
  if (isConnected && value !== null) {
    const normalizedValue = Math.max(0, Math.min(1, (value - min) / (max - min)));
    const valueAngle = startAngle + normalizedValue * (endAngle - startAngle);
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, startAngle, valueAngle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 20;
    ctx.stroke();
  }

  // Tick marks and labels
  ctx.strokeStyle = '#666';
  ctx.lineWidth = 2;
  ctx.fillStyle = '#999';
  ctx.font = '12px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  for (let i = 0; i <= 10; i++) {
    const tickAngle = startAngle + (i / 10) * (endAngle - startAngle);
    const innerRadius = radius - 20, outerRadius = radius + 10, labelRadius = radius + 30;

    ctx.beginPath();
    ctx.moveTo(centerX + Math.cos(tickAngle) * innerRadius, centerY + Math.sin(tickAngle) * innerRadius);
    ctx.lineTo(centerX + Math.cos(tickAngle) * outerRadius, centerY + Math.sin(tickAngle) * outerRadius);
    ctx.stroke();

    const tickValue = min + (i / 10) * (max - min);
    ctx.fillText(Math.round(tickValue).toString(), centerX + Math.cos(tickAngle) * labelRadius, centerY + Math.sin(tickAngle) * labelRadius);
  }

  // Center value
  ctx.fillStyle = color;
  ctx.font = 'bold 28px Arial';
  ctx.fillText(!isConnected || value === null ? "--.-" : value.toFixed(1), centerX, centerY - 15);

  ctx.fillStyle = '#ccc';
  ctx.font = '18px Arial';
  ctx.fillText(unit, centerX, centerY + 15);
}

function updateGauges() {
  if (!gaugeView) return;

  const tempUnit = currentTempUnit === "F" ? "°F" : "°C";
  const pressureUnit = currentPressureUnit === "PSI" ? "PSI" : "bar";

  const displayTemp = isConnected ? currentTemp : null;
  const displayPressure = isConnected ? currentPressure : null;

  const tempMin = 0, tempMax = currentTempUnit === "F" ? 302 : 150;
  const pressureMin = 0, pressureMax = currentPressureUnit === "PSI" ? 262 : 18;

  const tempCanvas = document.getElementById('tempGauge');
  const pressureCanvas = document.getElementById('pressureGauge');

  if (tempCanvas && pressureCanvas) {
    drawGauge(tempCanvas, displayTemp, tempMin, tempMax, tempUnit, '#ff7f7f');
    drawGauge(pressureCanvas, displayPressure, pressureMin, pressureMax, pressureUnit, '#7fbfff');
  }
}

// Toggle Switch Updates
function updateToggleSwitch(id, unit, isActive, labels) {
  const toggle = document.getElementById(id);
  const slider = toggle.querySelector(".toggle-slider");

  if (isActive) {
    toggle.classList.add("active");
    slider.textContent = labels[1];
  } else {
    toggle.classList.remove("active");
    slider.textContent = labels[0];
  }
}

function updateTempToggleSwitch(unit) {
  currentTempUnit = unit;
  tempToggleActive = unit === "F";
  updateToggleSwitch("tempToggle", unit, tempToggleActive, ["C", "F"]);
}

function updatePressureToggleSwitch(unit) {
  currentPressureUnit = unit;
  pressureToggleActive = unit === "PSI";
  updateToggleSwitch("pressureToggle", unit, pressureToggleActive, ["Bar", "PSI"]);
}

function updateAlwaysOnToggleSwitch(isOn) {
  alwaysOnToggleActive = isOn;
  updateToggleSwitch("alwaysOnToggle", null, isOn, ["OFF", "ON"]);
}

function updateRawDataToggleSwitch(isVisible) {
  rawDataToggleActive = isVisible;
  updateToggleSwitch("rawDataToggle", null, isVisible, ["OFF", "ON"]);
  document.getElementById("rawDataDisplay").classList.toggle("hidden", !isVisible);
}

function updateSetControlInput(value) {
  const input = document.getElementById("setControlInput");
  const numValue = parseFloat(value);
  if (!isNaN(numValue)) {
    const formattedValue = numValue.toFixed(2);
    if (formattedValue.length <= 4) input.value = formattedValue;
  }
}

function updateBrightnessSlider(brightnessValue) {
  const slider = document.getElementById("brightnessSlider");
  const valueDisplay = document.getElementById("brightnessValue");
  const clampedValue = Math.max(10, Math.min(250, parseInt(brightnessValue)));
  slider.value = clampedValue;
  valueDisplay.textContent = clampedValue;
}

function updateConnectionState(connected) {
  const elements = ["tempToggle", "pressureToggle", "alwaysOnToggle", "brightnessContainer", "setControlContainer"];
  const inputs = ["setControlInput", "setControlButton", "zeroPressureButton"];
  
  elements.forEach(id => document.getElementById(id).classList.toggle("disabled", !connected));
  inputs.forEach(id => document.getElementById(id).disabled = !connected);
}

// Connection Functions
async function connectToDevice() {
  const btn = document.getElementById("connectButton");
  try {
    btn.textContent = "Connecting..."; btn.className = "connecting";
    device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: "SirusPTB" }], optionalServices: [serviceUuid] });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(serviceUuid);

    characteristic = await service.getCharacteristic(characteristicUuid);

    try {
      writeCharacteristic = await service.getCharacteristic(writeCharacteristicUuid);
    } catch (e) {
      if (characteristic.properties.write || characteristic.properties.writeWithoutResponse) {
        writeCharacteristic = characteristic;
      } else {
        const characteristics = await service.getCharacteristics();
        writeCharacteristic = characteristics.find(char => char.properties.write || char.properties.writeWithoutResponse);
      }
    }

    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged", handleData);

    btn.textContent = "Disconnect"; btn.className = "connected";
    isConnected = true;
    updateConnectionState(true);
    btn.onclick = disconnectFromDevice;

    brightnessDataReceived = alwaysOnDataReceived = setControlDataReceived = false;
    receivedDataCount = 0;

    device.addEventListener("gattserverdisconnected", handleDisconnection);
  } catch (e) {
    handleDisconnection();
  }
}

async function disconnectFromDevice() {
  if (characteristic) {
    try { await characteristic.stopNotifications(); } catch (e) { }
  }
  if (device?.gatt?.connected) {
    try { await device.gatt.disconnect(); } catch (e) { }
  }
  handleDisconnection();
}

function handleDisconnection() {
  const btn = document.getElementById("connectButton");
  btn.textContent = "Connect";
  btn.className = "disconnected";
  isConnected = false;
  updateConnectionState(false);
  updateGauges();
  characteristic = writeCharacteristic = device = null;
  btn.onclick = connectToDevice;
  brightnessDataReceived = alwaysOnDataReceived = setControlDataReceived = false;
  receivedDataCount = 0;
}

async function sendData(command) {
  if (device?.gatt?.connected && writeCharacteristic) {
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(command);

      if (writeCharacteristic.properties.writeWithoutResponse) {
        await writeCharacteristic.writeValueWithoutResponse(data);
      } else if (writeCharacteristic.properties.write) {
        await writeCharacteristic.writeValue(data);
      }

      addDataEntry(command, "sent");
    } catch (error) {
      addDataEntry(`Error: ${error.message}`, "error");
    }
  } else {
    addDataEntry("Cannot send data: Device not connected", "error");
  }
}

// Data Entry Management
function addDataEntry(data, type) {
  const timestamp = new Date().toLocaleTimeString();
  dataEntries.push({ timestamp, data, type });
  if (dataEntries.length > 100) dataEntries.pop();
  updateDataDisplay();
}

function updateDataDisplay() {
  const rawDataDisplay = document.getElementById("rawDataDisplay");
  const clearButton = document.getElementById("clearDataButton");
  rawDataDisplay.innerHTML = "";
  rawDataDisplay.appendChild(clearButton);

  if (dataEntries.length === 0) {
    const placeholder = document.createElement("div");
    placeholder.className = "data-entry";
    placeholder.textContent = "No data yet...";
    rawDataDisplay.appendChild(placeholder);
  } else {
    dataEntries.forEach(entry => {
      const entryElement = document.createElement("div");
      entryElement.className = `data-entry ${entry.type}`;
      
      const timestampSpan = document.createElement("span");
      timestampSpan.className = "data-timestamp";
      timestampSpan.textContent = `[${entry.timestamp}]`;
      
      const dataSpan = document.createElement("span");
      dataSpan.textContent = entry.data;
      
      entryElement.appendChild(timestampSpan);
      entryElement.appendChild(dataSpan);
      rawDataDisplay.appendChild(entryElement);
    });
  }

  rawDataDisplay.scrollTop = rawDataDisplay.scrollHeight;
}

// Event Handlers
document.getElementById("clearDataButton").onclick = () => { dataEntries = []; updateDataDisplay(); };

document.getElementById("setControlInput").oninput = function() {
  if (!isConnected) { this.value = ""; return; }
  let value = this.value.replace(/[^0-9.]/g, '');
  const decimalCount = (value.match(/\./g) || []).length;
  if (decimalCount > 1) {
    const parts = value.split('.');
    value = parts[0] + '.' + parts.slice(1).join('');
  }
  if (value.length > 4) value = value.substring(0, 4);
  this.value = value;
};

document.getElementById("setControlButton").onclick = async () => {
  if (!isConnected) return;
  const input = document.getElementById("setControlInput");
  const value = input.value.trim();
  if (value === "") { alert("Please enter a value"); return; }
  const numValue = parseFloat(value);
  if (isNaN(numValue)) { alert("Please enter a valid number"); return; }
  await sendData(`c${value}`);
};

document.getElementById("zeroPressureButton").onclick = async () => {
  if (isConnected) await sendData("g");
};

// Toggle Handlers
document.getElementById("tempToggle").onclick = async () => {
  if (document.getElementById("tempToggle").classList.contains("disabled")) return;
  ignoreTempUntil = Date.now() + 2000;
  const command = tempToggleActive ? "C" : "F";
  const newUnit = tempToggleActive ? "C" : "F";
  updateTempToggleSwitch(newUnit);
  updateCharts();
  updateGauges();
  await sendData(command);
};

document.getElementById("pressureToggle").onclick = async () => {
  if (document.getElementById("pressureToggle").classList.contains("disabled")) return;
  ignorePressureUntil = Date.now() + 2000;
  const command = pressureToggleActive ? "B" : "P";
  const newUnit = pressureToggleActive ? "Bar" : "PSI";
  updatePressureToggleSwitch(newUnit);
  updateCharts();
  updateGauges();
  await sendData(command);
};

document.getElementById("alwaysOnToggle").onclick = async () => {
  if (document.getElementById("alwaysOnToggle").classList.contains("disabled")) return;
  const newState = !alwaysOnToggleActive;
  const command = newState ? "S1" : "S0";
  updateAlwaysOnToggleSwitch(newState);
  await sendData(command);
};

document.getElementById("rawDataToggle").onclick = () => updateRawDataToggleSwitch(!rawDataToggleActive);

// Brightness Slider
let brightnessTimeout = null, userInitiatedBrightnessChange = false;

document.getElementById("brightnessSlider").oninput = function() {
  document.getElementById("brightnessValue").textContent = this.value;
  userInitiatedBrightnessChange = true;
};

document.getElementById("brightnessSlider").onchange = function() {
  if (userInitiatedBrightnessChange && isConnected) {
    if (brightnessTimeout) clearTimeout(brightnessTimeout);
    const formattedValue = this.value.padStart(3, '0');
    sendData(`L${formattedValue}`);
  }
  userInitiatedBrightnessChange = false;
};

// Button Handlers
document.getElementById("connectButton").onclick = connectToDevice;

document.getElementById("pauseResumeButton").onclick = () => {
  const btn = document.getElementById("pauseResumeButton");
  paused = !paused;
  btn.textContent = paused ? "Resume" : "Pause";
  btn.classList.toggle("resume", paused);
};

document.getElementById("resetButton").onclick = () => {
  chartData = { labels: [], temp: [], pressure: [] };
  secondsCounter = 0;

  [tempChart, pressureChart, combinedChart].forEach(chart => {
    chart.data.labels = [];
    chart.data.datasets.forEach(ds => ds.data = []);
    chart.update();
  });

  const tempUnit = currentTempUnit === "F" ? "°F" : "°C";
  const pressureUnit = currentPressureUnit === "PSI" ? "PSI" : "bar";

  document.getElementById("tempCurrentValue").textContent = `Temperature: -- ${tempUnit}`;
  document.getElementById("pressureCurrentValue").textContent = `Pressure: -- ${pressureUnit}`;
  document.getElementById("combinedCurrentValue").innerHTML = `<span style="color: #ff7f7f;">Temperature: -- ${tempUnit}</span> | <span style="color: #7fbfff;">Pressure: -- ${pressureUnit}</span>`;

  updateGauges();
};

document.getElementById("toggleViewButton").onclick = () => {
  if (!gaugeView) {
    splitView = !splitView;
    localStorage.setItem("viewChoice", splitView ? "split" : "combined");
  }
  updateView();
};

document.getElementById("toggleGaugeButton").onclick = () => {
  gaugeView = !gaugeView;
  localStorage.setItem("gaugeMode", gaugeView ? "true" : "false");
  updateView();
  if (gaugeView) setTimeout(updateGauges, 50);
};

function updateView() {
  const toggleViewButton = document.getElementById("toggleViewButton");
  const saveLoadDeleteButtons = document.getElementById("saveLoadDeleteButtons");
  const chartControlButtons = document.getElementById("chartControlButtons");

  if (gaugeView) {
    document.getElementById("splitView").style.display = "none";
    document.getElementById("combinedView").style.display = "none";
    document.getElementById("gaugeView").style.display = "flex";
    toggleViewButton.style.display = "none";
    saveLoadDeleteButtons.style.display = "none";
    document.getElementById("resetButton").style.display = "none";
    document.getElementById("toggleGaugeButton").textContent = "Charts";
  } else {
    document.getElementById("splitView").style.display = splitView ? "flex" : "none";
    document.getElementById("combinedView").style.display = splitView ? "none" : "flex";
    document.getElementById("gaugeView").style.display = "none";
    saveLoadDeleteButtons.style.display = "flex";
    document.getElementById("resetButton").style.display = "inline-block";
    toggleViewButton.style.display = "inline-block";
    toggleViewButton.textContent = splitView ? "Combine" : "Split";
    document.getElementById("toggleGaugeButton").textContent = "Gauges";
  }
}

// Load preferences
if (localStorage.getItem("viewChoice") === "combined") splitView = false;
if (localStorage.getItem("gaugeMode") === "true") gaugeView = true;
updateView();
setTimeout(updateGauges, 100);

document.getElementById("saveButton").onclick = () => {
  const name = prompt("Enter a name for saved graph:");
  if (name) localStorage.setItem("graph_" + name, JSON.stringify(chartData));
};

document.getElementById("loadButton").onclick = () => showModal("load");
document.getElementById("deleteButton").onclick = () => showModal("delete");

// Data Handling
function handleData(event) {
  const rawData = new TextDecoder().decode(event.target.value).trim();
  addDataEntry(rawData, "received");
  receivedDataCount++;

  const dataParts = rawData.split(",");

  // Handle temperature unit
  if (dataParts.length >= 3 && Date.now() > ignoreTempUntil) {
    const thirdValue = dataParts[2].trim();
    updateTempToggleSwitch(thirdValue === "F" ? "F" : "C");
  }

  // Handle pressure unit
  if (dataParts.length >= 4 && Date.now() > ignorePressureUntil) {
    const fourthValue = dataParts[3].trim();
    updatePressureToggleSwitch(fourthValue === "psi" ? "PSI" : "Bar");
  }

  // Handle always-on setting
  if (dataParts.length >= 5 && !alwaysOnDataReceived) {
    const fifthValue = dataParts[4].trim();
    if (fifthValue === "1" || fifthValue === "0") {
      updateAlwaysOnToggleSwitch(fifthValue === "1");
      alwaysOnDataReceived = true;
    }
  }

  // Handle brightness
  if (dataParts.length >= 6 && !brightnessDataReceived) {
    const brightnessValue = parseInt(dataParts[5].trim());
    if (!isNaN(brightnessValue) && brightnessValue >= 10 && brightnessValue <= 250) {
      updateBrightnessSlider(brightnessValue);
      brightnessDataReceived = true;
    }
  }

  // Handle set control value
  if (dataParts.length >= 7 && !setControlDataReceived) {
    const setValue = parseFloat(dataParts[6].trim());
    if (!isNaN(setValue)) {
      updateSetControlInput(setValue);
      setControlDataReceived = true;
    }
  }

  // Handle battery level
  if (dataParts.length >= 8) {
    const batteryValue = parseInt(dataParts[7].trim());
    if (!isNaN(batteryValue)) {
      const level = Math.max(0, Math.min(100, batteryValue));
      const batteryFill = document.getElementById("batteryLevel");
      const batteryOutline = document.querySelector('#batteryIcon rect[stroke="#ccc"]');
      const batteryTerminal = document.querySelector('#batteryIcon rect[fill="#ccc"]');
      
      if (batteryFill) {
        batteryFill.setAttribute("width", (level / 100) * 28);
        batteryFill.setAttribute("fill", level < 20 ? "#f44336" : "#4CAF50");
      }
      
      // Turn battery icon red when below 5%
      if (level < 5) {
        if (batteryOutline) batteryOutline.setAttribute("stroke", "#f44336");
        if (batteryTerminal) batteryTerminal.setAttribute("fill", "#f44336");
      } else {
        if (batteryOutline) batteryOutline.setAttribute("stroke", "#ccc");
        if (batteryTerminal) batteryTerminal.setAttribute("fill", "#ccc");
      }
    }
  }

  // Handle charging indicator
  if (dataParts.length >= 9) {
    const bolt = document.getElementById("boltIcon");
    if (bolt) bolt.style.display = dataParts[8].trim() === "1" ? "block" : "none";
  }

  // Handle backup brightness data
  if (receivedDataCount === 6 && dataParts.length >= 1 && !brightnessDataReceived) {
    const brightnessValue = parseInt(dataParts[0].trim());
    if (!isNaN(brightnessValue) && brightnessValue >= 10 && brightnessValue <= 250) {
      updateBrightnessSlider(brightnessValue);
      brightnessDataReceived = true;
    }
  }

  if (paused || dataParts.length < 2) return;

  const parsedTemp = parseFloat(dataParts[0]);
  const parsedPressure = parseFloat(dataParts[1]);

  if (!isNaN(parsedTemp) && !isNaN(parsedPressure)) {
    currentTemp = parsedTemp;
    currentPressure = Math.max(0, parsedPressure);
    updateCharts();
    updateGauges();
  }
}

function updateCharts() {
  const label = secondsCounter++;
  chartData.labels.push(label);
  chartData.temp.push(currentTemp);
  chartData.pressure.push(currentPressure);

  if (chartData.labels.length > maxPointsValue) {
    chartData.labels.shift();
    chartData.temp.shift();
    chartData.pressure.shift();
  }

  const tempUnit = currentTempUnit === "F" ? "°F" : "°C";
  const pressureUnit = currentPressureUnit === "PSI" ? "PSI" : "bar";

  // Update temperature chart
  tempChart.data.labels = chartData.labels;
  tempChart.data.datasets[0].data = chartData.temp;
  tempChart.data.datasets[0].label = `Temp (${tempUnit})`;
  tempChart.options.scales.y.title.text = `Temperature (${tempUnit})`;

  if (currentTemp > 50) {
    tempChart.options.scales.y.min = 45;
    tempChart.options.scales.y.max = 120;
  } else {
    tempChart.options.scales.y.min = 0;
    tempChart.options.scales.y.max = 120;
  }

  document.getElementById("tempCurrentValue").textContent = `Temperature: ${currentTemp.toFixed(1)} ${tempUnit}`;
  tempChart.update();

  // Update pressure chart
  const displayPressure = currentPressureUnit === "PSI" ? currentPressure : currentPressure;
  pressureChart.data.labels = chartData.labels;
  pressureChart.data.datasets[0].data = chartData.pressure.map(p => currentPressureUnit === "PSI" ? p : p);
  pressureChart.data.datasets[0].label = `Pressure (${pressureUnit})`;
  pressureChart.options.scales.y.title.text = `Pressure (${pressureUnit})`;

  document.getElementById("pressureCurrentValue").textContent = `Pressure: ${displayPressure.toFixed(2)} ${pressureUnit}`;
  pressureChart.update();

  // Update combined chart
  combinedChart.data.labels = chartData.labels;
  combinedChart.data.datasets[0].data = chartData.temp;
  combinedChart.data.datasets[1].data = chartData.pressure.map(p => currentPressureUnit === "PSI" ? p : p);
  combinedChart.data.datasets[0].label = `Temp (${tempUnit})`;
  combinedChart.data.datasets[1].label = `Pressure (${pressureUnit})`;

  document.getElementById("combinedCurrentValue").innerHTML = `<span style="color: #ff7f7f;">Temperature: ${currentTemp.toFixed(1)} ${tempUnit}</span> | <span style="color: #7fbfff;">Pressure: ${displayPressure.toFixed(2)} ${pressureUnit}</span>`;
  combinedChart.update();
}

// Connection monitoring
setInterval(() => {
  const btn = document.getElementById("connectButton");
  if (device) {
    if (device.gatt.connected) {
      btn.textContent = "Disconnect";
      btn.className = "connected";
      if (!isConnected) {
        isConnected = true;
        updateConnectionState(true);
        updateGauges();
      }
    } else {
      btn.textContent = "Connect";
      btn.className = "disconnected";
      if (isConnected) {
        isConnected = false;
        updateConnectionState(false);
        updateGauges();
      }
    }
  }
}, 1000);

updateConnectionState(false);

// Help functionality
document.getElementById("helpIcon").onclick = () => document.getElementById("helpPopup").style.display = "flex";
document.getElementById("closeHelp").onclick = () => document.getElementById("helpPopup").style.display = "none";
window.onclick = event => {
  if (event.target === document.getElementById("helpPopup")) {
    document.getElementById("helpPopup").style.display = "none";
  }
};

// Footer scroll behavior
window.addEventListener('scroll', () => {
  const footer = document.querySelector('footer');
  const scrollPosition = window.innerHeight + window.scrollY;
  const pageHeight = document.body.offsetHeight;
  footer.style.display = scrollPosition >= pageHeight - 2 ? 'flex' : 'none';
});

// Auto-scroll raw data
(function() {
  function scrollRawToBottom() {
    const el = document.getElementById('rawDataDisplay');
    if (el) el.scrollTop = el.scrollHeight;
  }

  function initRawAutoScroll() {
    const el = document.getElementById('rawDataDisplay');
    if (!el) return;

    scrollRawToBottom();

    try {
      const observer = new MutationObserver(scrollRawToBottom);
      observer.observe(el, { childList: true, subtree: true, characterData: true });
    } catch (e) {}

    const tog = document.getElementById('rawDataToggle');
    if (tog && !tog.dataset.rawAutoScrollHooked) {
      tog.addEventListener('click', () => setTimeout(scrollRawToBottom, 0));
      tog.dataset.rawAutoScrollHooked = "1";
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRawAutoScroll);
  } else {
    initRawAutoScroll();
  }
})();
</script>

</main>

<footer>
  <span>SirusPTB</span>
  <a href="game.html" title="Play Bean Game">
    <svg class="bean-icon" viewBox="0 0 64 64">
      <path d="M45 10c-8-4-20 0-25 7-5 6-6 15-4 23 2 8 8 14 16 15 7 1 13-4 17-10 4-6 6-13 6-19 0-8-4-13-10-16z" fill="#8B4513" />
    </svg>
  </a>
</footer>

</body>
</html>