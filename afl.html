<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFL Games to Google Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 20px;
            color: #e5e5e5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #111111;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #1f1f1f;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            color: white;
            padding: 48px 40px;
            text-align: center;
            border-bottom: 1px solid #1f1f1f;
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .header p {
            opacity: 0.6;
            font-size: 1rem;
            font-weight: 400;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #a3a3a3;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #0a0a0a;
        }

        .team-checkbox:hover {
            border-color: #2a2a2a;
            background: #151515;
        }

        .team-checkbox input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .team-checkbox label {
            cursor: pointer;
            flex: 1;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #d4d4d4;
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .team-logo {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }

        .team-checkbox input[type="checkbox"]:checked + label {
            color: #ffffff;
        }

        .team-checkbox input[type="checkbox"]:checked {
            background: #3b82f6;
        }

        .select-all-btn {
            padding: 10px 18px;
            background: #1a1a1a;
            color: #d4d4d4;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            margin-bottom: 16px;
        }

        .select-all-btn:hover {
            background: #252525;
            border-color: #3a3a3a;
        }

        .auth-section {
            margin-bottom: 24px;
        }

        .auth-btn {
            width: 100%;
            padding: 16px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .auth-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .auth-btn:active {
            transform: translateY(0);
        }

        .auth-btn:disabled {
            background: #1a1a1a;
            color: #525252;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn {
            width: 100%;
            padding: 16px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .generate-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn:disabled {
            background: #1a1a1a;
            color: #525252;
            cursor: not-allowed;
            transform: none;
        }

        .manage-btn {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.2s ease;
            background: #0a0a0a;
        }

        .manage-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #updateBtn {
            color: #60a5fa;
            border-color: #1e3a5f;
        }

        #updateBtn:hover:not(:disabled) {
            background: #0f1d2f;
            border-color: #2563eb;
        }

        #removeBtn {
            color: #f87171;
            border-color: #5f1e1e;
        }

        #removeBtn:hover:not(:disabled) {
            background: #2f0f0f;
            border-color: #dc2626;
        }

        .status {
            margin-top: 24px;
            padding: 16px 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .status.loading {
            display: block;
            background: #0a1929;
            color: #60a5fa;
            border: 1px solid #1e3a5f;
        }

        .status.success {
            display: block;
            background: #0a1f0a;
            color: #4ade80;
            border: 1px solid #1e5f1e;
        }

        .status.error {
            display: block;
            background: #1f0a0a;
            color: #f87171;
            border: 1px solid #5f1e1e;
        }

        .spinner {
            border: 3px solid #1a1a1a;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #0a0a0a;
            border-left: 3px solid #3b82f6;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 0.9375rem;
            line-height: 1.6;
            color: #d4d4d4;
        }

        .info-box strong {
            color: #ffffff;
            font-weight: 600;
        }

        .user-info {
            display: none;
            background: #0a0a0a;
            border: 1px solid #1f1f1f;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 24px;
            align-items: center;
            justify-content: space-between;
        }

        .user-info.show {
            display: flex;
        }

        .user-details {
            color: #d4d4d4;
            font-size: 0.9375rem;
        }

        .user-details strong {
            color: #ffffff;
            font-weight: 600;
        }

        .signout-btn {
            padding: 8px 16px;
            background: transparent;
            color: #f87171;
            border: 1px solid #5f1e1e;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .signout-btn:hover {
            background: #2f0f0f;
            border-color: #dc2626;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #1a1a1a;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 24px;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: #0a0a0a;
            border: 1px solid #1f1f1f;
            border-radius: 10px;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-wrapper:hover {
            border-color: #2a2a2a;
            background: #151515;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .checkbox-wrapper span {
            color: #d4d4d4;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
        }

        /* Download button styling */
        .download-btn {
            width: 100%;
            padding: 16px 24px;
            background: transparent;
            color: #d4d4d4;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 12px;
        }

        .download-btn:hover {
            background: #1a1a1a;
            border-color: #3a3a3a;
            color: #ffffff;
        }

        .download-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<body>
    <div class="container">
        <div class="header">
            <h1>AFL to Calendar</h1>
            <p>Add AFL fixtures directly to your Google Calendar</p>
        </div>

        <div class="content">
            <div class="info-box">
                <p><strong>Quick Start:</strong> Select your favourite teams below, then use "Download ICS File" to get a calendar file you can import into Google Calendar, Apple Calendar, Outlook, or any calendar app. No sign-in required. Or sign in to Google and import the event automatically.</p>
            </div>

            <div class="section">
                <div class="section-title">2026 AFL Season</div>
                <p style="color: #94a3b8; margin-bottom: 20px;">Select your favourite teams to add their fixtures to your calendar</p>
            </div>

            <div class="section">
                <div class="section-title">Select Teams</div>
                <button class="select-all-btn" id="selectAllBtn">Select All Teams</button>
                <div class="teams-grid" id="teamsContainer">
                    <div class="status loading">
                        <div class="spinner"></div>
                        Loading teams...
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">ðŸ“¥ Download Calendar File</div>
                <button class="download-btn" id="downloadBtn" disabled style="width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 600; background: #2a5a3a; color: #86efac; border: 2px solid #3a7a4a;">Download ICS File</button>
                <p style="text-align: center; color: #94a3b8; margin-top: 10px; font-size: 0.9rem;">Works with Google Calendar, Apple Calendar, Outlook, and more</p>
            </div>

            <div style="text-align: center; margin: 30px 0; color: #4a5568; font-weight: 600;">
                â€” OR â€”
            </div>

            <div class="section">
                <div class="section-title">ðŸ”— Direct Google Calendar Integration</div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; color: #94a3b8; cursor: pointer;">
                        <input type="checkbox" id="allDayEventsCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Create as all-day events (better for year view)</span>
                    </label>
                </div>

                <div class="user-info" id="userInfo">
                    <div class="user-details">
                        <span>âœ“ Signed in as <strong id="userEmail"></strong></span>
                    </div>
                    <button class="signout-btn" id="signoutBtn">Sign Out</button>
                </div>

                <div class="auth-section" id="authSection">
                    <button class="auth-btn" id="authorizeBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                </div>

                <button class="generate-btn" id="generateBtn" disabled>Add to Google Calendar</button>

                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="manage-btn" id="updateBtn" disabled style="flex: 1; padding: 12px; background: #2a4a5a; color: #7dd3fc; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: background 0.3s;">Update Existing Events</button>
                    <button class="manage-btn" id="removeBtn" disabled style="flex: 1; padding: 12px; background: #4a2a2a; color: #fca5a5; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: background 0.3s;">Remove All AFL Events</button>
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="status" id="statusMsg"></div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const API_BASE = 'https://api.squiggle.com.au';
        const CLIENT_ID = '1017993533846-vddmd49lpivato6chlv2kk7nol2u3srf.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';
        const CURRENT_YEAR = 2026;
        
        let teams = [];
        let ladder = {};
        let allTeamsSelected = false;
        let tokenClient;
        let accessToken = null;

        // Initialize Google Identity Services
        function initializeGoogleAuth() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                });
            } catch (error) {
                console.error('Failed to initialize Google Auth:', error);
            }
        }

        function handleAuthCallback(response) {
            if (response.error !== undefined) {
                showStatus('error', 'Authorization failed: ' + response.error);
                return;
            }
            
            accessToken = response.access_token;
            
            // Store token expiry time (tokens typically last 1 hour)
            const expiryTime = Date.now() + (response.expires_in * 1000);
            sessionStorage.setItem('google_access_token', accessToken);
            sessionStorage.setItem('google_token_expiry', expiryTime.toString());
            
            document.getElementById('authorizeBtn').style.display = 'none';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('updateBtn').disabled = false;
            document.getElementById('removeBtn').disabled = false;
            
            // Get user info
            getUserInfo();
        }

        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to get user info, status:', response.status);
                    throw new Error('Failed to get user info');
                }
                
                const data = await response.json();
                console.log('User data received:', data);
                const displayEmail = data.email || 'Signed In User';
                
                // Store user info in session
                sessionStorage.setItem('google_user_name', displayEmail);
                
                document.getElementById('userEmail').textContent = displayEmail;
                document.getElementById('userInfo').classList.add('show');
                console.log('User info displayed:', displayEmail);
            } catch (error) {
                console.error('Error getting user info:', error);
                // Still show the user info box even if we can't get details
                document.getElementById('userEmail').textContent = 'Signed In';
                document.getElementById('userInfo').classList.add('show');
            }
        }

        document.getElementById('authorizeBtn').addEventListener('click', () => {
            if (!tokenClient) {
                initializeGoogleAuth();
                setTimeout(() => {
                    if (tokenClient) {
                        tokenClient.requestAccessToken({ prompt: 'consent' });
                    }
                }, 100);
            } else {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        });

        document.getElementById('signoutBtn').addEventListener('click', () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
            }
            accessToken = null;
            
            // Clear session storage
            sessionStorage.removeItem('google_access_token');
            sessionStorage.removeItem('google_token_expiry');
            sessionStorage.removeItem('google_user_name');
            
            document.getElementById('authorizeBtn').style.display = 'flex';
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('updateBtn').disabled = true;
            document.getElementById('removeBtn').disabled = true;
            document.getElementById('userInfo').classList.remove('show');
        });

        // Load teams on page load
        async function loadTeams() {
            try {
                const response = await fetch(`${API_BASE}/?q=teams`);
                const data = await response.json();
                teams = data.teams;
                
                // Load ladder standings
                await loadLadder();
                
                renderTeams();
            } catch (error) {
                showStatus('error', 'Failed to load teams. Please refresh the page.');
            }
        }

        async function loadLadder() {
            try {
                const response = await fetch(`${API_BASE}/?q=standings;year=${CURRENT_YEAR}`);
                const data = await response.json();
                
                // Create a map of team name to ladder position
                if (data.standings && data.standings.length > 0) {
                    data.standings.forEach(standing => {
                        ladder[standing.name] = {
                            rank: standing.rank,
                            wins: standing.wins,
                            losses: standing.losses,
                            draws: standing.draws,
                            points: standing.pts
                        };
                    });
                }
            } catch (error) {
                console.log('Ladder data not available yet for', CURRENT_YEAR);
            }
        }

        function renderTeams() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = teams.map(team => {
                // Construct absolute logo URL
                const logoUrl = team.logo.startsWith('http') 
                    ? team.logo 
                    : `https://squiggle.com.au/${team.logo}`;
                
                // Get ladder position if available
                const standing = ladder[team.name];
                const ladderInfo = standing 
                    ? `<span style="color: #4b5563; font-size: 0.85rem; margin-left: auto;">#${standing.rank}</span>`
                    : '';
                
                return `
                    <div class="team-checkbox">
                        <input type="checkbox" id="team-${team.id}" value="${team.id}" data-name="${team.name}">
                        <label for="team-${team.id}" style="display: flex; align-items: center; width: 100%;">
                            <img src="${logoUrl}" alt="${team.name}" class="team-logo" onerror="this.style.display='none'">
                            <span style="flex: 1;">${team.name}</span>
                            ${ladderInfo}
                        </label>
                    </div>
                `;
            }).join('');

            // Enable download button when teams are loaded
            document.getElementById('downloadBtn').disabled = false;

            // Add event listeners to checkboxes
            document.querySelectorAll('.team-checkbox input').forEach(cb => {
                cb.addEventListener('change', updateSelectAllButton);
            });
        }

        function updateSelectAllButton() {
            const checkboxes = document.querySelectorAll('.team-checkbox input');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (allChecked) {
                selectAllBtn.textContent = 'Deselect All Teams';
                allTeamsSelected = true;
            } else {
                selectAllBtn.textContent = 'Select All Teams';
                allTeamsSelected = false;
            }
        }

        document.getElementById('selectAllBtn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.team-checkbox input');
            checkboxes.forEach(cb => {
                cb.checked = !allTeamsSelected;
            });
            updateSelectAllButton();
        });

        document.getElementById('generateBtn').addEventListener('click', addToGoogleCalendar);
        document.getElementById('downloadBtn').addEventListener('click', downloadICSFile);
        document.getElementById('updateBtn').addEventListener('click', updateGoogleCalendarEvents);
        document.getElementById('removeBtn').addEventListener('click', removeAllAFLEvents);

        async function updateGoogleCalendarEvents() {
            if (!accessToken) {
                showStatus('error', 'Please sign in with Google first.');
                return;
            }

            // Validate token is still valid
            if (!isTokenValid()) {
                showStatus('error', 'Your session has expired. Please sign in again.');
                clearSession();
                return;
            }

            if (!confirm('This will update all existing AFL events in your calendar with the latest information (dates, times, venues, ladder positions). Continue?')) {
                return;
            }

            const selectedTeams = Array.from(document.querySelectorAll('.team-checkbox input:checked'))
                .map(cb => ({ id: cb.value, name: cb.dataset.name }));

            if (selectedTeams.length === 0) {
                showStatus('error', 'Please select at least one team.');
                return;
            }

            showStatus('loading', 'Fetching AFL events from your calendar...');
            document.getElementById('updateBtn').disabled = true;

            try {
                // Get existing AFL events
                const existingEvents = await getAFLEventsFromCalendar();
                
                if (existingEvents.length === 0) {
                    showStatus('error', 'No AFL events found in your calendar to update.');
                    document.getElementById('updateBtn').disabled = false;
                    return;
                }

                // Get latest game data for selected teams
                const games = await fetchGames(CURRENT_YEAR, selectedTeams);
                
                // Filter existing events to only those involving selected teams
                const selectedTeamNames = selectedTeams.map(t => t.name);
                const eventsToUpdate = existingEvents.filter(event => {
                    if (!event.summary) return false;
                    return selectedTeamNames.some(teamName => event.summary.includes(teamName));
                });

                if (eventsToUpdate.length === 0) {
                    showStatus('error', 'No events found for the selected teams.');
                    document.getElementById('updateBtn').disabled = false;
                    return;
                }
                
                showStatus('loading', `Updating ${eventsToUpdate.length} events...`);
                document.getElementById('progressBar').classList.add('show');
                
                // Scroll to progress bar
                document.getElementById('progressBar').scrollIntoView({ behavior: 'smooth', block: 'center' });

                let updatedCount = 0;
                let failedCount = 0;

                for (let i = 0; i < eventsToUpdate.length; i++) {
                    const event = eventsToUpdate[i];
                    
                    // Find matching game by parsing event summary
                    // Handle both "Team1 vs Team2" and "Team1 vs Team2 (AEDT)" formats
                    const match = event.summary.match(/(.+?) vs (.+?)(?:\s*\(|$)/);
                    if (!match) continue;
                    
                    const homeTeam = match[1].trim();
                    const awayTeam = match[2].trim();
                    
                    const game = games.find(g => 
                        g.hteam === homeTeam && g.ateam === awayTeam
                    );

                    if (game && game.date) {
                        try {
                            await updateEventInCalendar(event.id, game, CURRENT_YEAR);
                            updatedCount++;
                        } catch (error) {
                            console.error('Failed to update event:', event, error);
                            failedCount++;
                        }
                    }

                    const progress = ((i + 1) / eventsToUpdate.length) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                document.getElementById('progressBar').classList.remove('show');
                document.getElementById('progressFill').style.width = '0%';

                if (updatedCount > 0) {
                    showStatus('success', `âœ“ Updated ${updatedCount} events!${failedCount > 0 ? ` (${failedCount} failed)` : ''}`);
                } else {
                    showStatus('error', 'No events were updated. Make sure the selected teams match your calendar events.');
                }
                        } catch (error) {
                            console.error('Failed to update event:', event, error);
                            failedCount++;
                        }
                    }

                    const progress = ((i + 1) / existingEvents.length) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                document.getElementById('progressBar').classList.remove('show');
                document.getElementById('progressFill').style.width = '0%';

                if (updatedCount > 0) {
                    showStatus('success', `âœ“ Updated ${updatedCount} events!${failedCount > 0 ? ` (${failedCount} failed)` : ''}`);
                } else {
                    showStatus('error', 'No events were updated.');
                }

                document.getElementById('updateBtn').disabled = false;

            } catch (error) {
                document.getElementById('progressBar').classList.remove('show');
                showStatus('error', 'Failed to update events. Please try again.');
                document.getElementById('updateBtn').disabled = false;
            }
        }

        async function removeAllAFLEvents() {
            if (!accessToken) {
                showStatus('error', 'Please sign in with Google first.');
                return;
            }

            // Validate token is still valid
            if (!isTokenValid()) {
                showStatus('error', 'Your session has expired. Please sign in again.');
                clearSession();
                return;
            }

            if (!confirm('This will DELETE all AFL 2026 events from your calendar. This action cannot be undone. Continue?')) {
                return;
            }

            showStatus('loading', 'Fetching AFL events from your calendar...');
            document.getElementById('removeBtn').disabled = true;

            try {
                const events = await getAFLEventsFromCalendar();
                
                if (events.length === 0) {
                    showStatus('error', 'No AFL events found in your calendar.');
                    document.getElementById('removeBtn').disabled = false;
                    return;
                }

                showStatus('loading', `Removing ${events.length} events...`);
                document.getElementById('progressBar').classList.add('show');
                
                // Scroll to progress bar
                document.getElementById('progressBar').scrollIntoView({ behavior: 'smooth', block: 'center' });

                let removedCount = 0;
                let failedCount = 0;

                for (let i = 0; i < events.length; i++) {
                    try {
                        await deleteEventFromCalendar(events[i].id);
                        removedCount++;
                    } catch (error) {
                        console.error('Failed to delete event:', events[i], error);
                        failedCount++;
                    }

                    const progress = ((i + 1) / events.length) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                document.getElementById('progressBar').classList.remove('show');
                document.getElementById('progressFill').style.width = '0%';

                if (removedCount > 0) {
                    showStatus('success', `âœ“ Removed ${removedCount} events!${failedCount > 0 ? ` (${failedCount} failed)` : ''}`);
                } else {
                    showStatus('error', 'No events were removed.');
                }

                document.getElementById('removeBtn').disabled = false;

            } catch (error) {
                document.getElementById('progressBar').classList.remove('show');
                showStatus('error', 'Failed to remove events. Please try again.');
                document.getElementById('removeBtn').disabled = false;
            }
        }

        async function getAFLEventsFromCalendar() {
            // Search for events with "vs" in the summary (AFL game format)
            // Search from 2024 onwards to catch events from previous/current/future seasons
            const timeMin = new Date(`2024-01-01T00:00:00Z`).toISOString();
            const timeMax = new Date(`${CURRENT_YEAR + 1}-12-31T23:59:59Z`).toISOString();
            
            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
                `timeMin=${timeMin}&timeMax=${timeMax}&q=vs&maxResults=2500&singleEvents=true`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error('Failed to fetch calendar events');
            }

            const data = await response.json();
            // Filter to only AFL events (those with "vs" in summary)
            // Also filter by checking if description contains "AFL" to avoid false positives
            const aflEvents = (data.items || []).filter(event => {
                const hasVs = event.summary && event.summary.includes(' vs ');
                const hasAFL = event.description && event.description.includes('AFL');
                return hasVs && hasAFL;
            });
            
            return aflEvents;
        }

        async function updateEventInCalendar(eventId, game, year) {
            const gameDate = new Date(game.date);
            const endDate = new Date(gameDate.getTime() + 3 * 60 * 60 * 1000);

            // Use timezone from API if available, otherwise default to AEDT/AEST based on date
            let timezone = game.tz || 'AEDT';
            // Normalize timezone format (API might return +11:00 format)
            if (timezone.includes('+')) {
                const month = gameDate.getMonth();
                const isDST = month >= 9 || month <= 2;
                timezone = isDST ? 'AEDT' : 'AEST';
            }

            // Check if user wants all-day events
            const allDay = document.getElementById('allDayEventsCheckbox').checked;

            // Get ladder positions for teams
            const homeStanding = ladder[game.hteam];
            const awayStanding = ladder[game.ateam];
            const homeRank = homeStanding ? ` (#${homeStanding.rank})` : '';
            const awayRank = awayStanding ? ` (#${awayStanding.rank})` : '';

            const event = {
                summary: allDay ? `${game.hteam} vs ${game.ateam}` : `${game.hteam} vs ${game.ateam} (${timezone})`,
                location: game.venue || 'TBA',
                description: `AFL ${year} - ${game.round ? `Round ${game.round}` : 'TBA'}\nHome: ${game.hteam}${homeRank}\nAway: ${game.ateam}${awayRank}${game.venue ? `\nVenue: ${game.venue}` : ''}`,
                colorId: '9'
            };

            if (allDay) {
                // All-day event (shows in year view)
                const dateStr = gameDate.toISOString().split('T')[0];
                event.start = { date: dateStr };
                event.end = { date: dateStr };
            } else {
                // Timed event
                event.start = {
                    dateTime: gameDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                };
                event.end = {
                    dateTime: endDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                };
            }

            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                }
            );

            if (!response.ok) {
                throw new Error('Failed to update event');
            }

            return await response.json();
        }

        async function deleteEventFromCalendar(eventId) {
            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`,
                {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error('Failed to delete event');
            }
        }

        async function addToGoogleCalendar() {
            if (!accessToken) {
                showStatus('error', 'Please sign in with Google first.');
                return;
            }

            // Validate token is still valid
            if (!isTokenValid()) {
                showStatus('error', 'Your session has expired. Please sign in again.');
                clearSession();
                return;
            }

            const selectedTeams = Array.from(document.querySelectorAll('.team-checkbox input:checked'))
                .map(cb => ({ id: cb.value, name: cb.dataset.name }));

            if (selectedTeams.length === 0) {
                showStatus('error', 'Please select at least one team.');
                return;
            }

            showStatus('loading', 'Fetching games from Squiggle API...');
            document.getElementById('generateBtn').disabled = true;

            try {
                const games = await fetchGames(CURRENT_YEAR, selectedTeams);

                if (games.length === 0) {
                    showStatus('error', 'No games found for the selected teams and year.');
                    document.getElementById('generateBtn').disabled = !accessToken;
                    return;
                }

                // Check for existing AFL events to avoid duplicates
                showStatus('loading', 'Checking for existing events...');
                const existingEvents = await getAFLEventsFromCalendar();
                
                // Create a set of existing event identifiers (team matchups)
                const existingMatchups = new Set(
                    existingEvents.map(event => {
                        if (!event.summary) return null;
                        // Extract team names from summary (format: "Team1 vs Team2" or "Team1 vs Team2 (AEDT)")
                        const match = event.summary.match(/(.+?) vs (.+?)(?:\s*\(|$)/);
                        if (!match) return null;
                        const teams = [match[1].trim(), match[2].trim()].sort();
                        return teams.join('|');
                    }).filter(Boolean)
                );

                // Filter out games that already exist
                const newGames = games.filter(game => {
                    const teams = [game.hteam, game.ateam].sort();
                    const matchupKey = teams.join('|');
                    return !existingMatchups.has(matchupKey);
                });

                if (newGames.length === 0) {
                    showStatus('success', 'All games are already in your calendar! Use "Update Existing Events" to refresh them.');
                    document.getElementById('generateBtn').disabled = !accessToken;
                    return;
                }

                showStatus('loading', `Adding ${newGames.length} new games to your Google Calendar...`);
                document.getElementById('progressBar').classList.add('show');
                
                // Scroll to progress bar
                document.getElementById('progressBar').scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Add events to Google Calendar
                let addedCount = 0;
                let failedCount = 0;
                const skippedCount = games.length - newGames.length;

                for (let i = 0; i < newGames.length; i++) {
                    const game = newGames[i];
                    if (!game.date) continue;

                    try {
                        await addEventToCalendar(game, CURRENT_YEAR);
                        addedCount++;
                    } catch (error) {
                        console.error('Failed to add game:', game, error);
                        failedCount++;
                    }

                    // Update progress
                    const progress = ((i + 1) / newGames.length) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';

                    // Rate limiting - wait 100ms between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                document.getElementById('progressBar').classList.remove('show');
                document.getElementById('progressFill').style.width = '0%';

                if (addedCount > 0) {
                    const message = `âœ“ Successfully added ${addedCount} games to your Google Calendar!${skippedCount > 0 ? ` (${skippedCount} already existed)` : ''}${failedCount > 0 ? ` (${failedCount} failed)` : ''}`;
                    showStatus('success', message);
                } else {
                    showStatus('error', 'Failed to add games to calendar. Please try again.');
                }

                document.getElementById('generateBtn').disabled = !accessToken;

            } catch (error) {
                document.getElementById('progressBar').classList.remove('show');
                showStatus('error', 'Failed to fetch games. Please try again.');
                document.getElementById('generateBtn').disabled = !accessToken;
            }
        }

        async function downloadICSFile() {
            const selectedTeams = Array.from(document.querySelectorAll('.team-checkbox input:checked'))
                .map(cb => ({ id: cb.value, name: cb.dataset.name }));

            if (selectedTeams.length === 0) {
                showStatus('error', 'Please select at least one team.');
                return;
            }

            showStatus('loading', 'Generating ICS file...');

            try {
                const games = await fetchGames(CURRENT_YEAR, selectedTeams);

                if (games.length === 0) {
                    showStatus('error', 'No games found for the selected teams.');
                    return;
                }

                const icsContent = generateICS(games, CURRENT_YEAR);
                downloadICS(icsContent, `AFL_${CURRENT_YEAR}_Calendar.ics`);

                showStatus('success', `âœ“ Downloaded ICS file with ${games.length} games!`);

            } catch (error) {
                showStatus('error', 'Failed to generate ICS file. Please try again.');
            }
        }

        async function fetchGames(year, selectedTeams) {
            const response = await fetch(`${API_BASE}/?q=games;year=${year}`);
            const data = await response.json();
            
            // Filter games by selected teams
            let games = data.games;
            if (selectedTeams.length < teams.length) {
                const selectedTeamIds = selectedTeams.map(t => parseInt(t.id));
                games = games.filter(game => 
                    selectedTeamIds.includes(game.hteamid) || selectedTeamIds.includes(game.ateamid)
                );
            }

            return games;
        }

        async function addEventToCalendar(game, year) {
            const gameDate = new Date(game.date);
            const endDate = new Date(gameDate.getTime() + 3 * 60 * 60 * 1000); // 3 hours later

            // Use timezone from API if available, otherwise default to AEDT/AEST based on date
            let timezone = game.tz || 'AEDT';
            // Normalize timezone format (API might return +11:00 format)
            if (timezone.includes('+')) {
                const month = gameDate.getMonth();
                const isDST = month >= 9 || month <= 2;
                timezone = isDST ? 'AEDT' : 'AEST';
            }

            // Check if user wants all-day events
            const allDay = document.getElementById('allDayEventsCheckbox').checked;

            // Get ladder positions for teams
            const homeStanding = ladder[game.hteam];
            const awayStanding = ladder[game.ateam];
            const homeRank = homeStanding ? ` (#${homeStanding.rank})` : '';
            const awayRank = awayStanding ? ` (#${awayStanding.rank})` : '';

            const event = {
                summary: allDay ? `${game.hteam} vs ${game.ateam}` : `${game.hteam} vs ${game.ateam} (${timezone})`,
                location: game.venue || 'TBA',
                description: `AFL ${year} - ${game.round ? `Round ${game.round}` : 'TBA'}\nHome: ${game.hteam}${homeRank}\nAway: ${game.ateam}${awayRank}${game.venue ? `\nVenue: ${game.venue}` : ''}`,
                colorId: '9' // Blue color for AFL games
            };

            if (allDay) {
                // All-day event (shows in year view)
                const dateStr = gameDate.toISOString().split('T')[0];
                event.start = { date: dateStr };
                event.end = { date: dateStr };
            } else {
                // Timed event
                event.start = {
                    dateTime: gameDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                };
                event.end = {
                    dateTime: endDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                };
            }

            const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(event)
            });

            if (!response.ok) {
                throw new Error('Failed to add event');
            }

            return await response.json();
        }

        function generateICS(games, year) {
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//AFL Calendar Generator//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:AFL ${year} Season
X-WR-TIMEZONE:Australia/Melbourne
X-WR-CALDESC:AFL ${year} Season Fixtures
`;

            games.forEach(game => {
                if (!game.date) return;

                const gameDate = new Date(game.date);
                const dtstart = formatICSDate(gameDate);
                
                // Add 3 hours for game duration (typical AFL game length)
                const endDate = new Date(gameDate.getTime() + 3 * 60 * 60 * 1000);
                const dtend = formatICSDate(endDate);

                const summary = `${game.hteam} vs ${game.ateam}`;
                const location = game.venue || 'TBA';
                const roundName = game.round ? `Round ${game.round}` : 'TBA';
                
                let description = `AFL ${year} - ${roundName}\\n`;
                description += `Home: ${game.hteam}\\n`;
                description += `Away: ${game.ateam}\\n`;
                if (game.venue) description += `Venue: ${game.venue}\\n`;

                ics += `BEGIN:VEVENT
UID:afl-${game.id}@squiggle.com.au
DTSTAMP:${timestamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${summary}
LOCATION:${location}
DESCRIPTION:${description}
STATUS:CONFIRMED
TRANSP:TRANSPARENT
END:VEVENT
`;
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        function formatICSDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
        }

        function downloadICS(content, filename) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMsg');
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'loading') {
                statusEl.innerHTML = `<div class="spinner"></div>${message}`;
            } else {
                statusEl.textContent = message;
            }

            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 8000);
            }
        }

        // Initialize on page load
        window.onload = () => {
            loadTeams();
            // Delay initialization to ensure Google script is loaded
            setTimeout(initializeGoogleAuth, 1000);
            
            // Try to restore previous session
            restoreSession();
        };

        function restoreSession() {
            const storedToken = sessionStorage.getItem('google_access_token');
            const storedExpiry = sessionStorage.getItem('google_token_expiry');
            const storedUserName = sessionStorage.getItem('google_user_name');
            
            // Check if we have a stored token and it hasn't expired
            if (storedToken && storedExpiry) {
                const expiryTime = parseInt(storedExpiry);
                const now = Date.now();
                
                if (now < expiryTime) {
                    // Token is still valid
                    accessToken = storedToken;
                    
                    // Restore UI state
                    document.getElementById('authorizeBtn').style.display = 'none';
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('updateBtn').disabled = false;
                    document.getElementById('removeBtn').disabled = false;
                    
                    // Restore user info if available
                    if (storedUserName) {
                        document.getElementById('userEmail').textContent = storedUserName;
                        document.getElementById('userInfo').classList.add('show');
                    } else {
                        // Try to fetch user info again
                        getUserInfo();
                    }
                    
                    console.log('Session restored successfully');
                } else {
                    // Token expired, clear storage
                    clearSession();
                    console.log('Session expired, please sign in again');
                }
            }
        }

        function isTokenValid() {
            const storedExpiry = sessionStorage.getItem('google_token_expiry');
            if (!storedExpiry) return false;
            
            const expiryTime = parseInt(storedExpiry);
            const now = Date.now();
            
            return now < expiryTime;
        }

        function clearSession() {
            sessionStorage.removeItem('google_access_token');
            sessionStorage.removeItem('google_token_expiry');
            sessionStorage.removeItem('google_user_name');
            accessToken = null;
            
            document.getElementById('authorizeBtn').style.display = 'flex';
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('updateBtn').disabled = true;
            document.getElementById('removeBtn').disabled = true;
            document.getElementById('userInfo').classList.remove('show');
        }
    </script>
</body>
</html>