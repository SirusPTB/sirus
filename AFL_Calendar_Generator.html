<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFL Games to Google Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1a1d35;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #2a2f4a;
        }

        .header {
            background: #001f3f;
            color: white;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 2px solid #003d7a;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 40px 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #2a2f4a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: #d1d5db;
        }

        .team-checkbox:hover {
            border-color: #001f3f;
            background: #e5e7eb;
        }

        .team-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .team-checkbox label {
            cursor: pointer;
            flex: 1;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1f2937;
        }

        .team-logo {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .team-checkbox input[type="checkbox"]:checked + label {
            font-weight: 600;
            color: #001f3f;
        }

        .select-all-btn {
            padding: 10px 20px;
            background: #2a2f4a;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.3s;
            margin-bottom: 15px;
        }

        .select-all-btn:hover {
            background: #3a3f5a;
        }

        .auth-section {
            margin-bottom: 20px;
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(66, 133, 244, 0.3);
            background: #357ae8;
        }

        .auth-btn:disabled {
            background: #2a2f4a;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            background: #001f3f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 31, 63, 0.5);
            background: #003d7a;
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn:disabled {
            background: #2a2f4a;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .status.loading {
            display: block;
            background: #1a3a52;
            color: #7dd3fc;
            border: 1px solid #2a5a7a;
        }

        .status.success {
            display: block;
            background: #1a3a2a;
            color: #86efac;
            border: 1px solid #2a5a3a;
        }

        .status.error {
            display: block;
            background: #3a1a1a;
            color: #fca5a5;
            border: 1px solid #5a2a2a;
        }

        .status.warning {
            display: block;
            background: #3a3a1a;
            color: #fef08a;
            border: 1px solid #5a5a2a;
        }

        .spinner {
            border: 3px solid #2a2f4a;
            border-top: 3px solid #001f3f;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #0f1a2a;
            border-left: 4px solid #001f3f;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #94a3b8;
            line-height: 1.6;
        }

        .info-box.error-details {
            border-left-color: #dc2626;
            background: #2a1a1a;
        }

        .info-box.error-details p {
            color: #fca5a5;
        }

        .info-box.error-details a {
            color: #7dd3fc;
            text-decoration: underline;
        }

        .user-info {
            display: none;
            align-items: center;
            justify-content: space-between;
            background: #0f1a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #2a2f4a;
        }

        .user-info.show {
            display: flex;
        }

        .user-email {
            color: #7dd3fc;
            font-weight: 500;
        }

        .signout-btn {
            padding: 8px 16px;
            background: #2a2f4a;
            color: #e2e8f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .signout-btn:hover {
            background: #3a3f5a;
        }

        .option-section {
            margin-bottom: 20px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #0f1a2a;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .checkbox-option input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .checkbox-option label {
            color: #94a3b8;
            cursor: pointer;
            user-select: none;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .secondary-btn {
            padding: 14px;
            background: #2a2f4a;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            background: #3a3f5a;
            transform: translateY(-2px);
        }

        .secondary-btn:disabled {
            background: #1a1d2a;
            color: #4a4f6a;
            cursor: not-allowed;
            transform: none;
        }

        .troubleshoot-section {
            margin-top: 20px;
            padding: 15px;
            background: #0f1a2a;
            border-radius: 8px;
            border: 1px solid #2a2f4a;
        }

        .troubleshoot-section h3 {
            color: #7dd3fc;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .troubleshoot-section ul {
            color: #94a3b8;
            margin-left: 20px;
        }

        .troubleshoot-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .troubleshoot-section code {
            background: #1a1d35;
            padding: 2px 6px;
            border-radius: 3px;
            color: #fca5a5;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèà AFL to Google Calendar</h1>
            <p>Add AFL fixtures to your calendar with one click</p>
        </div>

        <div class="content">
            <!-- Auth Section -->
            <div id="authSection" class="auth-section">
                <div class="info-box">
                    <p>üîê Sign in with your Google account to add games directly to Google Calendar, or download an ICS file to import manually.</p>
                </div>
                <button id="authorizeBtn" class="auth-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z" fill="#4285F4"/>
                        <path d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z" fill="#34A853"/>
                        <path d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z" fill="#FBBC05"/>
                        <path d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>

            <!-- User Info -->
            <div id="userInfo" class="user-info">
                <div>
                    <span style="color: #94a3b8;">Signed in as:</span>
                    <span id="userEmail" class="user-email"></span>
                </div>
                <button id="signoutBtn" class="signout-btn">Sign Out</button>
            </div>

            <!-- Team Selection -->
            <div class="section">
                <div class="section-title">Select Teams</div>
                <button id="selectAllBtn" class="select-all-btn">Select All Teams</button>
                <div id="teamsContainer" class="teams-grid"></div>
            </div>

            <!-- Options -->
            <div class="option-section">
                <div class="section-title">Options</div>
                <div class="checkbox-option">
                    <input type="checkbox" id="allDayEventsCheckbox">
                    <label for="allDayEventsCheckbox">Create as all-day events (recommended for year view)</label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="generateBtn" class="generate-btn" disabled>
                    ‚ûï Add to Calendar
                </button>
                <button id="updateBtn" class="secondary-btn" disabled>
                    üîÑ Update Events
                </button>
                <button id="removeBtn" class="secondary-btn" disabled>
                    üóëÔ∏è Remove All
                </button>
                <button id="downloadBtn" class="secondary-btn">
                    üíæ Download ICS
                </button>
            </div>

            <!-- Status Message -->
            <div id="statusMsg" class="status"></div>

            <!-- Error Details -->
            <div id="errorDetails" class="info-box error-details" style="display: none;">
                <h3 style="color: #fca5a5; margin-bottom: 10px;">‚ùå Authorization Error</h3>
                <p id="errorMessage"></p>
            </div>

            <!-- Troubleshooting Guide -->
            <div id="troubleshootGuide" class="troubleshoot-section" style="display: none;">
                <h3>üîß Troubleshooting Steps</h3>
                <ul>
                    <li><strong>Clear your session:</strong> Click "Sign Out" above and sign in again</li>
                    <li><strong>Enable Calendar API:</strong> Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a> ‚Üí "APIs & Services" ‚Üí "Enabled APIs" and ensure "Google Calendar API" is enabled</li>
                    <li><strong>Check OAuth scopes:</strong> Your OAuth consent screen must include the calendar scope: <code>https://www.googleapis.com/auth/calendar.events</code></li>
                    <li><strong>Clear browser data:</strong> Open DevTools (F12) ‚Üí Application ‚Üí Clear localStorage/sessionStorage ‚Üí Refresh</li>
                    <li><strong>Re-authorize:</strong> You may need to revoke access at <a href="https://myaccount.google.com/permissions" target="_blank">Google Account Permissions</a> and sign in again</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // IMPORTANT: Replace with your own Client ID
        const CLIENT_ID = ''; // YOUR_CLIENT_ID_HERE.apps.googleusercontent.com
        
        // Required OAuth scopes with proper calendar access
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.email';
        
        const API_BASE = 'https://api.squiggle.com.au';
        const CURRENT_YEAR = 2026;

        let accessToken = null;
        let tokenClient = null;
        let teams = [];

        // AFL Teams data
        async function loadTeams() {
            try {
                const response = await fetch(`${API_BASE}/?q=teams`);
                const data = await response.json();
                teams = data.teams;
                renderTeams();
            } catch (error) {
                showStatus('error', 'Failed to load teams. Please refresh the page.');
            }
        }

        function renderTeams() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = teams.map(team => `
                <div class="team-checkbox">
                    <input type="checkbox" id="team-${team.id}" value="${team.id}" checked>
                    <label for="team-${team.id}">
                        <img src="${team.logo}" alt="${team.name}" class="team-logo" onerror="this.style.display='none'">
                        <span>${team.name}</span>
                    </label>
                </div>
            `).join('');
        }

        // Select All functionality
        document.getElementById('selectAllBtn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#teamsContainer input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            
            const btn = document.getElementById('selectAllBtn');
            btn.textContent = allChecked ? 'Select All Teams' : 'Deselect All Teams';
        });

        // Google OAuth initialization
        function initializeGoogleAuth() {
            if (!CLIENT_ID) {
                showStatus('error', 'Client ID not configured. Please add your Google OAuth Client ID to the code.');
                return;
            }

            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                    error_callback: handleAuthError
                });
                console.log('Google Auth initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Google Auth:', error);
                showStatus('error', 'Failed to initialize Google authentication. Please refresh the page.');
            }
        }

        function handleAuthCallback(response) {
            if (response.error) {
                handleAuthError(response);
                return;
            }

            accessToken = response.access_token;
            
            // Calculate expiry time (tokens typically expire in 3600 seconds)
            const expiresIn = response.expires_in || 3600;
            const expiryTime = Date.now() + (expiresIn * 1000);
            
            // Store in sessionStorage
            sessionStorage.setItem('google_access_token', accessToken);
            sessionStorage.setItem('google_token_expiry', expiryTime.toString());
            
            // Update UI
            document.getElementById('authorizeBtn').style.display = 'none';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('updateBtn').disabled = false;
            document.getElementById('removeBtn').disabled = false;
            
            // Get and display user info
            getUserInfo();
            
            // Hide error messages
            document.getElementById('errorDetails').style.display = 'none';
            document.getElementById('troubleshootGuide').style.display = 'none';
            
            showStatus('success', '‚úì Successfully signed in!');
        }

        function handleAuthError(error) {
            console.error('Auth error:', error);
            
            let errorMsg = 'Authentication failed. ';
            let showTroubleshoot = false;
            
            if (error.type === 'popup_closed') {
                errorMsg += 'The sign-in popup was closed before completing authentication.';
            } else if (error.type === 'access_denied') {
                errorMsg += 'Access was denied. Please grant calendar permissions to use this app.';
                showTroubleshoot = true;
            } else if (error.error === 'invalid_scope') {
                errorMsg += 'Invalid OAuth scope configuration. The calendar API scope may not be properly configured.';
                showTroubleshoot = true;
            } else {
                errorMsg += error.message || 'An unknown error occurred.';
                showTroubleshoot = true;
            }
            
            document.getElementById('errorMessage').textContent = errorMsg;
            document.getElementById('errorDetails').style.display = 'block';
            
            if (showTroubleshoot) {
                document.getElementById('troubleshootGuide').style.display = 'block';
            }
            
            showStatus('error', 'Authentication failed. See details below.');
            clearSession();
        }

        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const userInfo = await response.json();
                    document.getElementById('userEmail').textContent = userInfo.email || 'Unknown user';
                    document.getElementById('userInfo').classList.add('show');
                    
                    // Store user name
                    sessionStorage.setItem('google_user_name', userInfo.email);
                }
            } catch (error) {
                console.error('Failed to get user info:', error);
            }
        }

        // Event listeners
        document.getElementById('authorizeBtn').addEventListener('click', () => {
            if (tokenClient) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                showStatus('error', 'Authentication not initialized. Please refresh the page.');
            }
        });

        document.getElementById('signoutBtn').addEventListener('click', () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Token revoked');
                });
            }
            clearSession();
            showStatus('success', '‚úì Signed out successfully');
        });

        document.getElementById('generateBtn').addEventListener('click', addEventsToCalendar);
        document.getElementById('updateBtn').addEventListener('click', updateEvents);
        document.getElementById('removeBtn').addEventListener('click', removeAllAFLEvents);
        document.getElementById('downloadBtn').addEventListener('click', downloadICSFile);

        function getSelectedTeams() {
            const checkboxes = document.querySelectorAll('#teamsContainer input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => {
                const teamId = parseInt(cb.value);
                return teams.find(t => t.id === teamId);
            }).filter(Boolean);
        }

        async function addEventsToCalendar() {
            const selectedTeams = getSelectedTeams();
            
            if (selectedTeams.length === 0) {
                showStatus('error', 'Please select at least one team');
                return;
            }

            if (!isTokenValid()) {
                showStatus('error', 'Session expired. Please sign in again.');
                clearSession();
                return;
            }

            showStatus('loading', 'Fetching AFL fixtures...');

            try {
                const games = await fetchGames(CURRENT_YEAR, selectedTeams);
                
                if (games.length === 0) {
                    showStatus('warning', 'No games found for selected teams');
                    return;
                }

                showStatus('loading', `Adding ${games.length} games to calendar...`);

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                for (const game of games) {
                    try {
                        await addEventToCalendar(game, CURRENT_YEAR);
                        successCount++;
                    } catch (error) {
                        errorCount++;
                        errors.push({ game, error });
                        
                        // If we get a 403 or 401, show detailed error
                        if (error.message.includes('403') || error.message.includes('401')) {
                            handleCalendarPermissionError(error);
                            return;
                        }
                    }
                }

                if (errorCount === 0) {
                    showStatus('success', `‚úì Successfully added ${successCount} games to calendar!`);
                } else {
                    showStatus('warning', `Added ${successCount} games, but ${errorCount} failed. Check console for details.`);
                    console.error('Failed events:', errors);
                }

            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('403') || error.message.includes('401')) {
                    handleCalendarPermissionError(error);
                } else {
                    showStatus('error', 'Failed to fetch games. Please try again.');
                }
            }
        }

        function handleCalendarPermissionError(error) {
            const errorMsg = 'Cannot access Google Calendar. This usually means:\n\n' +
                            '1. The Calendar API is not enabled in your Google Cloud project\n' +
                            '2. The OAuth scope for calendar.events is missing\n' +
                            '3. Your access token has expired or been revoked\n\n' +
                            'Please follow the troubleshooting steps below.';
            
            document.getElementById('errorMessage').textContent = errorMsg;
            document.getElementById('errorDetails').style.display = 'block';
            document.getElementById('troubleshootGuide').style.display = 'block';
            
            showStatus('error', '‚ùå Calendar permission error. See troubleshooting guide below.');
            
            // Clear session to force re-auth
            clearSession();
        }

        async function updateEvents() {
            await removeAllAFLEvents();
            await addEventsToCalendar();
        }

        async function removeAllAFLEvents() {
            if (!isTokenValid()) {
                showStatus('error', 'Session expired. Please sign in again.');
                clearSession();
                return;
            }

            if (!confirm('This will remove all AFL events from your calendar. Continue?')) {
                return;
            }

            showStatus('loading', 'Fetching AFL events from calendar...');

            try {
                const events = await getAFLEventsFromCalendar();
                
                if (events.length === 0) {
                    showStatus('success', 'No AFL events found in calendar');
                    return;
                }

                showStatus('loading', `Removing ${events.length} events...`);

                let successCount = 0;
                let errorCount = 0;

                for (const event of events) {
                    try {
                        await deleteCalendarEvent(event.id);
                        successCount++;
                    } catch (error) {
                        errorCount++;
                        console.error('Failed to delete event:', event.id, error);
                        
                        if (error.message.includes('403') || error.message.includes('401')) {
                            handleCalendarPermissionError(error);
                            return;
                        }
                    }
                }

                if (errorCount === 0) {
                    showStatus('success', `‚úì Successfully removed ${successCount} events!`);
                } else {
                    showStatus('warning', `Removed ${successCount} events, but ${errorCount} failed.`);
                }

            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('403') || error.message.includes('401')) {
                    handleCalendarPermissionError(error);
                } else {
                    showStatus('error', 'Failed to remove events. Please try again.');
                }
            }
        }

        async function getAFLEventsFromCalendar() {
            const timeMin = `${CURRENT_YEAR}-01-01T00:00:00.000Z`;
            const timeMax = `${CURRENT_YEAR}-12-31T23:59:59.000Z`;
            
            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
                `timeMin=${timeMin}&timeMax=${timeMax}&q=vs&maxResults=250`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            return data.items || [];
        }

        async function deleteCalendarEvent(eventId) {
            const response = await fetch(
                `https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`,
                {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);
            }
        }

        async function downloadICSFile() {
            const selectedTeams = getSelectedTeams();
            
            if (selectedTeams.length === 0) {
                showStatus('error', 'Please select at least one team');
                return;
            }

            showStatus('loading', 'Generating ICS file...');

            try {
                const games = await fetchGames(CURRENT_YEAR, selectedTeams);
                
                if (games.length === 0) {
                    showStatus('error', 'No games found for selected teams');
                    return;
                }

                const icsContent = generateICS(games, CURRENT_YEAR);
                downloadICS(icsContent, `AFL_${CURRENT_YEAR}_Calendar.ics`);

                showStatus('success', `‚úì Downloaded ICS file with ${games.length} games!`);

            } catch (error) {
                console.error('Error:', error);
                showStatus('error', 'Failed to generate ICS file. Please try again.');
            }
        }

        async function fetchGames(year, selectedTeams) {
            const response = await fetch(`${API_BASE}/?q=games;year=${year}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Filter games by selected teams
            let games = data.games;
            if (selectedTeams.length < teams.length) {
                const selectedTeamIds = selectedTeams.map(t => parseInt(t.id));
                games = games.filter(game => 
                    selectedTeamIds.includes(game.hteamid) || selectedTeamIds.includes(game.ateamid)
                );
            }

            return games;
        }

        async function addEventToCalendar(game, year) {
            const gameDate = new Date(game.date);
            const endDate = new Date(gameDate.getTime() + 3 * 60 * 60 * 1000); // 3 hours later

            // Use timezone from API if available, otherwise default to AEDT/AEST based on date
            let timezone = game.tz || 'AEDT';
            // Normalize timezone format (API might return +11:00 format)
            if (timezone.includes('+')) {
                const month = gameDate.getMonth();
                const isDST = month >= 9 || month <= 2;
                timezone = isDST ? 'AEDT' : 'AEST';
            }

            // Check if user wants all-day events
            const allDay = document.getElementById('allDayEventsCheckbox').checked;

            const event = {
                summary: allDay ? `${game.hteam} vs ${game.ateam}` : `${game.hteam} vs ${game.ateam} (${timezone})`,
                location: game.venue || 'TBA',
                description: `AFL ${year} - ${game.round ? `Round ${game.round}` : 'TBA'}\nHome: ${game.hteam}\nAway: ${game.ateam}${game.venue ? `\nVenue: ${game.venue}` : ''}`,
                colorId: '9' // Blue color for AFL games
            };

            if (allDay) {
                // All-day event (shows in year view)
                const dateStr = gameDate.toISOString().split('T')[0];
                event.start = { date: dateStr };
                event.end = { date: dateStr };
            } else {
                // Timed event
                event.start = {
                    dateTime: gameDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                };
                event.end = {
                    dateTime: endDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                };
            }

            const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(event)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);
            }

            return await response.json();
        }

        function generateICS(games, year) {
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//AFL Calendar Generator//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:AFL ${year} Season
X-WR-TIMEZONE:Australia/Melbourne
X-WR-CALDESC:AFL ${year} Season Fixtures
`;

            games.forEach(game => {
                if (!game.date) return;

                const gameDate = new Date(game.date);
                const dtstart = formatICSDate(gameDate);
                
                // Add 3 hours for game duration (typical AFL game length)
                const endDate = new Date(gameDate.getTime() + 3 * 60 * 60 * 1000);
                const dtend = formatICSDate(endDate);

                const summary = `${game.hteam} vs ${game.ateam}`;
                const location = game.venue || 'TBA';
                const roundName = game.round ? `Round ${game.round}` : 'TBA';
                
                let description = `AFL ${year} - ${roundName}\\n`;
                description += `Home: ${game.hteam}\\n`;
                description += `Away: ${game.ateam}\\n`;
                if (game.venue) description += `Venue: ${game.venue}\\n`;

                ics += `BEGIN:VEVENT
UID:afl-${game.id}@squiggle.com.au
DTSTAMP:${timestamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${summary}
LOCATION:${location}
DESCRIPTION:${description}
STATUS:CONFIRMED
TRANSP:TRANSPARENT
END:VEVENT
`;
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        function formatICSDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
        }

        function downloadICS(content, filename) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMsg');
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'loading') {
                statusEl.innerHTML = `<div class="spinner"></div>${message}`;
            } else {
                statusEl.textContent = message;
            }

            if (type === 'success' || type === 'error' || type === 'warning') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 8000);
            }
        }

        // Initialize on page load
        window.onload = () => {
            loadTeams();
            // Delay initialization to ensure Google script is loaded
            setTimeout(initializeGoogleAuth, 1000);
            
            // Try to restore previous session
            restoreSession();
        };

        function restoreSession() {
            const storedToken = sessionStorage.getItem('google_access_token');
            const storedExpiry = sessionStorage.getItem('google_token_expiry');
            const storedUserName = sessionStorage.getItem('google_user_name');
            
            // Check if we have a stored token and it hasn't expired
            if (storedToken && storedExpiry) {
                const expiryTime = parseInt(storedExpiry);
                const now = Date.now();
                
                if (now < expiryTime) {
                    // Token is still valid
                    accessToken = storedToken;
                    
                    // Restore UI state
                    document.getElementById('authorizeBtn').style.display = 'none';
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('updateBtn').disabled = false;
                    document.getElementById('removeBtn').disabled = false;
                    
                    // Restore user info if available
                    if (storedUserName) {
                        document.getElementById('userEmail').textContent = storedUserName;
                        document.getElementById('userInfo').classList.add('show');
                    } else {
                        // Try to fetch user info again
                        getUserInfo();
                    }
                    
                    console.log('Session restored successfully');
                } else {
                    // Token expired, clear storage
                    clearSession();
                    console.log('Session expired, please sign in again');
                    showStatus('warning', 'Your session expired. Please sign in again.');
                }
            }
        }

        function isTokenValid() {
            const storedExpiry = sessionStorage.getItem('google_token_expiry');
            if (!storedExpiry) return false;
            
            const expiryTime = parseInt(storedExpiry);
            const now = Date.now();
            
            return now < expiryTime;
        }

        function clearSession() {
            sessionStorage.removeItem('google_access_token');
            sessionStorage.removeItem('google_token_expiry');
            sessionStorage.removeItem('google_user_name');
            accessToken = null;
            
            document.getElementById('authorizeBtn').style.display = 'flex';
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('updateBtn').disabled = true;
            document.getElementById('removeBtn').disabled = true;
            document.getElementById('userInfo').classList.remove('show');
        }
    </script>
</body>
</html>
