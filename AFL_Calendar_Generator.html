<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFL Games to Google Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1a1d35;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #2a2f4a;
        }

        .header {
            background: #001f3f;
            color: white;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 2px solid #003d7a;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 40px 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .year-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .year-selector select {
            flex: 1;
            padding: 12px;
            border: 2px solid #2a2f4a;
            border-radius: 8px;
            font-size: 1rem;
            background: #0f1229;
            color: #e2e8f0;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .year-selector select:hover {
            border-color: #001f3f;
        }

        .year-selector select:focus {
            outline: none;
            border-color: #001f3f;
            box-shadow: 0 0 0 3px rgba(0, 31, 63, 0.3);
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .team-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #2a2f4a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: #0f1229;
        }

        .team-checkbox:hover {
            border-color: #001f3f;
            background: #1a1d35;
        }

        .team-checkbox input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .team-checkbox label {
            cursor: pointer;
            flex: 1;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cbd5e0;
        }

        .team-logo {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .team-checkbox input[type="checkbox"]:checked + label {
            font-weight: 600;
            color: #5fa3d0;
        }

        .select-all-btn {
            padding: 10px 20px;
            background: #2a2f4a;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.3s;
            margin-bottom: 15px;
        }

        .select-all-btn:hover {
            background: #3a3f5a;
        }

        .auth-section {
            margin-bottom: 20px;
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(66, 133, 244, 0.3);
            background: #357ae8;
        }

        .auth-btn:disabled {
            background: #2a2f4a;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            background: #001f3f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 31, 63, 0.5);
            background: #003d7a;
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn:disabled {
            background: #2a2f4a;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .status.loading {
            display: block;
            background: #1a3a52;
            color: #7dd3fc;
            border: 1px solid #2a5a7a;
        }

        .status.success {
            display: block;
            background: #1a3a2a;
            color: #86efac;
            border: 1px solid #2a5a3a;
        }

        .status.error {
            display: block;
            background: #3a1a1a;
            color: #fca5a5;
            border: 1px solid #5a2a2a;
        }

        .spinner {
            border: 3px solid #2a2f4a;
            border-top: 3px solid #001f3f;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #0f1a2a;
            border-left: 4px solid #001f3f;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #94a3b8;
            line-height: 1.6;
        }

        .warning-box {
            background: #3a2a1a;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .warning-box p {
            color: #fbbf24;
            line-height: 1.6;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 8px;
        }

        .warning-box ol {
            margin-left: 20px;
            margin-top: 10px;
        }

        .warning-box li {
            margin-bottom: 8px;
        }

        .warning-box code {
            background: #1a1d35;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            color: #86efac;
        }

        .user-info {
            display: none;
            background: #0f1a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #2a2f4a;
        }

        .user-info.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #94a3b8;
        }

        .signout-btn {
            padding: 8px 16px;
            background: transparent;
            color: #fca5a5;
            border: 1px solid #5a2a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .signout-btn:hover {
            background: #3a1a1a;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2a2f4a;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.show {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: #001f3f;
            width: 0%;
            transition: width 0.3s;
        }

        .download-option {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #2a2f4a;
        }

        .download-option p {
            color: #94a3b8;
            margin-bottom: 15px;
        }

        .download-btn {
            padding: 12px 24px;
            background: #2a2f4a;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
        }

        .download-btn:hover {
            background: #3a7a4a;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(42, 90, 58, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="48" height="48" viewBox="0 0 48 48" style="display: inline-block; vertical-align: middle; margin-right: 10px;">
                    <ellipse cx="24" cy="24" rx="18" ry="24" fill="#8B4513" stroke="#654321" stroke-width="2"/>
                    <path d="M 12 24 Q 24 20 36 24" fill="none" stroke="#FFF" stroke-width="2.5"/>
                    <path d="M 13 28 Q 24 25 35 28" fill="none" stroke="#FFF" stroke-width="2.5"/>
                    <path d="M 13 20 Q 24 23 35 20" fill="none" stroke="#FFF" stroke-width="2.5"/>
                    <line x1="24" y1="6" x2="24" y2="42" stroke="#FFF" stroke-width="2.5"/>
                </svg>
                AFL to Google Calendar
            </h1>
            <p>Add AFL fixtures directly to your Google Calendar</p>
        </div>

        <div class="content">
            <div class="warning-box">
                <p><strong>‚ö†Ô∏è Google Calendar Setup Required</strong></p>
                <p>The Google Calendar API integration requires additional setup. Choose one of these options:</p>
                
                <p><strong>Option 1: Add Test Users (Recommended)</strong></p>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank" style="color: #86efac;">Google Cloud OAuth Consent Screen</a></li>
                    <li>Select your project: <code>glass-memento-487401-n2</code></li>
                    <li>Scroll down to "Test users" section</li>
                    <li>Click "Add Users"</li>
                    <li>Add your email: <code><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a9dac0c4c6c787ceccccc5c6c7cee9cec4c8c0c587cac6c4">[email&#160;protected]</a></code></li>
                    <li>Save and refresh this page</li>
                </ol>

                <p><strong>Option 2: Publish Your App (For Public Use)</strong></p>
                <ol>
                    <li>Go to OAuth consent screen</li>
                    <li>Click "Publish App"</li>
                    <li>Note: May require Google verification for sensitive scopes</li>
                </ol>

                <p><strong>Option 3: Use ICS Download (Works Now!)</strong></p>
                <p>Scroll down and use the "Download ICS File" button - no setup required!</p>
            </div>

            <div class="info-box">
                <p><strong>Quick Start:</strong> Select a year and teams below, then use "Download ICS File" to get a calendar file you can import into Google Calendar, Apple Calendar, Outlook, or any calendar app. No sign-in required!</p>
            </div>

            <div class="section">
                <div class="section-title">Select Season</div>
                <div class="year-selector">
                    <select id="yearSelect">
                        <option value="2025">2025 Season</option>
                        <option value="2024">2024 Season</option>
                        <option value="2023">2023 Season</option>
                        <option value="2022">2022 Season</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Select Teams</div>
                <button class="select-all-btn" id="selectAllBtn">Select All Teams</button>
                <div class="teams-grid" id="teamsContainer">
                    <div class="status loading">
                        <div class="spinner"></div>
                        Loading teams...
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üì• Download Calendar File</div>
                <button class="download-btn" id="downloadBtn" disabled style="width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 600; background: #2a5a3a; color: #86efac; border: 2px solid #3a7a4a;">Download ICS File</button>
                <p style="text-align: center; color: #94a3b8; margin-top: 10px; font-size: 0.9rem;">Works with Google Calendar, Apple Calendar, Outlook, and more</p>
            </div>

            <div style="text-align: center; margin: 30px 0; color: #4a5568; font-weight: 600;">
                ‚Äî OR ‚Äî
            </div>

            <div class="section">
                <div class="section-title">üîó Direct Google Calendar Integration</div>
                <div class="user-info" id="userInfo">
                    <div class="user-details">
                        <span>‚úì Signed in as <strong id="userEmail"></strong></span>
                    </div>
                    <button class="signout-btn" id="signoutBtn">Sign Out</button>
                </div>

                <div class="auth-section">
                    <button class="auth-btn" id="authorizeBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                </div>

                <button class="generate-btn" id="generateBtn" disabled>Add to Google Calendar</button>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="status" id="statusMsg"></div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const API_BASE = 'https://api.squiggle.com.au';
        const CLIENT_ID = '1017993533846-vddmd49lpivato6chlv2kk7nol2u3srf.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        
        let teams = [];
        let allTeamsSelected = false;
        let tokenClient;
        let accessToken = null;

        // Initialize Google Identity Services
        function initializeGoogleAuth() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthCallback,
                });
            } catch (error) {
                console.error('Failed to initialize Google Auth:', error);
            }
        }

        function handleAuthCallback(response) {
            if (response.error !== undefined) {
                showStatus('error', 'Authorization failed: ' + response.error);
                return;
            }
            
            accessToken = response.access_token;
            document.getElementById('authorizeBtn').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
            
            // Get user info
            getUserInfo();
        }

        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const data = await response.json();
                document.getElementById('userEmail').textContent = data.email;
                document.getElementById('userInfo').classList.add('show');
            } catch (error) {
                console.error('Error getting user info:', error);
            }
        }

        document.getElementById('authorizeBtn').addEventListener('click', () => {
            if (!tokenClient) {
                initializeGoogleAuth();
                setTimeout(() => {
                    if (tokenClient) {
                        tokenClient.requestAccessToken({ prompt: 'consent' });
                    }
                }, 100);
            } else {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        });

        document.getElementById('signoutBtn').addEventListener('click', () => {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
            }
            accessToken = null;
            document.getElementById('authorizeBtn').style.display = 'flex';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('userInfo').classList.remove('show');
        });

        // Load teams on page load
        async function loadTeams() {
            try {
                const response = await fetch(`${API_BASE}/?q=teams`);
                const data = await response.json();
                teams = data.teams;
                renderTeams();
            } catch (error) {
                showStatus('error', 'Failed to load teams. Please refresh the page.');
            }
        }

        function renderTeams() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = teams.map(team => {
                // Construct absolute logo URL
                const logoUrl = team.logo.startsWith('http') 
                    ? team.logo 
                    : `https://squiggle.com.au/${team.logo}`;
                
                return `
                    <div class="team-checkbox">
                        <input type="checkbox" id="team-${team.id}" value="${team.id}" data-name="${team.name}">
                        <label for="team-${team.id}">
                            <img src="${logoUrl}" alt="${team.name}" class="team-logo" onerror="this.style.display='none'">
                            ${team.name}
                        </label>
                    </div>
                `;
            }).join('');

            // Enable download button when teams are loaded
            document.getElementById('downloadBtn').disabled = false;

            // Add event listeners to checkboxes
            document.querySelectorAll('.team-checkbox input').forEach(cb => {
                cb.addEventListener('change', updateSelectAllButton);
            });
        }

        function updateSelectAllButton() {
            const checkboxes = document.querySelectorAll('.team-checkbox input');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (allChecked) {
                selectAllBtn.textContent = 'Deselect All Teams';
                allTeamsSelected = true;
            } else {
                selectAllBtn.textContent = 'Select All Teams';
                allTeamsSelected = false;
            }
        }

        document.getElementById('selectAllBtn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.team-checkbox input');
            checkboxes.forEach(cb => {
                cb.checked = !allTeamsSelected;
            });
            updateSelectAllButton();
        });

        document.getElementById('generateBtn').addEventListener('click', addToGoogleCalendar);
        document.getElementById('downloadBtn').addEventListener('click', downloadICSFile);

        async function addToGoogleCalendar() {
            if (!accessToken) {
                showStatus('error', 'Please sign in with Google first.');
                return;
            }

            const year = document.getElementById('yearSelect').value;
            const selectedTeams = Array.from(document.querySelectorAll('.team-checkbox input:checked'))
                .map(cb => ({ id: cb.value, name: cb.dataset.name }));

            if (selectedTeams.length === 0) {
                showStatus('error', 'Please select at least one team.');
                return;
            }

            showStatus('loading', 'Fetching games from Squiggle API...');
            document.getElementById('generateBtn').disabled = true;

            try {
                const games = await fetchGames(year, selectedTeams);

                if (games.length === 0) {
                    showStatus('error', 'No games found for the selected teams and year.');
                    document.getElementById('generateBtn').disabled = !accessToken;
                    return;
                }

                showStatus('loading', `Adding ${games.length} games to your Google Calendar...`);
                document.getElementById('progressBar').classList.add('show');

                // Add events to Google Calendar
                let addedCount = 0;
                let failedCount = 0;

                for (let i = 0; i < games.length; i++) {
                    const game = games[i];
                    if (!game.date) continue;

                    try {
                        await addEventToCalendar(game, year);
                        addedCount++;
                    } catch (error) {
                        console.error('Failed to add game:', game, error);
                        failedCount++;
                    }

                    // Update progress
                    const progress = ((i + 1) / games.length) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';

                    // Rate limiting - wait 100ms between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                document.getElementById('progressBar').classList.remove('show');
                document.getElementById('progressFill').style.width = '0%';

                if (addedCount > 0) {
                    showStatus('success', `‚úì Successfully added ${addedCount} games to your Google Calendar!${failedCount > 0 ? ` (${failedCount} failed)` : ''}`);
                } else {
                    showStatus('error', 'Failed to add games to calendar. Please try again.');
                }

                document.getElementById('generateBtn').disabled = !accessToken;

            } catch (error) {
                document.getElementById('progressBar').classList.remove('show');
                showStatus('error', 'Failed to fetch games. Please try again.');
                document.getElementById('generateBtn').disabled = !accessToken;
            }
        }

        async function downloadICSFile() {
            const year = document.getElementById('yearSelect').value;
            const selectedTeams = Array.from(document.querySelectorAll('.team-checkbox input:checked'))
                .map(cb => ({ id: cb.value, name: cb.dataset.name }));

            if (selectedTeams.length === 0) {
                showStatus('error', 'Please select at least one team.');
                return;
            }

            showStatus('loading', 'Generating ICS file...');

            try {
                const games = await fetchGames(year, selectedTeams);

                if (games.length === 0) {
                    showStatus('error', 'No games found for the selected teams and year.');
                    return;
                }

                const icsContent = generateICS(games, year);
                downloadICS(icsContent, `AFL_${year}_Calendar.ics`);

                showStatus('success', `‚úì Downloaded ICS file with ${games.length} games!`);

            } catch (error) {
                showStatus('error', 'Failed to generate ICS file. Please try again.');
            }
        }

        async function fetchGames(year, selectedTeams) {
            const response = await fetch(`${API_BASE}/?q=games;year=${year}`);
            const data = await response.json();
            
            // Filter games by selected teams
            let games = data.games;
            if (selectedTeams.length < teams.length) {
                const selectedTeamIds = selectedTeams.map(t => parseInt(t.id));
                games = games.filter(game => 
                    selectedTeamIds.includes(game.hteamid) || selectedTeamIds.includes(game.ateamid)
                );
            }

            return games;
        }

        async function addEventToCalendar(game, year) {
            const gameDate = new Date(game.date);
            const endDate = new Date(gameDate.getTime() + 3 * 60 * 60 * 1000); // 3 hours later

            const event = {
                summary: `${game.hteam} vs ${game.ateam}`,
                location: game.venue || 'TBA',
                description: `AFL ${year} - ${game.round ? `Round ${game.round}` : 'TBA'}\nHome: ${game.hteam}\nAway: ${game.ateam}${game.venue ? `\nVenue: ${game.venue}` : ''}`,
                start: {
                    dateTime: gameDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                },
                end: {
                    dateTime: endDate.toISOString(),
                    timeZone: 'Australia/Melbourne'
                },
                colorId: '5' // Yellow color for AFL games
            };

            const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(event)
            });

            if (!response.ok) {
                throw new Error('Failed to add event');
            }

            return await response.json();
        }

        function generateICS(games, year) {
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//AFL Calendar Generator//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:AFL ${year} Season
X-WR-TIMEZONE:Australia/Melbourne
X-WR-CALDESC:AFL ${year} Season Fixtures
`;

            games.forEach(game => {
                if (!game.date) return;

                const gameDate = new Date(game.date);
                const dtstart = formatICSDate(gameDate);
                
                // Add 3 hours for game duration (typical AFL game length)
                const endDate = new Date(gameDate.getTime() + 3 * 60 * 60 * 1000);
                const dtend = formatICSDate(endDate);

                const summary = `${game.hteam} vs ${game.ateam}`;
                const location = game.venue || 'TBA';
                const roundName = game.round ? `Round ${game.round}` : 'TBA';
                
                let description = `AFL ${year} - ${roundName}\\n`;
                description += `Home: ${game.hteam}\\n`;
                description += `Away: ${game.ateam}\\n`;
                if (game.venue) description += `Venue: ${game.venue}\\n`;

                ics += `BEGIN:VEVENT
UID:afl-${game.id}@squiggle.com.au
DTSTAMP:${timestamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${summary}
LOCATION:${location}
DESCRIPTION:${description}
STATUS:CONFIRMED
TRANSP:TRANSPARENT
END:VEVENT
`;
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        function formatICSDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
        }

        function downloadICS(content, filename) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMsg');
            statusEl.className = `status ${type}`;
            
            if (type === 'loading') {
                statusEl.innerHTML = `<div class="spinner"></div>${message}`;
            } else {
                statusEl.textContent = message;
            }

            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 8000);
            }
        }

        // Initialize on page load
        window.onload = () => {
            loadTeams();
            // Delay initialization to ensure Google script is loaded
            setTimeout(initializeGoogleAuth, 1000);
        };
    </script>
</body>
</html>
