<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SirusPTB SPA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #121212;
  color: #e0e0e0;
  text-align: center;
}
header {
  padding: 10px;
  font-size: 1.4em;
  font-weight: bold;
}
.canvas-container {
  width: 90%;
  margin: 10px auto;
  height: 300px;
}
canvas {
  width: 100% !important;
  height: 100% !important;
  background: #1e1e1e;
  border-radius: 8px;
}
.button-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin: 10px 0 30px;
}
button {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  cursor: pointer;
  color: white;
  background-color: #333;
}
#connectButton.connecting { background-color: orange; }
#connectButton.connected { background-color: green; }
#connectButton.disconnected { background-color: red; }
#resetButton, #toggleViewButton { background-color: #222; }
#saveButton { background-color: blue; }

/* Toggle Switch Styles */
.toggle-container {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.toggle-switch {
  position: relative;
  width: 60px;
  height: 30px;
  background-color: #555;
  border-radius: 15px;
  cursor: pointer;
  transition: background-color 0.3s;
}

/* Disabled state for toggles */
.toggle-switch.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Temperature toggle - dull red for both positions */
#tempToggle {
  background-color: #8B3A3A;
}

#tempToggle.active {
  background-color: #8B3A3A;
}

/* Pressure toggle - dull blue for both positions */
#pressureToggle {
  background-color: #4682B4;
}

#pressureToggle.active {
  background-color: #5F9EA0;
}

.toggle-slider {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 24px;
  height: 24px;
  background-color: white;
  border-radius: 50%;
  transition: transform 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  color: #333;
}

.toggle-switch.active .toggle-slider {
  transform: translateX(30px);
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0; top: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center; align-items: center;
}
.modal-content {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  text-align: center;
}
.modal select {
  width: 80%;
  padding: 8px;
  margin: 10px 0;
  border-radius: 6px;
  background: #333;
  color: #fff;
  border: none;
}
.modal button { margin: 5px; }

/* Settings page */
#settingsPage { display: none; text-align: left; padding: 20px; }
#settingsPage h2 { text-align: center; }
#settingsPage label { display: block; margin: 10px 0 5px; }
#settingsPage input, #settingsPage select { width: 100%; padding: 5px; border-radius: 5px; margin-bottom: 15px; background:#333; color:#fff; border:none; }
#settingsPage button { background-color: #444; margin-top: 20px; }
</style>
</head>
<body>
<header>SirusPTB SPA</header>

<!-- Graphs Page -->
<div id="graphPage">
  <div class="button-row">
    <button id="connectButton" class="disconnected">Connect</button>
    <div class="toggle-container">
      <span>°C/°F:</span>
      <div id="tempToggle" class="toggle-switch">
        <div class="toggle-slider">C</div>
      </div>
    </div>
    <div class="toggle-container">
      <span>Bar/PSI:</span>
      <div id="pressureToggle" class="toggle-switch">
        <div class="toggle-slider">Bar</div>
      </div>
    </div>
  </div>

  <div id="rawDataDisplay" style="background: #1e1e1e; color: #00ff00; padding: 10px; margin: 10px auto; width: 90%; border-radius: 8px; font-family: monospace; text-align: left; min-height: 20px;">
    No data sent yet...
  </div>

  <div id="splitView" style="display:flex; flex-direction:column; width:100%; align-items:center;">
    <div class="canvas-container"><canvas id="tempChart"></canvas></div>
    <div class="canvas-container"><canvas id="pressureChart"></canvas></div>
  </div>

  <div id="combinedView" style="display:none; width:100%; align-items:center;">
    <div class="canvas-container"><canvas id="combinedChart"></canvas></div>
  </div>

  <div class="button-row">
    <button id="pauseResumeButton">Pause</button>
    <button id="toggleViewButton">Toggle View</button>
    <button id="resetButton">Reset</button>
  </div>

  <div class="button-row">
    <button id="saveButton">Save</button>
    <button id="loadButton">Load</button>
    <button id="deleteButton">Delete</button>
    <button id="settingsButton">Settings</button>
  </div>
</div>

<!-- Settings Page -->
<div id="settingsPage">
  <h2>Settings</h2>
  <label for="tempColor">Temperature Line Color</label>
  <input type="color" id="tempColor" value="#ff7f7f">

  <label for="pressureColor">Pressure Line Color</label>
  <input type="color" id="pressureColor" value="#7fbfff">

  <label for="maxPoints">Max Points on Chart</label>
  <input type="number" id="maxPoints" value="50" min="10" max="500">

  <label>
    <input type="checkbox" id="autoRefresh" checked> Auto Refresh Graph
  </label>

  <button id="applySettings">Apply Settings</button>
  <button id="backButton">Back to Graphs</button>
</div>

<!-- Modal -->
<div id="popupModal" class="modal">
  <div class="modal-content">
    <h3>Select Saved Graph</h3>
    <select id="modalSelect"></select>
    <div>
      <button id="confirmButton">Confirm</button>
      <button id="cancelButton">Cancel</button>
    </div>
  </div>
</div>

<script>
// --- BLE Variables ---
const serviceUuid = "0000ffe1-0000-1000-8000-00805f9b34fb";
const characteristicUuid = "0000ffe3-0000-1000-8000-00805f9b34fb";
const writeCharacteristicUuid = "0000ffe2-0000-1000-8000-00805f9b34fb"; // Common write characteristic
let device, characteristic, writeCharacteristic;
let tempChart, pressureChart, combinedChart;
let paused = false;
let currentTemp = 0, currentPressure = 0;
let splitView = true;
let secondsCounter = 0;
let chartData = { labels: [], temp: [], pressure: [] };
let modalAction = "";
let maxPointsValue = 50;
let currentTempUnit = "C"; // Track current temperature unit
let currentPressureUnit = "Bar"; // Track current pressure unit
let tempToggleActive = false; // Track temperature toggle switch state
let pressureToggleActive = false; // Track pressure toggle switch state

// --- SPA Navigation ---
const graphPage = document.getElementById("graphPage");
const settingsPage = document.getElementById("settingsPage");

document.getElementById("settingsButton").onclick = () => {
  graphPage.style.display = "none";
  settingsPage.style.display = "block";
};

document.getElementById("backButton").onclick = () => {
  settingsPage.style.display = "none";
  graphPage.style.display = "block";
};

// --- Modal ---
const modal = document.getElementById("popupModal");
const modalSelect = document.getElementById("modalSelect");
const confirmButton = document.getElementById("confirmButton");
const cancelButton = document.getElementById("cancelButton");

function showModal(action){
  modalAction = action;
  modalSelect.innerHTML="";
  const saved = Object.keys(localStorage).filter(k=>k.startsWith("graph_"));
  if(saved.length===0){ alert("No saved graphs"); return; }
  saved.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.text = k.replace("graph_","");
    modalSelect.add(opt);
  });
  modal.style.display="flex";
}

confirmButton.onclick = () => {
  const key = modalSelect.value;
  if(!key){ modal.style.display="none"; return; }
  if(modalAction==="load"){
    const data = JSON.parse(localStorage.getItem(key));
    if(data){
      chartData = data; secondsCounter=data.labels.length;
      
      // Update temperature chart
      tempChart.data.labels=chartData.labels;
      tempChart.data.datasets[0].data=chartData.temp;
      tempChart.update();
      
      // Update pressure chart
      pressureChart.data.labels=chartData.labels;
      pressureChart.data.datasets[0].data=chartData.pressure;
      pressureChart.update();
      
      // Update combined chart
      combinedChart.data.labels=chartData.labels;
      combinedChart.data.datasets[0].data=chartData.temp;
      combinedChart.data.datasets[1].data=chartData.pressure;
      combinedChart.update();
    }
  } else if(modalAction==="delete"){
    localStorage.removeItem(key);
  }
  modal.style.display="none";
};

cancelButton.onclick = () => { modal.style.display="none"; };

// --- Chart Setup ---
function fixCanvasDPI(canvas) {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

const currentValuePlugin = {
  id:'currentValue',
  afterDraw(chart){
    if(chart.data.datasets.length===0) return;
    const ctx = chart.ctx;
    chart.data.datasets.forEach((ds,i)=>{
      if(ds.data.length===0) return;
      const latest = ds.data[ds.data.length-1];
      const x = chart.chartArea.left + 5;
      ctx.save();
      ctx.fillStyle = ds.borderColor;
      ctx.font = "bold 14px Arial";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      let unit = "";
      if(ds.label.includes("Temp")){
        unit = ds.label.includes("°F") ? "°F" : "°C";
      } else if(ds.label.includes("Pressure")){
        unit = ds.label.includes("PSI") ? " PSI" : " bar";
      }
      ctx.fillText(ds.label + ": " + latest.toFixed(2) + unit, x, 5 + i*18);
      ctx.restore();
    });
  }
};

function initCharts(){
  const ctxTemp = document.getElementById("tempChart").getContext("2d");
  fixCanvasDPI(ctxTemp.canvas);
  tempChart = new Chart(ctxTemp,{
    type:"line",
    data:{labels:[],datasets:[{label:"Temp",borderColor:"#ff7f7f",data:[],fill:false}]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      animation:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{display:true,title:{display:true,text:'Time(sec)'},ticks:{color:'#e0e0e0'}},
        y:{display:true,title:{display:true,text:'Temperature (°C)'},ticks:{color:"#ff7f7f"}}
      }
    },
    plugins:[currentValuePlugin]
  });

  const ctxPressure = document.getElementById("pressureChart").getContext("2d");
  fixCanvasDPI(ctxPressure.canvas);
  pressureChart = new Chart(ctxPressure,{
    type:"line",
    data:{labels:[],datasets:[{label:"Pressure",borderColor:"#7fbfff",data:[],fill:false}]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      animation:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{display:true,title:{display:true,text:'Time(sec)'},ticks:{color:'#e0e0e0'}},
        y:{display:true,title:{display:true,text:'Pressure (bar)'},ticks:{color:"#7fbfff"}}
      }
    },
    plugins:[currentValuePlugin]
  });

  const ctxCombined = document.getElementById("combinedChart").getContext("2d");
  fixCanvasDPI(ctxCombined.canvas);
  combinedChart = new Chart(ctxCombined,{
    type:"line",
    data:{labels:[],datasets:[
      {label:"Temp",borderColor:"#ff7f7f",data:[],fill:false,yAxisID:"y1"},
      {label:"Pressure",borderColor:"#7fbfff",data:[],fill:false,yAxisID:"y2"}
    ]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      animation:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{display:true,title:{display:true,text:'Time(sec)'},ticks:{color:'#e0e0e0'}},
        y1:{display:true,title:{display:false},ticks:{color:"#ff7f7f"}},
        y2:{display:true,title:{display:false},ticks:{color:"#7fbfff"}}
      }
    },
    plugins:[currentValuePlugin]
  });
}

initCharts();

// --- Helper function to update temperature toggle switch ---
function updateTempToggleSwitch(unit) {
  const toggle = document.getElementById("tempToggle");
  const slider = toggle.querySelector(".toggle-slider");
  
  currentTempUnit = unit;
  
  if (unit === "C") {
    toggle.classList.remove("active");
    slider.textContent = "C";
    tempToggleActive = false;
  } else if (unit === "F") {
    toggle.classList.add("active");
    slider.textContent = "F";
    tempToggleActive = true;
  } else {
    // Default to C
    toggle.classList.remove("active");
    slider.textContent = "C";
    tempToggleActive = false;
    currentTempUnit = "C";
  }
}

// --- Helper function to update pressure toggle switch ---
function updatePressureToggleSwitch(unit) {
  const toggle = document.getElementById("pressureToggle");
  const slider = toggle.querySelector(".toggle-slider");
  
  currentPressureUnit = unit;
  
  if (unit === "Bar") {
    toggle.classList.remove("active");
    slider.textContent = "Bar";
    pressureToggleActive = false;
  } else if (unit === "PSI") {
    toggle.classList.add("active");
    slider.textContent = "PSI";
    pressureToggleActive = true;
  } else {
    // Default to Bar
    toggle.classList.remove("active");
    slider.textContent = "Bar";
    pressureToggleActive = false;
    currentPressureUnit = "Bar";
  }
}

// --- Pressure conversion functions ---
function barToPsi(bar) {
  return bar * 14.5038; // 1 bar = 14.5038 PSI
}

function psiToBar(psi) {
  return psi / 14.5038;
}

// --- Buttons ---
document.getElementById("connectButton").onclick = async () => {
  const btn = document.getElementById("connectButton");
  try{
    btn.textContent="Connecting..."; btn.className="connecting";
    device = await navigator.bluetooth.requestDevice({filters:[{namePrefix:"SirusPTB"}],optionalServices:[serviceUuid]});
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(serviceUuid);
    
    // Get the read/notify characteristic
    characteristic = await service.getCharacteristic(characteristicUuid);
    console.log("Read characteristic properties:", characteristic.properties);
    
    // Try to get a separate write characteristic
    try {
      writeCharacteristic = await service.getCharacteristic(writeCharacteristicUuid);
      console.log("Write characteristic found with properties:", writeCharacteristic.properties);
    } catch(e) {
      console.log("Separate write characteristic not found, trying to use read characteristic for writing");
      
      // Check if the read characteristic supports writing
      if (characteristic.properties.write || characteristic.properties.writeWithoutResponse) {
        writeCharacteristic = characteristic;
        console.log("Using read characteristic for writing");
      } else {
        // List all available characteristics
        console.log("Listing all characteristics in service:");
        const characteristics = await service.getCharacteristics();
        for (const char of characteristics) {
          console.log(`Characteristic UUID: ${char.uuid}, Properties:`, char.properties);
          if (char.properties.write || char.properties.writeWithoutResponse) {
            writeCharacteristic = char;
            console.log("Found writable characteristic:", char.uuid);
            break;
          }
        }
      }
    }
    
    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged",handleData);

    btn.textContent="Disconnect"; btn.className="connected";
    updateConnectionState(true); // Enable toggles
    
    if (writeCharacteristic) {
      console.log("Connected successfully, write characteristic available");
    } else {
      console.log("Connected but no write characteristic found");
    }
    
    btn.onclick = async ()=>{
      if(characteristic) {
        try {
          await characteristic.stopNotifications();
        } catch(e) {
          console.log("Error stopping notifications:", e);
        }
      }
      if(device && device.gatt.connected) {
        try {
          await device.gatt.disconnect();
        } catch(e) {
          console.log("Error disconnecting:", e);
        }
      }
      btn.textContent="Connect"; btn.className="disconnected";
      updateConnectionState(false); // Disable toggles
      characteristic = null;
      writeCharacteristic = null;
      device = null;
      btn.onclick = document.getElementById("connectButton").onclick;
    }

    device.addEventListener("gattserverdisconnected",()=>{
      btn.textContent="Connect";
      btn.className="disconnected";
      updateConnectionState(false); // Disable toggles
      characteristic = null;
      writeCharacteristic = null;
      device = null;
      btn.onclick = document.getElementById("connectButton").onclick;
    });
  }catch(e){ 
    console.error("Connection error:", e); 
    btn.textContent="Connect"; 
    btn.className="disconnected";
    updateConnectionState(false); // Disable toggles
    characteristic = null;
    writeCharacteristic = null;
    device = null;
  }
};

// --- Send data function ---
async function sendData(command) {
  console.log("Attempting to send:", command);
  console.log("Device:", device);
  console.log("Device connected:", device && device.gatt && device.gatt.connected);
  console.log("Write characteristic:", writeCharacteristic);
  
  if(device && device.gatt && device.gatt.connected && writeCharacteristic) {
    try {
      console.log("Attempting to send data...");
      console.log("Write characteristic properties:", writeCharacteristic.properties);
      
      const encoder = new TextEncoder();
      const data = encoder.encode(command);
      
      // Try writeWithoutResponse first, then regular write
      if (writeCharacteristic.properties.writeWithoutResponse) {
        console.log("Using writeWithoutResponse");
        await writeCharacteristic.writeValueWithoutResponse(data);
      } else if (writeCharacteristic.properties.write) {
        console.log("Using regular write");
        await writeCharacteristic.writeValue(data);
      } else {
        throw new Error("Characteristic doesn't support writing");
      }
      
      console.log("Data sent successfully");
      
      // Display sent string in raw data window
      document.getElementById("rawDataDisplay").textContent = "Sent: " + command;
      document.getElementById("rawDataDisplay").style.color = "#ffaa00"; // Orange color for sent data
      
      // Reset color back to green after 2 seconds
      setTimeout(() => {
        document.getElementById("rawDataDisplay").style.color = "#00ff00";
        if(document.getElementById("rawDataDisplay").textContent.startsWith("Sent:")) {
          document.getElementById("rawDataDisplay").textContent = "No data sent yet...";
        }
      }, 2000);
      
    } catch(error) {
      console.error("Error sending data:", error);
      document.getElementById("rawDataDisplay").textContent = "Error sending: " + error.message;
      document.getElementById("rawDataDisplay").style.color = "#ff0000"; // Red color for errors
      
      // Reset color back to green after 3 seconds
      setTimeout(() => {
        document.getElementById("rawDataDisplay").style.color = "#00ff00";
        document.getElementById("rawDataDisplay").textContent = "No data sent yet...";
      }, 3000);
    }
  } else {
    let errorMsg = "Cannot send data: ";
    if(!device) {
      errorMsg += "No device selected";
    } else if(!device.gatt) {
      errorMsg += "Device GATT not available";
    } else if(!device.gatt.connected) {
      errorMsg += "Device not connected";
    } else if(!writeCharacteristic) {
      errorMsg += "No writable characteristic found - check console for available characteristics";
    }
    
    console.log("Send error:", errorMsg);
    document.getElementById("rawDataDisplay").textContent = errorMsg;
    document.getElementById("rawDataDisplay").style.color = "#ff0000";
    
    setTimeout(() => {
      document.getElementById("rawDataDisplay").style.color = "#00ff00";
      document.getElementById("rawDataDisplay").textContent = "No data sent yet...";
    }, 3000);
  }
}

// --- Helper function to update connection state ---
function updateConnectionState(connected) {
  const tempToggle = document.getElementById("tempToggle");
  const pressureToggle = document.getElementById("pressureToggle");
  
  if (connected) {
    tempToggle.classList.remove("disabled");
    pressureToggle.classList.remove("disabled");
  } else {
    tempToggle.classList.add("disabled");
    pressureToggle.classList.add("disabled");
  }
}

// --- Temperature Toggle Switch Handler ---
document.getElementById("tempToggle").onclick = async () => {
  // Check if disabled (not connected)
  if (document.getElementById("tempToggle").classList.contains("disabled")) {
    return; // Do nothing if disabled
  }
  
  console.log("Temperature toggle switch clicked");
  
  // Send the opposite of current state to toggle the device
  const command = tempToggleActive ? "C" : "F";
  
  // Immediately update the toggle switch visual state
  const newUnit = tempToggleActive ? "C" : "F";
  updateTempToggleSwitch(newUnit);
  
  // Also update the load button color for immediate feedback
  document.getElementById("loadButton").style.backgroundColor = tempToggleActive ? "green" : "yellow";
  
  await sendData(command);
};

// --- Pressure Toggle Switch Handler ---
document.getElementById("pressureToggle").onclick = async () => {
  // Check if disabled (not connected)
  if (document.getElementById("pressureToggle").classList.contains("disabled")) {
    return; // Do nothing if disabled
  }
  
  console.log("Pressure toggle switch clicked");
  
  // Send the opposite of current state to toggle the device
  const command = pressureToggleActive ? "B" : "P"; // B for Bar, P for PSI
  
  // Immediately update the toggle switch visual state
  const newUnit = pressureToggleActive ? "Bar" : "PSI";
  updatePressureToggleSwitch(newUnit);
  
  // Also update the delete button color for immediate feedback
  document.getElementById("deleteButton").style.backgroundColor = pressureToggleActive ? "blue" : "purple";
  
  await sendData(command);
};

document.getElementById("pauseResumeButton").onclick=()=>{
  paused=!paused;
  document.getElementById("pauseResumeButton").textContent=paused?"Resume":"Pause";
};

document.getElementById("resetButton").onclick=()=>{
  chartData={labels:[],temp:[],pressure:[]}; secondsCounter=0;
  [tempChart,pressureChart,combinedChart].forEach(chart=>{
    chart.data.labels=[];
    chart.data.datasets.forEach(ds=>ds.data=[]);
    chart.update();
  });
};

document.getElementById("toggleViewButton").onclick=()=>{
  splitView=!splitView; localStorage.setItem("viewChoice",splitView?"split":"combined"); updateView();
};

function updateView(){
  document.getElementById("splitView").style.display=splitView?"flex":"none";
  document.getElementById("combinedView").style.display=splitView?"none":"flex";
}

if(localStorage.getItem("viewChoice")==="combined") splitView=false;
updateView();

document.getElementById("saveButton").onclick=()=>{
  const name=prompt("Enter a name for saved graph:"); if(!name) return;
  localStorage.setItem("graph_"+name,JSON.stringify(chartData));
};
document.getElementById("loadButton").onclick=()=>{showModal("load");};
document.getElementById("deleteButton").onclick=()=>{showModal("delete");};

// --- Data Handling ---
function handleData(event){
  const rawData = new TextDecoder().decode(event.target.value).trim();
  
  // Don't display received data in the raw data window anymore
  // This window is now only for sent data
  
  // Check for third and fourth values and update UI accordingly
  const dataParts = rawData.split(",");
  let isFahrenheit = false;
  let isPSI = false;
  
  if(dataParts.length >= 3){
    const thirdValue = dataParts[2].trim();
    if(thirdValue === "C"){
      document.getElementById("loadButton").style.backgroundColor = "green";
      updateTempToggleSwitch("C");
      isFahrenheit = false;
    } else if(thirdValue === "F"){
      document.getElementById("loadButton").style.backgroundColor = "yellow";
      updateTempToggleSwitch("F");
      isFahrenheit = true;
    } else {
      document.getElementById("loadButton").style.backgroundColor = "#333";
      updateTempToggleSwitch("C");
      isFahrenheit = false;
    }
  } else {
    document.getElementById("loadButton").style.backgroundColor = "#333";
    updateTempToggleSwitch("C");
    isFahrenheit = false;
  }
  
  if(dataParts.length >= 4){
    const fourthValue = dataParts[3].trim();
    if(fourthValue === "bar"){
      document.getElementById("deleteButton").style.backgroundColor = "blue";
      updatePressureToggleSwitch("Bar");
      isPSI = false;
    } else if(fourthValue === "psi"){
      document.getElementById("deleteButton").style.backgroundColor = "purple";
      updatePressureToggleSwitch("PSI");
      isPSI = true;
    } else {
      // Don't change toggle state if we get unknown data
      document.getElementById("deleteButton").style.backgroundColor = "#333";
      isPSI = (currentPressureUnit === "PSI");
    }
  } else {
    // Don't change toggle state if no data received - keep current state
    document.getElementById("deleteButton").style.backgroundColor = "#333";
    isPSI = (currentPressureUnit === "PSI");
  }
  
  if(paused) return;
  const [tempStr,pressureStr]=rawData.split(",");
  currentTemp=parseFloat(tempStr);
  currentPressure=Math.max(0,parseFloat(pressureStr));

  const label=secondsCounter++;
  chartData.labels.push(label);
  chartData.temp.push(currentTemp);
  chartData.pressure.push(currentPressure);

  if(chartData.labels.length>maxPointsValue){
    chartData.labels.shift(); chartData.temp.shift(); chartData.pressure.shift();
  }

  // Update temperature chart with appropriate unit
  const tempUnit = isFahrenheit ? "°F" : "°C";
  tempChart.data.labels=chartData.labels; 
  tempChart.data.datasets[0].data=chartData.temp;
  tempChart.data.datasets[0].label = `Temp (${tempUnit})`;
  tempChart.options.scales.y.title.text = `Temperature (${tempUnit})`;
  if(chartData.temp.length > 0) {
    const minTemp = Math.min(...chartData.temp);
    const maxTemp = Math.max(...chartData.temp);
    const tempRange = maxTemp - minTemp;
    const padding = Math.max(tempRange * 0.1, 1); // 10% padding or minimum 1 degree
    tempChart.options.scales.y.min = minTemp - padding;
    tempChart.options.scales.y.max = maxTemp + padding;
  }
  tempChart.update();

  // Update pressure chart with appropriate unit
  const pressureUnit = isPSI ? "PSI" : "bar";
  let displayPressure = chartData.pressure.slice(); // Copy the array
  if(isPSI) {
    // Convert bar to PSI for display
    displayPressure = displayPressure.map(p => barToPsi(p));
  }
  
  pressureChart.data.labels=chartData.labels; 
  pressureChart.data.datasets[0].data=displayPressure;
  pressureChart.data.datasets[0].label = `Pressure (${pressureUnit})`;
  pressureChart.options.scales.y.title.text = `Pressure (${pressureUnit})`;
  if(displayPressure.length > 0) {
    const minPressure = Math.min(...displayPressure);
    const maxPressure = Math.max(...displayPressure);
    const pressureRange = maxPressure - minPressure;
    const padding = Math.max(pressureRange * 0.1, isPSI ? 1.45 : 0.1); // Different padding for different units
    pressureChart.options.scales.y.min = Math.max(0, minPressure - padding);
    pressureChart.options.scales.y.max = maxPressure + padding;
  }
  pressureChart.update();

  // Update combined chart
  let combinedDisplayPressure = chartData.pressure.slice();
  if(isPSI) {
    combinedDisplayPressure = combinedDisplayPressure.map(p => barToPsi(p));
  }
  
  combinedChart.data.labels=chartData.labels;
  combinedChart.data.datasets[0].data=chartData.temp;
  combinedChart.data.datasets[1].data=combinedDisplayPressure;
  combinedChart.data.datasets[0].label = `Temp (${tempUnit})`;
  combinedChart.data.datasets[1].label = `Pressure (${pressureUnit})`;
  if(chartData.temp.length > 0) {
    const minTemp = Math.min(...chartData.temp);
    const maxTemp = Math.max(...chartData.temp);
    const tempRange = maxTemp - minTemp;
    const tempPadding = Math.max(tempRange * 0.1, 1);
    combinedChart.options.scales.y1.min = minTemp - tempPadding;
    combinedChart.options.scales.y1.max = maxTemp + tempPadding;
  }
  if(combinedDisplayPressure.length > 0) {
    const minPressure = Math.min(...combinedDisplayPressure);
    const maxPressure = Math.max(...combinedDisplayPressure);
    const pressureRange = maxPressure - minPressure;
    const pressurePadding = Math.max(pressureRange * 0.1, isPSI ? 1.45 : 0.1);
    combinedChart.options.scales.y2.min = Math.max(0, minPressure - pressurePadding);
    combinedChart.options.scales.y2.max = maxPressure + pressurePadding;
  }
  combinedChart.update();
}

// Initialize toggles as disabled on page load
updateConnectionState(false);

// --- Auto-check BLE every second ---
setInterval(()=>{
  const btn=document.getElementById("connectButton");
  if(device){
    if(device.gatt.connected){
      btn.textContent="Disconnect"; btn.className="connected";
    } else {
      btn.textContent="Connect"; btn.className="disconnected";
    }
  }
},1000);

// --- Apply Settings ---
document.getElementById("applySettings").onclick = ()=>{
  const tempC = document.getElementById("tempColor").value;
  const pressureC = document.getElementById("pressureColor").value;
  const maxP = parseInt(document.getElementById("maxPoints").value);
  maxPointsValue = maxP;
  tempChart.data.datasets[0].borderColor=tempC;
  pressureChart.data.datasets[0].borderColor=pressureC;
  combinedChart.data.datasets[0].borderColor=tempC;
  combinedChart.data.datasets[1].borderColor=pressureC;
  tempChart.update(); pressureChart.update(); combinedChart.update();
};
</script>
</body>
</html>