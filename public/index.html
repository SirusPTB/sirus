<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVR-1</title>
    <!-- Add link to manifest for PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Add meta tags for iOS support (optional but recommended) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="LVR-1">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- Assume icons are created -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

.brightness-control {
    display: none;
}
@font-face {
    font-family: 'DSEG7Classic';
    src: url('DSEG7Classic-Bold.woff2') format('woff2'),
         url('DSEG7Classic-Bold.woff') format('woff'),
         url('DSEG7Classic-Bold.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}

        html, body {
            overflow: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body::-webkit-scrollbar {
            display: none;
        }

        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
        }

        .container {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            max-width: 90vw;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .container {
                max-width: 100vw;
            }
        }

        .page {
            display: none;
            flex-direction: column;
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .page::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        .page.active {
            display: flex;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h2 {
            font-size: 1.8rem;
        }

        .btn {
            background: #444;
            border: none;
            color: #fff;
            padding: .9rem 1.3rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            min-height: 48px;
            min-width: 48px;
        }

        .btn:hover { background: #555; }
        .btn-primary { background: #2563eb; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #16a34a; }
        .btn-danger { background: #dc2626; }

        .btn-group {
            display: flex;
            align-items: center;
            gap: .8rem;
            flex-wrap: wrap;
        }

        .ble-indicator {
            font-size: 1.8rem;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: color 0.3s ease;
        }

        .ble-indicator.disconnected { color: #666; }
        .ble-indicator.connected { color: #0051ff; }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 600px) {
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
                gap: 0.5rem;
            }
        }

        .status-card {
            background: #1a1a1a;
            padding: 1.2rem;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            border: 2px solid #333;
            font-size: 1.1rem;
            text-align: center;
        }

        .status-card.ready { border-color: #16a34a; background: #0f2f1f; }
        .status-card.heating { border-color: #333; background: #1a1a1a; }

.central-panel {
        /* Removed background, border, border-radius, and padding */
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;   /* Center the two panels horizontally */
        gap: 3rem;                  /* Space between the two separate panels */
    }

        @media (max-width: 768px) {
        .central-panel {
            flex-direction: column;
            gap: 2rem;              /* Slightly larger gap when stacked */
            text-align: center;
        }
    }
        .left-readings {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            flex: 1;
        }

        .reading-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .reading-row {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .reading-value {
            font-size: clamp(1rem, 7vw, 3.3rem);
            font-family: monospace;
            color: #283a8d;
        }

        .reading-unit {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            color: #283a8d;
            font-family: monospace;
        }

.left-readings,
    .shot-timer-section {
        background: #1a1a1a;
        border: 2px solid #444;
        border-radius: 16px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
    }

.shot-time {
            font-size: clamp(2rem, 8vw, 4rem);  /* slightly larger for better segment visibility */
            font-family: 'DSEG7Classic', monospace;
            line-height: 1;
        }

        .shot-time.running { color: #fff; }
        .shot-time.stopped { color: #666; }

        .panel-label {
        font-size: 1.6rem;
        margin-top: 1rem;
        color: #ccc;
    }

        .graph-container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 1.2rem;
            cursor: pointer;
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: opacity 0.3s;
            position: relative;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
            flex: 1;
        }

        .graph-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: .8rem;
            justify-content: center;
            font-size: .9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .graph-tooltip {
            position: absolute;
            background: #333;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            pointer-events: none;
            font: 14px monospace;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            z-index: 10;
            display: none;
            min-width: 120px;
        }

        .brightness-control {
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 2rem;
            text-align: center;
        }

        .brightness-control label {
            display: block;
            font-size: 1.4rem;
            margin-bottom: 1rem;
            color: #ccc;
        }

        .brightness-slider {
            width: 100%;
            max-width: 400px;
            height: 10px;
            border-radius: 5px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }

        .brightness-slider::-webkit-slider-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }

        .brightness-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            border: none;
        }

        .settings-row {
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .settings-row {
                flex-direction: column;
                align-items: stretch;
            }
            .settings-controls {
                display: flex;
                justify-content: space-around;
            }
        }

        .settings-label { font-size: 1.6rem; }
        .settings-value {
            font-size: 2rem;
            font-family: monospace;
            color: #06b6d4;
        }

        .btn-adjust {
            width: 60px;
            height: 60px;
            font-size: 2rem;
            font-weight: bold;
        }

        .unit-toggle-group {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .unit-toggle-btn {
            min-width: 120px;
            font-size: 1.4rem;
            padding: 1rem 2rem;
        }

        .pid-zone {
            background: #1a1a1a;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .pid-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .pid-column h4 { margin-bottom: 10px; font-size: 16px; }
        .pid-column h4.aggressive { color: #fb923c; }
        .pid-column h4.conservative { color: #06b6d4; }

        .pid-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pid-input {
            width: 90px;
            text-align: right;
            font-family: monospace;
            font-size: inherit;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            padding: 4px 6px;
            overflow: hidden;
        }

        .pid-input:focus {
            outline: none;
            border-color: #2563eb;
            background: #333;
        }

        /* Remove spinner arrows */
        .pid-input::-webkit-inner-spin-button,
        .pid-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .pid-input {
            -moz-appearance: textfield;
        }

        .btn-pid {
            width: 40px;
            height: 30px;
            font-size: 18px;
        }

        .full-graph { flex: 1; display: flex; flex-direction: column; }

        .graph-stats {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
        }

        .stat-item { display: flex; align-items: center; gap: 8px; }
        .stat-value { color: #06b6d4; font-family: monospace; }

        .disabled-nav {
            opacity: 0.4;
            pointer-events: none;
            cursor: default;
        }

        /* === FIX MINI GRAPH INITIAL SIZE === */
#mainPage .graph-container.nav-graph {
    flex: none;        /* stop flex height guessing */
    height: 90vh;      /* real height on first layout */
    min-height: 140px;
    max-height: 240px;
}
/* === FIX MINI GRAPH CANVAS SIZE === */
#mainPage #miniGraph {
    height: 90% !important;
}
.nav-settings {
    font-size: 1.9rem;
    line-height: 1;
    padding: 0.6rem 0.8rem;
}
/* === Black background for settings (three-dot) button === */
.nav-settings {
    background: #000;
}

.nav-settings:hover {
    background: #111;
}


    </style>
</head>
<body>

    <!-- Add the button somewhere visible (e.g., top-right or bottom) -->
<button id="installButton" style="display:none; position:fixed; bottom:20px; right:20px; z-index:100; background:#2563eb; color:#fff; padding:12px 20px; border-radius:50px; border:none; box-shadow:0 4px 12px rgba(0,0,0,0.3); font-size:16px;" onclick="showInstallPrompt()">
  üì≤ Install App
</button>

    <div class="container">
        <div class="page active" id="mainPage">
            <div class="header">
                <h2>LVR-1</h2>
                <div class="btn-group">
                    <button class="btn btn-primary ble-connect-btn" onclick="toggleBLE()">Connect BLE</button>
                    <div class="ble-indicator disconnected" title="Bluetooth Status">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                        </svg>
                    </div>
                    <button class="btn nav-settings" onclick="showPage('settings')">‚ãÆ</button>
                </div>
            </div>

            <div class="status-grid">
                <div class="status-card" id="brewStatus">
                    <div class="status-temp" id="brewTempCard">0.0¬∞</div>
                    <div class="status-label">Brew</div>
                </div>

                <div class="status-card" id="steamStatus">
                    <div class="status-temp" id="steamTempCard">0.0¬∞</div>
                    <div class="status-label">Steam</div>
                </div>

                <div class="status-card" id="groupStatus">
                    <div class="status-temp" id="groupTempCard">0.0¬∞</div>
                    <div class="status-label">Group</div>
                </div>
            </div>

            <div class="central-panel">
                <div class="left-readings">
                    <div class="reading-item">
                        <div class="reading-row">
                            <div class="reading-value" id="pressureDisplay">0.0</div>
                            <div class="reading-unit" id="pressureUnit">bar</div>
                        </div>
                    </div>
                </div>

                <div class="shot-timer-section">
                    <div class="shot-time stopped" id="shotTime">00</div>
                </div>
            </div>

            <div class="graph-container nav-graph" onclick="showPage('graph')">
                <canvas id="miniGraph"></canvas>
                <div class="graph-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f00;"></div>
                        <span>Brew Temp</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00f;"></div>
                        <span>Group Pressure</span>
                    </div>
                </div>
                <div class="graph-tooltip"></div>
            </div>

            <div style="flex: 0.3;"></div>

        </div>

        <div class="page" id="settingsPage">
            <div class="header">
                <h2>Settings</h2>
                <div class="btn-group">
                    <div class="ble-indicator disconnected" title="Bluetooth Status">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                        </svg>
                    </div>
                    <button class="btn" onclick="showPage('main')">‚Üê Back</button>
                </div>
            </div>

            <div class="settings-row">
                <div class="settings-label">Brew:</div>
                <div class="settings-controls">
                    <div class="settings-value" id="brewSetpointDisplay">93.0 ¬∞C</div>
                    <button class="btn btn-danger btn-adjust" onclick="adjustSetpoint('brew', -0.1)">‚àí</button>
                    <button class="btn btn-success btn-adjust" onclick="adjustSetpoint('brew', 0.1)">+</button>
                </div>
            </div>

            <div class="settings-row">
                <div class="settings-label">Steam:</div>
                <div class="settings-controls">
                    <div class="settings-value" id="steamSetpointDisplay">125.0 ¬∞C</div>
                    <button class="btn btn-danger btn-adjust" onclick="adjustSetpoint('steam', -0.1)">‚àí</button>
                    <button class="btn btn-success btn-adjust" onclick="adjustSetpoint('steam', 0.1)">+</button>
                </div>
            </div>

            <div class="settings-row">
                <div class="settings-label">Group:</div>
                <div class="settings-controls">
                    <div class="settings-value" id="groupSetpointDisplay">92.0 ¬∞C</div>
                    <button class="btn btn-danger btn-adjust" onclick="adjustSetpoint('group', -0.1)">‚àí</button>
                    <button class="btn btn-success btn-adjust" onclick="adjustSetpoint('group', 0.1)">+</button>
                </div>
            </div>

            <div class="unit-toggle-group">
                <button class="btn unit-toggle-btn" id="tempUnitBtn" onclick="toggleTempUnit()">¬∞C</button>
                <button class="btn unit-toggle-btn" id="pressureUnitBtn" onclick="togglePressureUnit()">bar</button>
            </div>

            <div class="brightness-control">
                <label for="brightnessSlider">Display Brightness</label>
                <input type="range" class="brightness-slider" id="brightnessSlider" 
                       min="5" max="255" value="200" oninput="updateBrightness(this.value)">
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-primary" style="flex: 1; padding: 1.5rem; font-size: 1.2rem;" onclick="showPage('pid')">PID Settings</button>
                <button class="btn btn-primary" style="flex: 1; padding: 1.5rem; font-size: 1.2rem;" onclick="showPage('graph')">üìà Full Graph</button>
            </div>
        </div>

        <div class="page" id="graphPage">
            <div class="header">
                <h2>Temperature History</h2>
                <div class="btn-group">
                    <div class="ble-indicator disconnected" title="Bluetooth Status">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                        </svg>
                    </div>
                    <button class="btn btn-success" id="pauseBtn" onclick="togglePause()">Pause</button>
                    <button class="btn" onclick="saveData()">üíæ Save</button>
                    <button class="btn" onclick="document.getElementById('loadFileInput').click()">üìÅ Load</button>
                    <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Clear</button>
                    <button class="btn" onclick="showPage('main')">‚Üê Back</button>
                </div>
            </div>
            <div class="graph-container full-graph">
                <canvas id="fullGraph"></canvas>
                <div class="graph-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f00;"></div>
                        <span>Brew Temperature</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00f;"></div>
                        <span>Group Pressure</span>
                    </div>
                </div>
                <div class="graph-stats">
                    <div class="stat-item">
                        <span>Samples:</span>
                        <span class="stat-value" id="sampleCount">0</span>
                    </div>
                </div>
                <div class="graph-tooltip"></div>
            </div>

            <input type="file" id="loadFileInput" accept="application/json,.json" style="display:none;">
        </div>

        <div class="page" id="pidPage">
            <div class="header">
                <h2>PID Gains</h2>
                <div class="btn-group">
                    <button class="btn btn-danger" onclick="resetAllPID()">Reset Defaults</button>
                    <div class="ble-indicator disconnected" title="Bluetooth Status">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                        </svg>
                    </div>
                    <button class="btn" onclick="showPage('settings')">‚Üê Back</button>
                </div>
            </div>
            <div id="pidZones"></div>
        </div>
    </div>


    
    <script>


let deferredPrompt; // Stores the install event if it fires

// Capture the event if it does fire (for mobile/reliability)
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log('Install prompt ready'); // Check DevTools Console
});

// Main install function for the button
function triggerInstall() {
  if (deferredPrompt) {
    // Native prompt if available
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choice) => {
      if (choice.outcome === 'accepted') {
        console.log('App installed');
      }
      deferredPrompt = null;
    });
  } else {
    // Fallback: Show instructions if no prompt (common on desktop)
    alert('To install:\n\nOn desktop Chrome: Click the three dots menu (‚ãÆ) ‚Üí Save and share ‚Üí Install page as app\n\nOn mobile: Tap Share ‚Üí Add to Home Screen');
  }
}

// Optional: Hide button if already installed (detect via standalone mode)
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
  document.getElementById('installButton').style.display = 'none';
}



let manualDisconnect = false;
let reconnectAttempts = 0;
let reconnectTimer = null;

const RECONNECT_BASE_DELAY = 1000;   // 1s
const RECONNECT_MAX_DELAY  = 30000;  // 30s cap
const RECONNECT_MAX_TRIES  = Infinity; // or set to e.g. 10

        let state = {
            bleDevice: null,
            bleConnected: false,
            characteristic: null,
            brewTemp: 0.0,
            steamTemp: 0.0,
            groupTemp: 0.0,
            groupPressure: 0.0,
            brewSetpoint: 93.0,
            steamSetpoint: 125.0,
            groupSetpoint: 92.0,
            brewReady: false,
            steamReady: false,
            groupReady: false,
            useFahrenheit: false,
            pressureIsBar: true,
            brightness: 200,
            shotRunning: false,
            shotTime: 0,
            shotStartTime: null,
            shotInterval: null,
            tempHistory: [],
            pressureHistory: [],
            hasReceivedFirstData: false,
            dataCollectionPaused: false,
            pidGains: {
                brew: { consKp: 1.20, consKi: 0.06, consKd: 0.30, aggKp: 4.50, aggKi: 0.22, aggKd: 1.10 },
                steam: { consKp: 0.90, consKi: 0.04, consKd: 0.40, aggKp: 3.80, aggKi: 0.18, aggKd: 1.30 },
                group: { consKp: 1.40, consKi: 0.03, consKd: 0.80, aggKp: 5.00, aggKi: 0.12, aggKd: 2.00 }
            }
        };

        let miniHoveredIndex = -1;
        let fullHoveredIndex = -1;

        const miniTooltip = document.querySelector('.nav-graph .graph-tooltip');
        const fullTooltip = document.querySelector('.full-graph .graph-tooltip');

        function snap(v) {
            return Math.round(v) + 0.5;
        }

        function smooth(prev, next, alpha = 0.2) {
            return prev == null ? next : prev + alpha * (next - prev);
        }

        /////////////////////////
function attemptReconnect() {
    if (manualDisconnect) return;
    if (!state.bleDevice) return;
    if (state.bleConnected) return;

    const delay = Math.min(
        RECONNECT_BASE_DELAY * Math.pow(2, reconnectAttempts),
        RECONNECT_MAX_DELAY
    );

    reconnectTimer = setTimeout(async () => {
        reconnectAttempts++;
        updateBLEUI(true); // "Reconnecting‚Ä¶"

        try {
            await connectBLE(true); 
        } catch {
            attemptReconnect(); // next backoff
        }
    }, delay);
}

function disconnectBLE() {
    try {
        if (state.characteristic) {
            state.characteristic.removeEventListener(
                'characteristicvaluechanged',
                handleBLEData
            );
        }

        if (state.bleDevice?.gatt?.connected) {
            state.bleDevice.gatt.disconnect();
        }
    } catch {}

    state.characteristic = null;
    state.bleConnected = false;
}


        /////////////////////////

async function toggleBLE() {
    if (state.bleConnected) {
        manualDisconnect = true;

        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }

        reconnectAttempts = 0;
        disconnectBLE();
        updateBLEUI();
    } else {
        manualDisconnect = false;
        reconnectAttempts = 0;
        await connectBLE();
    }
}

function resetLiveData() {
    state.brewTemp = 0;
    state.steamTemp = 0;
    state.groupTemp = 0;
    state.groupPressure = 0;

    state.brewReady = false;
    state.steamReady = false;
    state.groupReady = false;

    state.brewFault = false;
    state.steamFault = false;
    state.groupFault = false;

    state.shotRunning = false;
    const shotElem = document.getElementById('shotTime');
    if (shotElem) {
        shotElem.textContent = '00';
        shotElem.classList.add('stopped');
        shotElem.classList.remove('running');
    }

    state.tempHistory = [];
    state.pressureHistory = [];
    document.getElementById('sampleCount').textContent = '0';

    drawMiniGraph();
    drawFullGraph();
    updateDisplay();  // or your existing UI refresh
}
async function connectBLE(isReconnect = false) {
    if (!navigator.bluetooth) {
        alert('Web Bluetooth not supported');
        return;
    }

    try {
        let device = state.bleDevice;

        // FIRST connection (user click only)
        if (!device || !isReconnect) {
            device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'LVR-1' }],
                optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b']
            });

            state.bleDevice = device;
            device.addEventListener('gattserverdisconnected', handleDisconnect);
        }

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(
            '4fafc201-1fb5-459e-8fcc-c5c9c331914b'
        );
        const characteristic = await service.getCharacteristic(
            'beb5483e-36e1-4688-b7f5-ea07361b26a8'
        );

        await characteristic.startNotifications();
        characteristic.addEventListener(
            'characteristicvaluechanged',
            handleBLEData
        );

        state.characteristic = characteristic;
        state.bleConnected = true;

        reconnectAttempts = 0;
        updateBLEUI();

        console.log('BLE connected');
    } catch (err) {
        console.warn('BLE connect failed:', err);
        throw err;
    }
}

function handleDisconnect() {
    console.warn('BLE disconnected');

    if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
    }

    state.bleConnected = false;
    state.characteristic = null;

    updateBLEUI();
    resetLiveData();

    // ‚ùó DO NOT wipe device on manual disconnect
    if (manualDisconnect) {
        manualDisconnect = false;
        return;
    }

    // Auto reconnect only if unexpected
    reconnectAttempts = 0;
    attemptReconnect();
}

function updateBLEUI(reconnecting = false) {
    const connected =
        state.bleConnected === true &&
        state.bleDevice !== null &&
        state.characteristic !== null;

    document.querySelectorAll('.ble-connect-btn').forEach(btn => {
        if (connected) {
            btn.textContent = 'Disconnect';
            btn.classList.add('btn-danger');
            btn.classList.remove('btn-primary');
        } else if (reconnecting) {
            btn.textContent = 'Reconnecting‚Ä¶';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-primary');
        } else {
            btn.textContent = 'Connect BLE';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-primary');
        }
    });

    document.querySelectorAll('.ble-indicator').forEach(ind => {
        ind.classList.toggle('connected', connected);
        ind.classList.toggle('disconnected', !connected);
    });
}

function handleBLEData(event) {
    const text = new TextDecoder().decode(event.target.value);
    console.log('Raw BLE data received:', text);

    let data;

    try { data = JSON.parse(text); }
    catch (e) { console.error('Parse error:', e); return; }

    // Sync brightness slider with live BLE data
    const slider = document.getElementById('brightnessSlider');
    if (slider && slider.value != state.brightness) {
        slider.value = Math.round(state.brightness);
    }

    // PID packet
    if (data.pid) {
        if (data.pid.brew)   Object.assign(state.pidGains.brew,   data.pid.brew);
        if (data.pid.steam)  Object.assign(state.pidGains.steam,  data.pid.steam);
        if (data.pid.group)  Object.assign(state.pidGains.group,  data.pid.group);
        renderPIDSettings();
        return;
    }

    // Live data
    Object.assign(state, {
        brewTemp:       data.brewTemp       ?? state.brewTemp,
        steamTemp:      data.steamTemp      ?? state.steamTemp,
        groupTemp:      data.groupTemp      ?? state.groupTemp,
        groupPressure:  data.groupPressure  ?? state.groupPressure,
        brewSetpoint:   data.brewSetpoint   ?? state.brewSetpoint,
        steamSetpoint:  data.steamSetpoint  ?? state.steamSetpoint,
        groupSetpoint:  data.groupSetpoint  ?? state.groupSetpoint,
        brewReady:      data.brewReady      ?? state.brewReady,
        steamReady:     data.steamReady     ?? state.steamReady,
        groupReady:     data.groupReady     ?? state.groupReady,
        brewFault:      data.brewFault      ?? state.brewFault,
        steamFault:     data.steamFault     ?? state.steamFault,
        groupFault:     data.groupFault     ?? state.groupFault,
        brightness:     data.brightness     ?? state.brightness,
        useFahrenheit:  data.useFahrenheit  ?? state.useFahrenheit,
        pressureIsBar:  data.pressureIsBar  ?? state.pressureIsBar,
    });

    updateUnitButtons();

    // Shot timer sync
    if ('shotRunning' in data && 'shotSeconds' in data) {
        state.shotRunning = data.shotRunning;
        const secs = Math.max(0, Math.min(98, data.shotSeconds % 99));
        const shotElem = document.getElementById('shotTime');
        shotElem.textContent = String(secs).padStart(2, '0');
        shotElem.classList.toggle('running', state.shotRunning);
        shotElem.classList.toggle('stopped', !state.shotRunning);
    }

    // Graph history (if not paused)
    if (!state.dataCollectionPaused) {
        state.tempHistory.push(state.brewTemp);
        state.pressureHistory.push(state.groupPressure);
        if (state.tempHistory.length > 600) {
            state.tempHistory.shift();
            state.pressureHistory.shift();
        }
        drawMiniGraph();
        drawFullGraph();
        document.getElementById('sampleCount').textContent = state.tempHistory.length;
    }

    // Quick UI refresh (add your existing update calls here)
    updateDisplay();  // or call your individual element updates
}
        async function sendBLECommand(command) {
            if (!state.characteristic) return;

            try {
                const encoder = new TextEncoder();
                await state.characteristic.writeValue(encoder.encode(JSON.stringify(command)));
                console.log('Sent command:', command);
            } catch (error) {
                console.error('BLE write failed:', error);
            }
        }

function showPage(pageName) {
    if (pageName !== 'main' && !state.bleConnected) {
        alert('Please connect to the device via BLE to access this page.');
        return;
    }

    document.querySelectorAll('.page').forEach(page =>
        page.classList.remove('active')
    );

    const pageEl = document.getElementById(pageName + 'Page');
    pageEl.classList.add('active');

    // üî• FORCE mini graph resize AFTER layout resolves
    if (pageName === 'main') {
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                drawMiniGraph();
            });
        });
    }

    if (pageName === 'pid') {
        document.getElementById('pidZones').innerHTML = '<p>Loading PID values‚Ä¶</p>';
        sendBLECommand({ type: 'get_pid' });
    }

    if (pageName === 'graph') {
        drawFullGraph();
    }

    if (pageName === 'settings') {
        updateUnitButtons();
        // Sync brightness slider to current state when opening settings
        const slider = document.getElementById('brightnessSlider');
        if (slider) {
            slider.value = state.brightness;
        }
    }
}


        function cToF(c) { return c * 9 / 5 + 32; }

        function toggleTempUnit() {
            state.useFahrenheit = !state.useFahrenheit;
            document.getElementById('tempUnitBtn').textContent = state.useFahrenheit ? '¬∞F' : '¬∞C';
            if (state.bleConnected) {
                sendBLECommand({ type: 'unit', unitType: 'temp', value: state.useFahrenheit });
            }
            updateDisplay();
            drawMiniGraph();
            if (document.getElementById('graphPage').classList.contains('active')) {
                drawFullGraph();
            }
        }

        function togglePressureUnit() {
            state.pressureIsBar = !state.pressureIsBar;
            document.getElementById('pressureUnitBtn').textContent = state.pressureIsBar ? 'bar' : 'psi';
            if (state.bleConnected) {
                sendBLECommand({ type: 'unit', unitType: 'pressure', value: state.pressureIsBar });
            }
            updateDisplay();
            drawMiniGraph();
            if (document.getElementById('graphPage').classList.contains('active')) {
                drawFullGraph();
            }
        }

        function updateDisplay() {
            const tempUnit = state.useFahrenheit ? '¬∞F' : '¬∞C';

            document.getElementById('brewTempCard').textContent  = (state.useFahrenheit ? cToF(state.brewTemp) : state.brewTemp).toFixed(1) + tempUnit;
            document.getElementById('steamTempCard').textContent = (state.useFahrenheit ? cToF(state.steamTemp) : state.steamTemp).toFixed(1) + tempUnit;
            document.getElementById('groupTempCard').textContent = (state.useFahrenheit ? cToF(state.groupTemp) : state.groupTemp).toFixed(1) + tempUnit;

            document.getElementById('brewStatus').className  = 'status-card ' + (state.bleConnected && state.brewReady ? 'ready' : state.bleConnected && !state.brewReady ? 'heating' : '');
            document.getElementById('steamStatus').className = 'status-card ' + (state.bleConnected && state.steamReady ? 'ready' : state.bleConnected && !state.steamReady ? 'heating' : '');
            document.getElementById('groupStatus').className = 'status-card ' + (state.bleConnected && state.groupReady ? 'ready' : state.bleConnected && !state.groupReady ? 'heating' : '');

            const pressureValue = state.pressureIsBar ? state.groupPressure : state.groupPressure * 14.5038;
            document.getElementById('pressureDisplay').textContent = pressureValue.toFixed(1);
            document.getElementById('pressureUnit').textContent = state.pressureIsBar ? 'bar' : 'psi';

            document.getElementById('brewSetpointDisplay').textContent =
                (state.useFahrenheit ? cToF(state.brewSetpoint) : state.brewSetpoint).toFixed(1) + ' ' + tempUnit;
            document.getElementById('steamSetpointDisplay').textContent =
                (state.useFahrenheit ? cToF(state.steamSetpoint) : state.steamSetpoint).toFixed(1) + ' ' + tempUnit;
            document.getElementById('groupSetpointDisplay').textContent =
                (state.useFahrenheit ? cToF(state.groupSetpoint) : state.groupSetpoint).toFixed(1) + ' ' + tempUnit;

            updateUnitButtons();

        }

        function updateBrightness(value) {
            state.brightness = parseInt(value);
            sendBLECommand({ type: 'brightness', value: state.brightness });
        }

        function adjustSetpoint(zone, delta) {
            if (zone === 'brew') {
                state.brewSetpoint = Math.max(80, Math.min(100, state.brewSetpoint + delta));
                sendBLECommand({ type: 'setpoint', zone: 'brew', value: state.brewSetpoint });
            } else if (zone === 'steam') {
                state.steamSetpoint = Math.max(110, Math.min(140, state.steamSetpoint + delta));
                sendBLECommand({ type: 'setpoint', zone: 'steam', value: state.steamSetpoint });
            } else if (zone === 'group') {
                state.groupSetpoint = Math.max(80, Math.min(98, state.groupSetpoint + delta));
                sendBLECommand({ type: 'setpoint', zone: 'group', value: state.groupSetpoint });
            }
            updateDisplay();
        }

        function setupHiDPICanvas(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width  = Math.round(rect.width * dpr);
            canvas.height = Math.round(rect.height * dpr);
            const ctx = canvas.getContext('2d');
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            return ctx;
        }

        let lastTemp = null;
        let lastPressure = null;

        setInterval(() => {
  if (state.bleConnected && state.characteristic) {
    sendBLECommand({ type: "ping" });
  }
}, 3000);

setInterval(() => {
    if (state.bleConnected && (!state.bleDevice || !state.bleDevice.gatt.connected)) {
        handleDisconnect();
    }
}, 1000);

        setInterval(() => {
            if (!state.bleConnected || !state.hasReceivedFirstData) return;

            if (!state.dataCollectionPaused) {
                lastTemp = smooth(lastTemp, state.brewTemp);
                lastPressure = smooth(lastPressure, state.groupPressure);

                state.tempHistory.push(lastTemp);
                state.pressureHistory.push(lastPressure);

                if (state.tempHistory.length > 600) {
                    state.tempHistory.shift();
                    state.pressureHistory.shift();
                }
            }

            drawMiniGraph();

            const graphPage = document.getElementById('graphPage');
            if (graphPage && graphPage.classList.contains('active')) {
                drawFullGraph();
            }
        }, 1000);

        function handleGraphHover(event, canvasId) {
            event.preventDefault();
            const canvas = document.getElementById(canvasId);
            const rect = canvas.getBoundingClientRect();
            const isTouch = event.touches !== undefined;
            const clientX = isTouch ? event.touches[0].clientX : event.clientX;
            const relX = clientX - rect.left;

            if (relX < 0 || relX > rect.width) {
                handleGraphLeave(canvasId);
                return;
            }

            const isMini = canvasId === 'miniGraph';

            let paddingLeft, paddingRight, paddingTop, paddingBottom;
            if (isMini) {
                paddingLeft = 40;
                paddingRight = 40;
                paddingTop = 40;
                paddingBottom = 40;
            } else {
                paddingLeft = 65;
                paddingRight = 65;
                paddingTop = 30;
                paddingBottom = 30;
            }

            const plotStart = paddingLeft;
            const plotEnd = rect.width - paddingRight;
            if (relX < plotStart || relX > plotEnd) {
                handleGraphLeave(canvasId);
                return;
            }

            const fraction = (relX - plotStart) / (plotEnd - plotStart);
            const maxIndex = state.tempHistory.length - 1;
            if (maxIndex < 0) return;

            const index = Math.round(fraction * maxIndex);
            if (isMini) miniHoveredIndex = index;
            else fullHoveredIndex = index;

            const tempValues = state.tempHistory;
            const pressValues = state.pressureHistory;

            const tempMinRaw = Math.min(...tempValues);
            const tempMaxRaw = Math.max(...tempValues);
            const defaultTempRange = isMini ? 10 : 20;
            let tempRange = (tempMaxRaw - tempMinRaw) || defaultTempRange;
            const tempPad = tempRange * 0.05;
            let tempMin = tempMinRaw - tempPad;
            let tempMax = tempMaxRaw + tempPad;

            const pressMinRaw = Math.min(...pressValues);
            const pressMaxRaw = Math.max(...pressValues);
            const defaultPressRange = isMini ? 3 : 5;
            let pressRange = (pressMaxRaw - pressMinRaw) || defaultPressRange;
            const pressPad = pressRange * 0.1;
            let pressMin = pressMinRaw - pressPad;
            if (isMini) pressMin = Math.max(0, pressMin);
            let pressMax = pressMaxRaw + pressPad;

            const plotWidth = rect.width - paddingLeft - paddingRight;
            const plotHeight = rect.height - paddingTop - paddingBottom;

            const x_canvas = paddingLeft + fraction * plotWidth;

            const fractionTemp = (tempValues[index] - tempMin) / (tempMax - tempMin);
            const y_temp_canvas = isMini
                ? rect.height - paddingBottom - fractionTemp * plotHeight
                : paddingTop + (1 - fractionTemp) * plotHeight;

            const fractionPress = (pressValues[index] - pressMin) / (pressMax - pressMin);
            const y_press_canvas = isMini
                ? rect.height - paddingBottom - fractionPress * plotHeight
                : paddingTop + (1 - fractionPress) * plotHeight;

            const container = canvas.parentElement.getBoundingClientRect();

            const pointX = rect.left - container.left + x_canvas;
            const pointYTemp = rect.top - container.top + y_temp_canvas;
            const pointYPress = rect.top - container.top + y_press_canvas;

            const centerY = (pointYTemp + pointYPress) / 2;

            const tempUnit = state.useFahrenheit ? '¬∞F' : '¬∞C';
            const pressureUnit = state.pressureIsBar ? 'bar' : 'psi';
            const pressureConv = state.pressureIsBar ? 1 : 14.5038;
            const pressureDecimals = state.pressureIsBar ? 1 : 0;

            const tempVal = state.useFahrenheit ? cToF(tempValues[index]) : tempValues[index];
            const pressVal = pressValues[index] * pressureConv;
            const timeSec = index;

            const html = `
                <strong>Time: ${timeSec}s</strong><br>
                Temp: ${tempVal.toFixed(1)}${tempUnit}<br>
                Press: ${pressVal.toFixed(pressureDecimals)}${pressureUnit}
            `;

            const tooltip = isMini ? miniTooltip : fullTooltip;
            tooltip.innerHTML = html;

            tooltip.style.left = '-9999px';
            tooltip.style.top = '-9999px';
            tooltip.style.display = 'block';

            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;

            let tooltipX = pointX + 14;
            let tooltipY = centerY - tooltipHeight / 2;

            const containerRect = canvas.parentElement.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;

            if (tooltipX + tooltipWidth > containerWidth - 8) {
                tooltipX = pointX - tooltipWidth - 14;
            }

            tooltipY = Math.max(
                8,
                Math.min(containerHeight - tooltipHeight - 8, tooltipY)
            );

            tooltip.style.left = Math.round(tooltipX) + 'px';
            tooltip.style.top  = Math.round(tooltipY) + 'px';

            if (isMini) drawMiniGraph();
            else drawFullGraph();
        }

        function handleGraphLeave(canvasId) {
            const isMini = canvasId === 'miniGraph';
            if (isMini) {
                miniHoveredIndex = -1;
                miniTooltip.style.display = 'none';
                drawMiniGraph();
            } else {
                fullHoveredIndex = -1;
                fullTooltip.style.display = 'none';
                drawFullGraph();
            }
        }

        function drawMiniGraph() {
            const canvas = document.getElementById('miniGraph');
            if (!canvas) return;

            const ctx = setupHiDPICanvas(canvas);
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);

            if (state.tempHistory.length < 2) {
                ctx.fillStyle = '#888';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const message = state.bleConnected 
                    ? 'Collecting data...' 
                    : 'Connect to view live graph';
                ctx.fillText(message, width / 2, height / 2);
                return;
            }

            const padding = 40;

            let tempMin = Math.min(...state.tempHistory);
            let tempMax = Math.max(...state.tempHistory);
            let tempRange = tempMax - tempMin || 10;
            let tempPad = tempRange * 0.05;
            tempMin -= tempPad;
            tempMax += tempPad;
            tempRange = tempMax - tempMin;

            let pressureMin = Math.min(...state.pressureHistory);
            let pressureMax = Math.max(...state.pressureHistory);
            let pressureRange = pressureMax - pressureMin || 3;
            let pressurePad = pressureRange * 0.1;
            pressureMin = Math.max(0, pressureMin - pressurePad);
            pressureMax += pressurePad;
            pressureRange = pressureMax - pressureMin;

            const tempUnit = state.useFahrenheit ? '¬∞F' : '¬∞C';
            const pressureUnit = state.pressureIsBar ? 'bar' : 'psi';
            const pressureConv = state.pressureIsBar ? 1 : 14.5038;
            const pressureDecimals = state.pressureIsBar ? 1 : 0;

            const dispTempMin = state.useFahrenheit ? cToF(tempMin) : tempMin;
            const dispTempMax = state.useFahrenheit ? cToF(tempMax) : tempMax;
            const dispTempRange = dispTempMax - dispTempMin;

            const dispPressureMin = pressureMin * pressureConv;
            const dispPressureMax = pressureMax * pressureConv;
            const dispPressureRange = dispPressureMax - dispPressureMin;

            ctx.strokeStyle = '#222';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (i / 4) * (height - padding * 2);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            ctx.strokeStyle = '#800';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();

            ctx.strokeStyle = '#008';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(width - padding, padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            ctx.fillStyle = '#f88';
            ctx.font = '10px monospace';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            const miniTicks = 2;
            for (let i = 0; i <= miniTicks; i++) {
                const fraction = i / miniTicks;
                const y = padding + fraction * (height - padding * 2);
                const val = dispTempMax - fraction * dispTempRange;
                ctx.fillText(val.toFixed(1), padding - 8, y);
            }
            ctx.fillText(tempUnit, padding - 8, padding + 10);

            ctx.fillStyle = '#88f';
            ctx.textAlign = 'left';
            for (let i = 0; i <= miniTicks; i++) {
                const fraction = i / miniTicks;
                const y = padding + fraction * (height - padding * 2);
                const val = dispPressureMax - fraction * dispPressureRange;
                ctx.fillText(val.toFixed(pressureDecimals), width - padding + 8, y);
            }
            ctx.fillText(pressureUnit, width - padding + 8, padding + 10);

            const plot = (data, color, minV, rangeV) => {
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                data.forEach((v, i) => {
                    const x = padding + (i / (data.length - 1)) * (width - padding * 2);
                    const fraction = (v - minV) / rangeV;
                    const y = height - padding - fraction * (height - padding * 2);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };

            plot(state.tempHistory, '#f00', tempMin, tempRange);
            plot(state.pressureHistory, '#00f', pressureMin, pressureRange);

            if (miniHoveredIndex >= 0 && miniHoveredIndex < state.tempHistory.length) {
                const index = miniHoveredIndex;
                const x = padding + (index / (state.tempHistory.length - 1)) * (width - padding * 2);

                ctx.strokeStyle = '#aaa';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();
                ctx.setLineDash([]);

                const fractionTemp = (state.tempHistory[index] - tempMin) / tempRange;
                const yTemp = height - padding - fractionTemp * (height - padding * 2);
                ctx.fillStyle = '#f00';
                ctx.beginPath();
                ctx.arc(x, yTemp, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                const fractionPress = (state.pressureHistory[index] - pressureMin) / pressureRange;
                const yPress = height - padding - fractionPress * (height - padding * 2);
                ctx.fillStyle = '#00f';
                ctx.beginPath();
                ctx.arc(x, yPress, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            ctx.fillStyle = '#888';
            ctx.font = '11px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('Time ‚Üí', width / 2, height - 6);
        }

        function drawFullGraph() {
            const canvas = document.getElementById('fullGraph');
            if (!canvas) return;

            const ctx = setupHiDPICanvas(canvas);
            const width = canvas.getBoundingClientRect().width;
            const height = canvas.getBoundingClientRect().height;

            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);

            if (state.tempHistory.length < 2) {
                ctx.fillStyle = '#666';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Collecting temperature data...', width / 2, height / 2);
                return;
            }

            const paddingTop = 30;
            const paddingBottom = 30;
            const paddingLeft = 65;
            const paddingRight = 65;
            const plotWidth = width - paddingLeft - paddingRight;
            const plotHeight = height - paddingTop - paddingBottom;

            let tempMin = Math.min(...state.tempHistory);
            let tempMax = Math.max(...state.tempHistory);
            let tempRange = tempMax - tempMin || 20;
            let tempPad = tempRange * 0.05;
            tempMin -= tempPad;
            tempMax += tempPad;
            tempRange = tempMax - tempMin;

            let pressureMin = Math.min(...state.pressureHistory);
            let pressureMax = Math.max(...state.pressureHistory);
            let pressureRange = pressureMax - pressureMin || 5;
            let pressurePad = pressureRange * 0.1;
            pressureMin = Math.max(0, pressureMin - pressurePad);
            pressureMax += pressurePad;
            pressureRange = pressureMax - pressureMin;

            const tempUnit = state.useFahrenheit ? '¬∞F' : '¬∞C';
            const pressureUnit = state.pressureIsBar ? 'bar' : 'psi';
            const pressureConv = state.pressureIsBar ? 1 : 14.5038;
            const pressureDecimals = state.pressureIsBar ? 1 : 0;

            const dispTempMin = state.useFahrenheit ? cToF(tempMin) : tempMin;
            const dispTempMax = state.useFahrenheit ? cToF(tempMax) : tempMax;
            const dispTempRange = dispTempMax - dispTempMin;

            const dispPressureMin = pressureMin * pressureConv;
            const dispPressureMax = pressureMax * pressureConv;
            const dispPressureRange = dispPressureMax - dispPressureMin;

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let i = 1; i < 5; i++) {
                const y = paddingTop + (i / 5) * plotHeight;
                ctx.beginPath();
                ctx.moveTo(paddingLeft, y);
                ctx.lineTo(width - paddingRight, y);
                ctx.stroke();

                const x = paddingLeft + (i / 5) * plotWidth;
                ctx.beginPath();
                ctx.moveTo(x, paddingTop);
                ctx.lineTo(x, height - paddingBottom);
                ctx.stroke();
            }

            ctx.strokeStyle = '#666';
            ctx.lineWidth = 2;
            ctx.strokeRect(paddingLeft, paddingTop, plotWidth, plotHeight);

            ctx.strokeStyle = '#800';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(paddingLeft, paddingTop);
            ctx.lineTo(paddingLeft, height - paddingBottom);
            ctx.stroke();

            ctx.strokeStyle = '#008';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(width - paddingRight, paddingTop);
            ctx.lineTo(width - paddingRight, height - paddingBottom);
            ctx.stroke();

            ctx.fillStyle = '#f88';
            ctx.font = '14px monospace';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            const fullTicks = 4;
            for (let i = 0; i <= fullTicks; i++) {
                const fraction = i / fullTicks;
                const y = paddingTop + fraction * plotHeight;
                const val = dispTempMax - fraction * dispTempRange;
                ctx.fillText(val.toFixed(1), paddingLeft - 10, y);
            }
            ctx.fillText(tempUnit, paddingLeft - 10, paddingTop + 15);

            ctx.fillStyle = '#88f';
            ctx.textAlign = 'left';
            for (let i = 0; i <= fullTicks; i++) {
                const fraction = i / fullTicks;
                const y = paddingTop + fraction * plotHeight;
                const val = dispPressureMax - fraction * dispPressureRange;
                ctx.fillText(val.toFixed(pressureDecimals), width - paddingRight + 10, y);
            }
            ctx.fillText(pressureUnit, width - paddingRight + 10, paddingTop + 15);

            const plot = (data, color, minV, rangeV) => {
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                data.forEach((v, i) => {
                    const x = paddingLeft + (i / (data.length - 1)) * plotWidth;
                    const fraction = (v - minV) / rangeV;
                    const y = paddingTop + (1 - fraction) * plotHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };

            plot(state.tempHistory, '#f00', tempMin, tempRange);
            plot(state.pressureHistory, '#00f', pressureMin, pressureRange);

            if (fullHoveredIndex >= 0 && fullHoveredIndex < state.tempHistory.length) {
                const index = fullHoveredIndex;
                const x = paddingLeft + (index / (state.tempHistory.length - 1)) * plotWidth;

                ctx.strokeStyle = '#aaa';
                ctx.lineWidth = 1;
                ctx.setLineDash([6, 6]);
                ctx.beginPath();
                ctx.moveTo(x, paddingTop);
                ctx.lineTo(x, height - paddingBottom);
                ctx.stroke();
                ctx.setLineDash([]);

                const fractionTemp = (state.tempHistory[index] - tempMin) / tempRange;
                const yTemp = paddingTop + (1 - fractionTemp) * plotHeight;
                ctx.fillStyle = '#f00';
                ctx.beginPath();
                ctx.arc(x, yTemp, 7, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();

                const fractionPress = (state.pressureHistory[index] - pressureMin) / pressureRange;
                const yPress = paddingTop + (1 - fractionPress) * plotHeight;
                ctx.fillStyle = '#00f';
                ctx.beginPath();
                ctx.arc(x, yPress, 7, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            document.getElementById('sampleCount').textContent = state.tempHistory.length;
        }

        function togglePause() {
            state.dataCollectionPaused = !state.dataCollectionPaused;
            const btn = document.getElementById('pauseBtn');
            btn.textContent = state.dataCollectionPaused ? 'Resume' : 'Pause';
            btn.classList.toggle('btn-danger', state.dataCollectionPaused);
            btn.classList.toggle('btn-success', !state.dataCollectionPaused);
        }

        function saveData() {
            if (state.tempHistory.length === 0) {
                alert('No data to save yet.');
                return;
            }

            const data = {
                tempHistory: state.tempHistory,
                pressureHistory: state.pressureHistory,
                savedAt: new Date().toISOString(),
                note: 'LVR-1 graph data (brew temperature and group pressure)'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lvr1-graph-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearData() {
            if (!confirm('Clear all recorded graph data? This cannot be undone.')) return;

            state.tempHistory = [];
            state.pressureHistory = [];
            lastTemp = null;
            lastPressure = null;
            miniHoveredIndex = -1;
            fullHoveredIndex = -1;
            miniTooltip.style.display = 'none';
            fullTooltip.style.display = 'none';

            drawMiniGraph();
            drawFullGraph();
            document.getElementById('sampleCount').textContent = '0';
        }

        document.getElementById('loadFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = JSON.parse(ev.target.result);

                    if (!Array.isArray(data.tempHistory) || !Array.isArray(data.pressureHistory)) {
                        throw new Error('Invalid format');
                    }

                    const len = Math.min(data.tempHistory.length, data.pressureHistory.length);
                    state.tempHistory = data.tempHistory.slice(-len).map(Number);
                    state.pressureHistory = data.pressureHistory.slice(-len).map(Number);

                    lastTemp = state.tempHistory.length > 0 ? state.tempHistory[state.tempHistory.length - 1] : null;
                    lastPressure = state.pressureHistory.length > 0 ? state.pressureHistory[state.pressureHistory.length - 1] : null;

                    miniHoveredIndex = -1;
                    fullHoveredIndex = -1;
                    miniTooltip.style.display = 'none';
                    fullTooltip.style.display = 'none';

                    drawMiniGraph();
                    drawFullGraph();
                    document.getElementById('sampleCount').textContent = state.tempHistory.length;

                    alert('Data loaded successfully (' + state.tempHistory.length + ' samples).');
                } catch (err) {
                    alert('Failed to load file: ' + err.message);
                }
            };
            reader.readAsText(file);

            e.target.value = '';
        });

        function updatePIDFromInput(input, zone, param) {
            let val = parseFloat(input.value);
            if (isNaN(val) || val < 0) val = 0;

            if (param.includes('Ki')) {
                val = Math.round(val * 100) / 100;
            } else {
                val = Math.round(val * 10) / 10;
            }

            state.pidGains[zone][param] = val;
            input.value = val.toFixed(2);

            sendBLECommand({ type: 'pid', zone: zone, gains: state.pidGains[zone] });
        }

        function adjustPID(zone, param, delta) {
            let newVal = Math.max(0, state.pidGains[zone][param] + delta);

            if (param.includes('Ki')) {
                newVal = Math.round(newVal * 100) / 100;
            } else {
                newVal = Math.round(newVal * 10) / 10;
            }

            state.pidGains[zone][param] = newVal;

            const input = document.getElementById(`${zone}-${param}`);
            if (input) {
                input.value = newVal.toFixed(2);
            }

            sendBLECommand({ type: 'pid', zone: zone, gains: state.pidGains[zone] });
        }

        function renderPIDSettings() {
            const container = document.getElementById('pidZones');
            container.innerHTML = '';

            ['brew', 'steam', 'group'].forEach(zone => {
                const div = document.createElement('div');
                div.className = 'pid-zone';

                let html = `
                    <h3>${zone.charAt(0).toUpperCase() + zone.slice(1)} Boiler</h3>
                    <div class="pid-grid">
                        <div class="pid-column">
                            <h4 class="aggressive">Aggressive</h4>
                            <div class="pid-row">
                                <span>Kp:</span>
                                <button class="btn btn-danger btn-pid" onclick="adjustPID('${zone}', 'aggKp', -0.1)">‚àí</button>
                                <input type="number" class="pid-input" id="${zone}-aggKp" 
                                       value="${state.pidGains[zone].aggKp.toFixed(2)}" 
                                       step="0.1" min="0"
                                       onchange="updatePIDFromInput(this, '${zone}', 'aggKp')">
                                <button class="btn btn-success btn-pid" onclick="adjustPID('${zone}', 'aggKp', 0.1)">+</button>
                            </div>
                            <div class="pid-row">
                                <span>Ki:</span>
                                <button class="btn btn-danger btn-pid" onclick="adjustPID('${zone}', 'aggKi', -0.01)">‚àí</button>
                                <input type="number" class="pid-input" id="${zone}-aggKi" 
                                       value="${state.pidGains[zone].aggKi.toFixed(2)}" 
                                       step="0.01" min="0"
                                       onchange="updatePIDFromInput(this, '${zone}', 'aggKi')">
                                <button class="btn btn-success btn-pid" onclick="adjustPID('${zone}', 'aggKi', 0.01)">+</button>
                            </div>
                            <div class="pid-row">
                                <span>Kd:</span>
                                <button class="btn btn-danger btn-pid" onclick="adjustPID('${zone}', 'aggKd', -0.1)">‚àí</button>
                                <input type="number" class="pid-input" id="${zone}-aggKd" 
                                       value="${state.pidGains[zone].aggKd.toFixed(2)}" 
                                       step="0.1" min="0"
                                       onchange="updatePIDFromInput(this, '${zone}', 'aggKd')">
                                <button class="btn btn-success btn-pid" onclick="adjustPID('${zone}', 'aggKd', 0.1)">+</button>
                            </div>
                        </div>
                        <div class="pid-column">
                            <h4 class="conservative">Conservative</h4>
                            <div class="pid-row">
                                <span>Kp:</span>
                                <button class="btn btn-danger btn-pid" onclick="adjustPID('${zone}', 'consKp', -0.1)">‚àí</button>
                                <input type="number" class="pid-input" id="${zone}-consKp" 
                                       value="${state.pidGains[zone].consKp.toFixed(2)}" 
                                       step="0.1" min="0"
                                       onchange="updatePIDFromInput(this, '${zone}', 'consKp')">
                                <button class="btn btn-success btn-pid" onclick="adjustPID('${zone}', 'consKp', 0.1)">+</button>
                            </div>
                            <div class="pid-row">
                                <span>Ki:</span>
                                <button class="btn btn-danger btn-pid" onclick="adjustPID('${zone}', 'consKi', -0.01)">‚àí</button>
                                <input type="number" class="pid-input" id="${zone}-consKi" 
                                       value="${state.pidGains[zone].consKi.toFixed(2)}" 
                                       step="0.01" min="0"
                                       onchange="updatePIDFromInput(this, '${zone}', 'consKi')">
                                <button class="btn btn-success btn-pid" onclick="adjustPID('${zone}', 'consKi', 0.01)">+</button>
                            </div>
                            <div class="pid-row">
                                <span>Kd:</span>
                                <button class="btn btn-danger btn-pid" onclick="adjustPID('${zone}', 'consKd', -0.1)">‚àí</button>
                                <input type="number" class="pid-input" id="${zone}-consKd" 
                                       value="${state.pidGains[zone].consKd.toFixed(2)}" 
                                       step="0.1" min="0"
                                       onchange="updatePIDFromInput(this, '${zone}', 'consKd')">
                                <button class="btn btn-success btn-pid" onclick="adjustPID('${zone}', 'consKd', 0.1)">+</button>
                            </div>
                        </div>
                    </div>
                `;

                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function resetAllPID() {
            if (!confirm("Are you sure you want to reset ALL PID gains to factory defaults?\n\nThis will overwrite the current settings on the webpage and (if connected) on the device.\n\nThis action cannot be undone.")) {
                return;
            }

            const defaults = {
                consKp: 1.00,
                consKi: 0.05,
                consKd: 0.25,
                aggKp: 4.00,
                aggKi: 0.20,
                aggKd: 1.00
            };

            ['brew', 'steam', 'group'].forEach(zone => {
                state.pidGains[zone] = { ...defaults };

                if (state.bleConnected) {
                    sendBLECommand({
                        type: 'pid',
                        zone: zone,
                        gains: state.pidGains[zone]
                    });
                }
            });

            renderPIDSettings();
        }

        function setupGraphObservers() {
            const miniContainer = document.querySelector('.graph-container.nav-graph');
            if (miniContainer) {
                new ResizeObserver(() => {
                    drawMiniGraph();
                }).observe(miniContainer);
            }

            const fullContainer = document.querySelector('.graph-container.full-graph');
            if (fullContainer) {
                new ResizeObserver(() => {
                    drawFullGraph();
                }).observe(fullContainer);
            }
        }

        const miniCanvas = document.getElementById('miniGraph');
        const fullCanvas = document.getElementById('fullGraph');

        miniCanvas.addEventListener('mousemove', (e) => handleGraphHover(e, 'miniGraph'));
        miniCanvas.addEventListener('touchmove', (e) => handleGraphHover(e, 'miniGraph'), { passive: false });
        miniCanvas.addEventListener('mouseleave', () => handleGraphLeave('miniGraph'));
        miniCanvas.addEventListener('touchend', () => handleGraphLeave('miniGraph'));
        miniCanvas.addEventListener('touchcancel', () => handleGraphLeave('miniGraph'));

        fullCanvas.addEventListener('mousemove', (e) => handleGraphHover(e, 'fullGraph'));
        fullCanvas.addEventListener('touchmove', (e) => handleGraphHover(e, 'fullGraph'), { passive: false });
        fullCanvas.addEventListener('mouseleave', () => handleGraphLeave('fullGraph'));
        fullCanvas.addEventListener('touchend', () => handleGraphLeave('fullGraph'));
        fullCanvas.addEventListener('touchcancel', () => handleGraphLeave('fullGraph'));

        setupGraphObservers();

        window.addEventListener('load', () => {
            drawMiniGraph();
            updateDisplay();
        });

        document.getElementById('tempUnitBtn').textContent = state.useFahrenheit ? '¬∞F' : '¬∞C';
        document.getElementById('pressureUnitBtn').textContent = state.pressureIsBar ? 'bar' : 'psi';

        updateDisplay();
        updateBLEUI();
        drawMiniGraph();
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js')
              .then(function(registration) {
                console.log('Service Worker registered with scope:', registration.scope);
              })
              .catch(function(error) {
                console.log('Service Worker registration failed:', error);
              });
          });
        }

        function updateUnitButtons() {
    const tempBtn = document.getElementById('tempUnitBtn');
    const pressureBtn = document.getElementById('pressureUnitBtn');

    if (tempBtn) {
        tempBtn.textContent = state.useFahrenheit ? '¬∞F' : '¬∞C';
    }

    if (pressureBtn) {
        pressureBtn.textContent = state.pressureIsBar ? 'bar' : 'psi';
    }
}


    </script>

</body>
</html>