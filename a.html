<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SirusPTB</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #121212;
    color: #e0e0e0;
    font-family: 'Inter', sans-serif;
  }
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  header {
    padding: 16px;
    font-size: 20px;
    font-weight: 600;
    text-align: center;
    background: #1e1e1e;
    width: 100%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.6);
    flex: 0 0 auto;
  }
  .controls-top, .controls-bottom {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    width: 95%;
    max-width: 600px;
    box-sizing: border-box;
    flex: 0 0 auto;
  }
  button {
    padding: 12px 18px;
    font-size: 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: #fff;
    transition: background 0.2s;
    flex: 1 1 100px;
  }
  button:hover { background: #555; }

  /* Button colors */
  #connect { background: #4caf50; }
  #pauseResume { background: #4caf50; }
  #reset, #toggleView { background: #222; }

  .chart-container {
    width: 80%;
    max-width: 600px;
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-bottom: 10px;
  }

  canvas {
    width: 100% !important;
    height: 100% !important;
    background: #1e1e1e;
    border-radius: 8px;
    box-sizing: border-box;
  }
</style>
</head>
<body>
<header>SirusPTB</header>

<div class="controls-top">
  <button id="connect">Connect</button>
</div>

<div class="chart-container">
  <canvas id="tempChart"></canvas>
  <canvas id="pressureChart"></canvas>
  <canvas id="combinedChart" style="display:none;"></canvas>
</div>

<div class="controls-bottom">
  <button id="pauseResume">Pause</button>
  <button id="toggleView">Toggle View</button>
  <button id="reset">Reset</button>
</div>

<script>
const serviceUuid = "0000ffe1-0000-1000-8000-00805f9b34fb";
const characteristicUuid = "0000ffe3-0000-1000-8000-00805f9b34fb";

let device, server, characteristic;
let isPaused = false;
let tempChart, pressureChart, combinedChart;
let chartData = { labels: [], temp: [], pressure: [] };
let showCombined = false;
const maxPoints = 50; 

const connectBtn = document.getElementById("connect");
const pauseResumeBtn = document.getElementById("pauseResume");
const resetBtn = document.getElementById("reset");
const toggleBtn = document.getElementById("toggleView");

// Plugin to show latest values
const currentValuePlugin = {
  id: "currentValuePlugin",
  afterUpdate(chart) {
    chart.data.datasets.forEach(ds => {
      const latest = ds.data[ds.data.length-1];
      if(latest!==undefined){
        if(ds.yAxisID==="yTemp") ds.label = "Temperature (°C): "+latest.toFixed(2);
        if(ds.yAxisID==="yPressure") ds.label = "Pressure (bar): "+latest.toFixed(2);
      }
    });
  }
};

function createCharts() {
  const ctxTemp = document.getElementById("tempChart").getContext("2d");
  tempChart = new Chart(ctxTemp,{
    type:"line",
    data:{labels:[], datasets:[{ label:"Temperature (°C)", borderColor:"#ff5252", backgroundColor:"rgba(255,82,82,0.2)", data:[], fill:true, tension:0.3, yAxisID:"yTemp" }]},
    options:{ responsive:true, maintainAspectRatio:true, animation:false, plugins:{legend:{labels:{color:"#e0e0e0"}}}, scales:{x:{ticks:{color:"#aaa"}, grid:{color:"#333"}}, y:{ticks:{color:"#aaa"}, grid:{color:"#333"}}} },
    plugins:[currentValuePlugin]
  });

  const ctxPressure = document.getElementById("pressureChart").getContext("2d");
  pressureChart = new Chart(ctxPressure,{
    type:"line",
    data:{labels:[], datasets:[{ label:"Pressure (bar)", borderColor:"#42a5f5", backgroundColor:"rgba(66,165,245,0.2)", data:[], fill:true, tension:0.3, yAxisID:"yPressure" }]},
    options:{ responsive:true, maintainAspectRatio:true, animation:false, plugins:{legend:{labels:{color:"#e0e0e0"}}}, scales:{x:{ticks:{color:"#aaa"}, grid:{color:"#333"}}, y:{ticks:{color:"#aaa"}, grid:{color:"#333"}}} },
    plugins:[currentValuePlugin]
  });

  const ctxCombined = document.getElementById("combinedChart").getContext("2d");
  combinedChart = new Chart(ctxCombined,{
    type:"line",
    data:{ labels:[], datasets:[
      { label:"Temperature (°C)", borderColor:"#ff5252", backgroundColor:"rgba(255,82,82,0.2)", data:[], fill:false, tension:0.3, yAxisID:"yTemp" },
      { label:"Pressure (bar)", borderColor:"#42a5f5", backgroundColor:"rgba(66,165,245,0.2)", data:[], fill:false, tension:0.3, yAxisID:"yPressure" }
    ]},
    options:{ responsive:true, maintainAspectRatio:true, animation:false, plugins:{legend:{labels:{color:"#e0e0e0"}}}, scales:{ x:{ticks:{color:"#aaa"}, grid:{color:"#333"}, min:0, max:maxPoints-1}, yTemp:{type:"linear", position:"left", ticks:{color:"#ff5252"}, grid:{color:"#333"}}, yPressure:{type:"linear", position:"right", ticks:{color:"#42a5f5"}, grid:{drawOnChartArea:false}} } },
    plugins:[currentValuePlugin]
  });
}

async function connectBLE() {
  if(device && device.gatt.connected){
    device.gatt.disconnect();
    connectBtn.textContent="Connect";
    connectBtn.style.background="#4caf50";
    return;
  }
  try{
    device = await navigator.bluetooth.requestDevice({
      filters:[{namePrefix:"SirusPTB"}],
      optionalServices:[serviceUuid]
    });
    connectBtn.textContent="Connecting...";
    connectBtn.style.background="#ff9800";

    server = await device.gatt.connect();
    const service = await server.getPrimaryService(serviceUuid);
    characteristic = await service.getCharacteristic(characteristicUuid);

    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged", handleData);

    connectBtn.textContent="Disconnect";
    connectBtn.style.background="#f44336";
    isPaused=false;

    device.addEventListener("gattserverdisconnected",()=>{
      connectBtn.textContent="Connect";
      connectBtn.style.background="#4caf50";
    });
  }catch(err){
    connectBtn.textContent="Connect";
    connectBtn.style.background="#4caf50";
    console.error(err);
  }
}

function handleData(event){
  if(isPaused) return;
  const value = new TextDecoder().decode(event.target.value);
  const [tempStr, pressureStr] = value.split(",");
  const temp=parseFloat(tempStr);
  const pressure=Math.max(0,parseFloat(pressureStr)/100);
  const timestamp=new Date().toLocaleTimeString();

  chartData.labels.push(timestamp);
  chartData.temp.push(temp);
  chartData.pressure.push(pressure);
  if(chartData.labels.length>maxPoints){
    chartData.labels.shift();
    chartData.temp.shift();
    chartData.pressure.shift();
  }

  tempChart.data.labels = chartData.labels;
  tempChart.data.datasets[0].data = chartData.temp;
  pressureChart.data.labels = chartData.labels;
  pressureChart.data.datasets[0].data = chartData.pressure;
  combinedChart.data.labels = chartData.labels;
  combinedChart.data.datasets[0].data = chartData.temp;
  combinedChart.data.datasets[1].data = chartData.pressure;

  combinedChart.options.scales.yTemp.min=temp-2;
  combinedChart.options.scales.yTemp.max=temp+2;
  combinedChart.options.scales.yPressure.min=Math.max(0,pressure-0.5);
  combinedChart.options.scales.yPressure.max=pressure+0.5;

  if(chartData.labels.length < maxPoints){
    combinedChart.options.scales.x.min=0;
    combinedChart.options.scales.x.max=maxPoints-1;
  } else {
    combinedChart.options.scales.x.min=chartData.labels.length-maxPoints;
    combinedChart.options.scales.x.max=chartData.labels.length-1;
  }

  tempChart.update(); 
  pressureChart.update(); 
  combinedChart.update();
}

// Controls
pauseResumeBtn.onclick = () => {
  isPaused = !isPaused;
  pauseResumeBtn.textContent = isPaused ? "Resume" : "Pause";
  pauseResumeBtn.style.background = isPaused ? "#ff9800" : "#4caf50";
};

resetBtn.onclick=()=>{
  chartData={labels:[], temp:[], pressure:[]};
  [tempChart, pressureChart, combinedChart].forEach(c=>{
    c.data.labels=[]; 
    c.data.datasets.forEach(ds=>ds.data=[]); 
    c.update();
  });
};
connectBtn.onclick=connectBLE;

toggleBtn.onclick=()=>{
  showCombined=!showCombined;
  document.getElementById("tempChart").style.display=showCombined?"none":"block";
  document.getElementById("pressureChart").style.display=showCombined?"none":"block";
  document.getElementById("combinedChart").style.display=showCombined?"block":"none";
  toggleBtn.textContent=showCombined?"Split View":"Combined View";
};

createCharts();
</script>
</body>
</html>
