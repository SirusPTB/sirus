<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SirusPTB</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #121212;
  color: #e0e0e0;
  text-align: center;
}
header {
  padding: 10px;
  font-size: 1.4em;
  font-weight: bold;
}
.canvas-container {
  width: 90%;
  margin: 10px auto;
  height: 300px;
}
canvas {
  width: 100% !important;
  height: 100% !important;
  background: #1e1e1e;
  border-radius: 8px;
}
.button-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin: 10px 0 30px;
}
button {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  cursor: pointer;
  color: white;
  background-color: #333;
}
#connectButton.connecting { background-color: orange; }
#connectButton.connected { background-color: green; }
#connectButton.disconnected { background-color: red; }
#resetButton, #toggleViewButton { background-color: #222; }

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0; top: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7);
  justify-content: center; align-items: center;
}
.modal-content {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  text-align: center;
}
.modal select {
  width: 80%;
  padding: 8px;
  margin: 10px 0;
  border-radius: 6px;
  background: #333;
  color: #fff;
  border: none;
}
.modal button { margin: 5px; }
</style>
</head>
<body>
<header>SirusPTB</header>

<div class="button-row">
  <button id="connectButton" class="disconnected">Connect</button>
</div>

<div id="splitView" style="display:flex; flex-direction:column; width:100%; align-items:center;">
  <div class="canvas-container"><canvas id="tempChart"></canvas></div>
  <div class="canvas-container"><canvas id="pressureChart"></canvas></div>
</div>

<div id="combinedView" style="display:none; width:100%; align-items:center;">
  <div class="canvas-container"><canvas id="combinedChart"></canvas></div>
</div>

<div class="button-row">
  <button id="pauseResumeButton">Pause</button>
  <button id="toggleViewButton">Toggle View</button>
  <button id="resetButton">Reset</button>
</div>

<div class="button-row">
  <button id="saveButton">Save</button>
  <button id="loadButton">Load</button>
  <button id="deleteButton">Delete</button>
</div>

<!-- Modal -->
<div id="popupModal" class="modal">
  <div class="modal-content">
    <h3>Select Saved Graph</h3>
    <select id="modalSelect"></select>
    <div>
      <button id="confirmButton">Confirm</button>
      <button id="cancelButton">Cancel</button>
    </div>
  </div>
</div>

<script>
const serviceUuid = "0000ffe1-0000-1000-8000-00805f9b34fb";
const characteristicUuid = "0000ffe3-0000-1000-8000-00805f9b34fb";

let device, characteristic;
let tempChart, pressureChart, combinedChart;
let paused = false;
let currentTemp = 0, currentPressure = 0;
let splitView = true;
let secondsCounter = 0;
let chartData = { labels: [], temp: [], pressure: [] };
let modalAction = "";

// --- Modal ---
const modal = document.getElementById("popupModal");
const modalSelect = document.getElementById("modalSelect");
const confirmButton = document.getElementById("confirmButton");
const cancelButton = document.getElementById("cancelButton");

function showModal(action){
  modalAction = action;
  modalSelect.innerHTML="";
  const saved = Object.keys(localStorage).filter(k=>k.startsWith("graph_"));
  if(saved.length===0){ alert("No saved graphs"); return; }
  saved.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k; opt.text = k.replace("graph_","");
    modalSelect.add(opt);
  });
  modal.style.display="flex";
}

confirmButton.onclick = () => {
  const key = modalSelect.value;
  if(!key){ modal.style.display="none"; return; }
  if(modalAction==="load"){
    const data = JSON.parse(localStorage.getItem(key));
    if(data){
      chartData = data; secondsCounter=data.labels.length;
      [tempChart,pressureChart,combinedChart].forEach(chart=>{
        chart.data.labels=chartData.labels;
        chart.data.datasets.forEach((ds,i)=>{
          ds.data=i===0?chartData.temp:chartData.pressure;
        });
        chart.update();
      });
    }
  } else if(modalAction==="delete"){
    localStorage.removeItem(key);
  }
  modal.style.display="none";
};

cancelButton.onclick = () => { modal.style.display="none"; };

// --- Charts ---
function fixCanvasDPI(canvas) {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

// Plugin to display current value next to label
const currentValuePlugin = {
  id:'currentValue',
  afterDraw(chart){
    if(chart.data.datasets.length===0) return;
    const ctx = chart.ctx;
    chart.data.datasets.forEach((ds,i)=>{
      if(ds.data.length===0) return;
      const latest = ds.data[ds.data.length-1];
      const x = chart.chartArea.left + 5;
      ctx.save();
      ctx.fillStyle = ds.borderColor;
      ctx.font = "bold 14px Arial";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText(ds.label + ": " + latest.toFixed(2) + (ds.label.includes("Temp")?"Â°C":" bar"), x, 5 + i*18);
      ctx.restore();
    });
  }
};

function initCharts(){
  const ctxTemp = document.getElementById("tempChart").getContext("2d");
  fixCanvasDPI(ctxTemp.canvas);
  tempChart = new Chart(ctxTemp,{
    type:"line",
    data:{labels:[],datasets:[{label:"Temp",borderColor:"#ff7f7f",data:[],fill:false}]},
    options:{responsive:true,maintainAspectRatio:true,animation:false,
      plugins:{legend:{labels:{color:"#e0e0e0"}}},
      scales:{x:{ticks:{display:false}},y:{ticks:{color:"#ff7f7f"}}}
    },
    plugins:[currentValuePlugin]
  });

  const ctxPressure = document.getElementById("pressureChart").getContext("2d");
  fixCanvasDPI(ctxPressure.canvas);
  pressureChart = new Chart(ctxPressure,{
    type:"line",
    data:{labels:[],datasets:[{label:"Pressure",borderColor:"#7fbfff",data:[],fill:false}]},
    options:{responsive:true,maintainAspectRatio:true,animation:false,
      plugins:{legend:{labels:{color:"#e0e0e0"}}},
      scales:{x:{ticks:{display:false}},y:{ticks:{color:"#7fbfff"}}}
    },
    plugins:[currentValuePlugin]
  });

  const ctxCombined = document.getElementById("combinedChart").getContext("2d");
  fixCanvasDPI(ctxCombined.canvas);
  combinedChart = new Chart(ctxCombined,{
    type:"line",
    data:{labels:[],datasets:[
      {label:"Temp",borderColor:"#ff7f7f",data:[],fill:false,yAxisID:"y1"},
      {label:"Pressure",borderColor:"#7fbfff",data:[],fill:false,yAxisID:"y2"}
    ]},
    options:{responsive:true,maintainAspectRatio:true,animation:false,
      plugins:{legend:{labels:{color:"#e0e0e0"}}},
      scales:{x:{ticks:{display:false}},y1:{ticks:{color:"#ff7f7f"}},y2:{ticks:{color:"#7fbfff"}}}
    },
    plugins:[currentValuePlugin]
  });
}

initCharts();

// --- BLE ---
async function connect(){
  const btn=document.getElementById("connectButton");
  try{
    btn.textContent="Connecting..."; btn.className="connecting";
    device=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"SirusPTB"}],optionalServices:[serviceUuid]});
    const server=await device.gatt.connect();
    const service=await server.getPrimaryService(serviceUuid);
    characteristic=await service.getCharacteristic(characteristicUuid);
    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged",handleData);

    btn.textContent="Disconnect"; btn.className="connected";
    btn.onclick=disconnect;

    // Listen for disconnect
    device.addEventListener("gattserverdisconnected",()=>{
      btn.textContent="Connect";
      btn.className="disconnected";
      btn.onclick=connect;
    });

  } catch(e){ console.error(e); btn.textContent="Connect"; btn.className="disconnected"; }
}

async function disconnect(){
  if(device && device.gatt.connected) await device.gatt.disconnect();
  const btn=document.getElementById("connectButton");
  btn.textContent="Connect"; btn.className="disconnected"; btn.onclick=connect;
}

// --- Data Handling ---
function handleData(event){
  if(paused) return;
  const [tempStr,pressureStr]=new TextDecoder().decode(event.target.value).trim().split(",");
  currentTemp=parseFloat(tempStr);
  currentPressure=Math.max(0,parseFloat(pressureStr));

  const label=secondsCounter++;
  chartData.labels.push(label);
  chartData.temp.push(currentTemp);
  chartData.pressure.push(currentPressure);
  if(chartData.labels.length>50){ chartData.labels.shift(); chartData.temp.shift(); chartData.pressure.shift(); }

  // Update charts
  tempChart.data.labels=chartData.labels; tempChart.data.datasets[0].data=chartData.temp;
  tempChart.options.scales.y.min=currentTemp-2; tempChart.options.scales.y.max=currentTemp+2; tempChart.update();

  pressureChart.data.labels=chartData.labels; pressureChart.data.datasets[0].data=chartData.pressure;
  pressureChart.options.scales.y.min=Math.max(0,currentPressure-0.5); pressureChart.options.scales.y.max=currentPressure+0.5; pressureChart.update();

  combinedChart.data.labels=chartData.labels;
  combinedChart.data.datasets[0].data=chartData.temp;
  combinedChart.data.datasets[1].data=chartData.pressure;
  combinedChart.options.scales.y1.min=currentTemp-2; combinedChart.options.scales.y1.max=currentTemp+2;
  combinedChart.options.scales.y2.min=Math.max(0,currentPressure-0.5); combinedChart.options.scales.y2.max=currentPressure+0.5;
  combinedChart.update();
}

// --- Buttons ---
document.getElementById("connectButton").onclick=connect;
document.getElementById("pauseResumeButton").onclick=()=>{
  paused=!paused;
  document.getElementById("pauseResumeButton").textContent=paused?"Resume":"Pause";
};
document.getElementById("resetButton").onclick=()=>{
  chartData={labels:[],temp:[],pressure:[]}; secondsCounter=0;
  [tempChart,pressureChart,combinedChart].forEach(chart=>{
    chart.data.labels=[];
    chart.data.datasets.forEach(ds=>ds.data=[]);
    chart.update();
  });
};
document.getElementById("toggleViewButton").onclick=()=>{
  splitView=!splitView; localStorage.setItem("viewChoice",splitView?"split":"combined"); updateView();
};
function updateView(){
  document.getElementById("splitView").style.display=splitView?"flex":"none";
  document.getElementById("combinedView").style.display=splitView?"none":"flex";
}
if(localStorage.getItem("viewChoice")==="combined") splitView=false;
updateView();

// --- Save/Load/Delete ---
document.getElementById("saveButton").onclick=()=>{
  const name=prompt("Enter a name for saved graph:"); if(!name) return;
  localStorage.setItem("graph_"+name,JSON.stringify(chartData));
};
document.getElementById("loadButton").onclick=()=>{showModal("load");};
document.getElementById("deleteButton").onclick=()=>{showModal("delete");};

// --- Auto-check BLE connection every second ---
setInterval(()=>{
  const btn=document.getElementById("connectButton");
  if(device){
    if(device.gatt.connected){
      btn.textContent="Disconnect"; btn.className="connected"; btn.onclick=disconnect;
    } else {
      btn.textContent="Connect"; btn.className="disconnected"; btn.onclick=connect;
    }
  }
},1000);
</script>
</body>
</html>
